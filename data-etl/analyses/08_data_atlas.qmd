---
title: "Data Atlas May 2 2025"
author: "Jay Matsushiba"
date: "2025/05/02"
format:
  html:
    code-fold: true
---

# Data Atlas May 2 2025

This document contains the code for generating the figures contained in
the Data Atlas, using the May 2nd 2025 version of inputs and outputs.

These include the following figures:

1.  General Map
2.  Species
    1.  Bird Species Richness
    2.  Small Mammal Species Richness
    3.  Amphibian / Reptile Species Richness
    4.  Threatened Species Richness
    5.  All Species Richness
    6.  Summed Species Distribution Models
3.  Habitats
    1.  Freshwater Map
    2.  Forest Types Map
    3.  Other Vegetation Maps
    4.  Habitat Richness
4.  Derived Data Products
    1.  Combined Biodiversity Values (0-1)
    2.  Top 30% Biodiversity Values (0-1)
    3.  Combined Biodiversity Values (0-1) overlap with Protected Areas
    4.  Top 30% overlap with Protected Areas (% protected)
    5.  Combined Biodiversity Values (0-1) overlap with Private Land
    6.  Top 30% overlap with Private land (% private)
    7.  Human disturbance (categorical)
    8.  Human disturbance (continuous)
    9.  Top 30% overlap with Human disturbance (% in each of 3
        categories)
    10. Combined Biodiversity Values (0-1) overlap with FWater habitats
    11. Top 30% overlap with FWater habitats (% overlap with FW)

```{r setup, output=F}
#### Palen Lab Packages ####
library(bowen.biodiversity.webapp)

#### Other Packages ####
library(here)
library(dplyr)
library(stringr)
library(foreach)
library(sf)
library(terra)
library(tidyterra)
library(readxl)
library(googlesheets4)
library(ggplot2)
library(ggnewscale)
library(RColorBrewer)
library(randomcoloR)
library(doParallel)
library(magrittr)

sf_use_s2(FALSE)

sdm_url <- "https://docs.google.com/spreadsheets/d/1IGFwkr9LidcZwbzOJJGSEXLsmpKp0a9gBs65EY-H1xw/edit?usp=sharing"
habitats_url <- "https://docs.google.com/spreadsheets/d/1yDKw4r3tbXYivwtxbbfxc-pYSbtbj_o2ee1pwlNCOO4/edit?usp=drive_link"
output_dir <- here("vignettes/figures/data_atlas_07_05_2025")
if(!dir.exists(output_dir)) {
  dir.create(output_dir)
}
sheet_date <- "2025-06-30"

#### CREATE DATAFRAME FOR INPUT LAYERS ####
# Read from Google Sheets
habitats_df <- read_sheet(habitats_url, sheet = sheet_date)
habitats_df$weight <- habitats_df$weight / nrow(habitats_df)
sdm_df <- read_sheet(sdm_url, sheet = sheet_date) 
sdm_df$weight <- sdm_df$weight / nrow(sdm_df)
# Bind all input layers together
layers_df <- sdm_df %>%
  select(colnames(habitats_df)) %>% # Select common columns
  bind_rows(habitats_df) %>%
  filter(weight > 0)

# Plots parameters
trails_colour <- "brown"
roads_colour <- "darkgrey"
caption <- paste0("Map created: ", date(), ". Palen Lab. Created by Jay Matsushiba (jmatsush@sfu.ca)")

# Template raster
bowen_mask <- terra::rast(here("inst/extdata/bowen_mask.tif"))
empty_rast <- terra::rast(
  ext(bowen_mask),
  resolution = res(bowen_mask),
  crs = crs(bowen_mask)
)

# Shoreline 
bowen_shoreline <- st_read(here("data-raw/bowen_island_shoreline_w_hutt.gpkg"), layer = "bowen_island_shoreline_w_hutt__bowen_islands") %>%
  st_transform(project_crs)

bowen_mask_sf <- as.polygons(bowen_mask, extent=T) %>%
  st_as_sf() %>%
  st_transform(project_crs) %>%
  st_buffer(1000)

# Create Ocean Polygon
bowen_ocean_sf <- st_difference(st_union(bowen_mask_sf), st_union(bowen_shoreline))
bowen_ocean_linewidth <- 0.5
bowen_ocean_colour <- "#dbdbdc"
```

# 1 Overview

## 1.1 Basic Map of Bowen Island

```{r basic}
# Plot
bowen_plot <- bowen_map(raster_layer = empty_rast,
                        title = "Transportation Network, Bowen Island",
                        subtitle = "Base Bowen Island map with hillshade, roads, and trails.",
                        caption = caption,
                        legend_label = "Priority") +
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(data = bowen_trails,
                   linewidth = 0.3,
                   aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(data = bowen_roads,
                   linewidth = 0.5,
                   aes(color = roads_colour)
  ) +
  scale_colour_identity(name = "",
                        breaks = c(trails_colour, roads_colour),
                        labels = c("Trails", "Roads"),
                        guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )
# Save plot
ggplot2::ggsave(
  paste0(output_dir, "/", Sys.Date(), "_1_1_bowen_map.png"),
  bowen_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

# 2 Species

```{r}
presence_threshold <- 0.7
```

## 2.1 Bird Species Richness

```{r}
# Create species richness plots: 
## Each species is marked present in a cell, if they are above a certain 
## threshold of probability in the input SDMs. 

# Create SDM stack from paths
SDM_stack <- sdm_df[sdm_df$category == "Bird" , "path"] %>%
  lapply(rast) %>%
  rast()
# Create species richness SDM 
bird_richness <- sdm_to_species_richness(SDM_stack = SDM_stack,
                                          presence_threshold = presence_threshold)
writeRaster(bird_richness, here("inst/extdata/2_species/birds_richness.tif"), overwrite = T)

title <- "Bird Species Richness"
subtitle <- paste0("Based on >", 
                   presence_threshold,
                   " probability of occurrence in Species Distribution Models.")

bird_richness_plot <- bowen_map(raster_layer = bird_richness,
                                     title = title,
                                     subtitle = subtitle,
                                     caption = caption,
                                     legend_label = "Richness") +
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(data = bowen_trails,
                   linewidth = 0.3,
                   aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(data = bowen_roads,
                   linewidth = 0.5,
                   aes(color = roads_colour)
  ) +
  scale_colour_identity(name = "",
                        breaks = c(trails_colour, roads_colour),
                        labels = c("Trails", "Roads"),
                        guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

ggplot2::ggsave(
  here(output_dir, "/", paste0(Sys.Date(), "_2_1_bird_species_richness_map.png")),
  bird_richness_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

## 2.2 Small Mammal Species Richness

```{r}
# List SDMs filepaths
SDM_filepaths <- sdm_df[sdm_df$category == "MammalSmall" , "path"]
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create species richness SDM 
mammalsmall_richness <- sdm_to_species_richness(SDM_stack = SDM_stack,
                                          presence_threshold = presence_threshold)
writeRaster(mammalsmall_richness, here("inst/extdata/2_species/sm_mammals_richness.tif"), overwrite = T)

# Create species richness plots: 
## Each species is marked present in a cell, if they are above a certain 
## threshold of probability in the input SDMs. 
title <- "Small Mammal Species Richness"
subtitle <- paste0("Based on >", 
                   presence_threshold,
                   " probability of occurrence in Species Distribution Models.")

mammalsmall_richness_plot <- bowen_map(raster_layer = mammalsmall_richness,
                                     title = title,
                                     subtitle = subtitle,
                                     caption = caption,
                                     legend_label = "Richness") +
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(data = bowen_trails,
                   linewidth = 0.3,
                   aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(data = bowen_roads,
                   linewidth = 0.5,
                   aes(color = roads_colour)
  ) +
  scale_colour_identity(name = "",
                        breaks = c(trails_colour, roads_colour),
                        labels = c("Trails", "Roads"),
                        guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

ggplot2::ggsave(
  here(output_dir, "/", paste0(Sys.Date(), "_2_2_small_mammal_species_richness_map.png")),
  mammalsmall_richness_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

## 2.3 Amphibian & Reptile Species Richness

```{r}
# List SDMs filepaths
SDM_filepaths <- sdm_df[sdm_df$category %in% c("Amphibian", "Reptile"), "path"]
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create species richness SDM 
herptile_richness <- sdm_to_species_richness(SDM_stack = SDM_stack,
                                          presence_threshold = presence_threshold)
writeRaster(herptile_richness, here("inst/extdata/2_species/herptiles_richness.tif"), overwrite = T)

# Create species richness plots: 
## Each species is marked present in a cell, if they are above a certain 
## threshold of probability in the input SDMs. 
title <- "Amphibian & Reptile Species Richness"
subtitle <- paste0("Based on >", 
                   presence_threshold,
                   " probability of occurrence in Species Distribution Models.")

herptile_richness_plot <- bowen_map(raster_layer = herptile_richness,
                                     title = title,
                                     subtitle = subtitle,
                                     caption = caption,
                                     legend_label = "Richness") +
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(data = bowen_trails,
                   linewidth = 0.3,
                   aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(data = bowen_roads,
                   linewidth = 0.5,
                   aes(color = roads_colour)
  ) +
  scale_colour_identity(name = "",
                        breaks = c(trails_colour, roads_colour),
                        labels = c("Trails", "Roads"),
                        guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

ggplot2::ggsave(
  here(output_dir, "/", paste0(Sys.Date(), "_2_3_amphibian_reptile_species_richness_map.png")),
  herptile_richness_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

## 2.4 Threatened & Endangered Species Richness

```{r}
# List SDMs filepaths
SDM_filepaths <- sdm_df[sdm_df$bc_status %in% c("Red", "Blue"), "path"] 
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create species richness SDM 
thr_richness <- sdm_to_species_richness(SDM_stack = SDM_stack,
                                        presence_threshold = presence_threshold)
writeRaster(thr_richness, here("inst/extdata/2_species/threatened_richness.tif"), overwrite = T)

# Create species richness plots: 
## Each species is marked present in a cell, if they are above a certain 
## threshold of probability in the input SDMs. 
title <- "Threatened & Endangered Species Richness"
subtitle <- paste0("Based on >", 
                   presence_threshold,
                   " probability of occurrence in Species Distribution Models. Species that are listed under the Red or Blue Lists according to the British Columbia Conservation Data Centre are included in this map. There are 24 of these species present on Bowen Island with species distribution models available.")

thr_richness_plot <- bowen_map(raster_layer = thr_richness,
                                     title = title,
                                     subtitle = subtitle,
                                     caption = caption,
                                     legend_label = "Richness") +
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(data = bowen_trails,
                   linewidth = 0.3,
                   aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(data = bowen_roads,
                   linewidth = 0.5,
                   aes(color = roads_colour)
  ) +
  scale_colour_identity(name = "",
                        breaks = c(trails_colour, roads_colour),
                        labels = c("Trails", "Roads"),
                        guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

ggplot2::ggsave(
  here(output_dir, "/", paste0(Sys.Date(), "_2_4_threatened_species_richness_map.png")),
  thr_richness_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

## 2.5 Focal Species Richness

```{r species_richness}
# List SDMs filepaths
SDM_filepaths <- sdm_df[sdm_df$category %in% c("Bird", "MammalSmall", "Amphibian", "Reptile"), "path"] 
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create species richness SDM 
total_richness <- sdm_to_species_richness(SDM_stack = SDM_stack,
                                          presence_threshold = presence_threshold)
writeRaster(total_richness, here("inst/extdata/2_species/total_richness.tif"), overwrite = T)

# Create species richness plots: 
## Each species is marked present in a cell, if they are above a certain 
## threshold of probability in the input SDMs. 
title <- "Total Species Richness"
subtitle <- paste0("Based on >", 
                   presence_threshold,
                   " probability of occurrence in Species Distribution Models.")

total_richness_plot <- bowen_map(raster_layer = total_richness,
                                     title = title,
                                     subtitle = subtitle,
                                     caption = caption,
                                     legend_label = "Richness") +
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(data = bowen_trails,
                   linewidth = 0.3,
                   aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(data = bowen_roads,
                   linewidth = 0.5,
                   aes(color = roads_colour)
  ) +
  scale_colour_identity(name = "",
                        breaks = c(trails_colour, roads_colour),
                        labels = c("Trails", "Roads"),
                        guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 
ggplot2::ggsave(
  here(output_dir, "/", paste0(Sys.Date(), "_2_5_bowen_species_richness_map.png")),
  total_richness_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

## 2.6 Focal Species Distribution Models - Summed SDMs

```{r sdm_stack}
# List SDMs filepaths
SDM_filepaths <- sdm_df[, "path"] 
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create summed SDM
SDM_sum <- SDM_stack %>% sum(na.rm = T)
writeRaster(SDM_sum, here("inst/extdata/2_species/sum_sdms.tif"), overwrite = T)

# Create plot
bowen_plot <- bowen_map(raster_layer = SDM_sum,
                        title = "Total Species Diversity",
                        subtitle = "193 species included in this analysis. The values from each species distribution model (ranging from 0 to 1 as probability of occurrence in the cell) are summed to provide a relative biodiversity layer. Higher values correspond to cells with higher probability of species occurring, and vice versa.",
                        caption = caption,
                        legend_label = "Relative Biodiversity") +
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(data = bowen_trails,
                   linewidth = 0.3,
                   aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(data = bowen_roads,
                   linewidth = 0.5,
                   aes(color = roads_colour)
  ) +
  scale_colour_identity(name = "",
                        breaks = c(trails_colour, roads_colour),
                        labels = c("Trails", "Roads"),
                        guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

# Save plot
ggplot2::ggsave(
  paste0(output_dir, "/", Sys.Date(), "_2_6_bowen_summed_sdm_map.png"),
  bowen_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

# 3 Habitats

## 3.1 ‘Freshwater Habitats: streams, wetlands, riparian corridors’ (use blue colour ramp/categories?)

```{r water}
# Plots
title <- "Freshwater Habitats: streams, wetlands, riparian corridors"
subtitle <- "Freshwater features on Bowen Island, derived from layers provided by Alan Whitehead (2025)."

fw_df <- layers_df[layers_df$category == "Freshwater",]
# Color ramp
fw_df$colour <- RColorBrewer::brewer.pal(nrow(fw_df), "YlGnBu")

streams_rast <- fw_df[fw_df$name == "Streams", "path"] %>%
  unlist() %>%
  rast() %>% 
  not.na() %>%
  classify(cbind(FALSE, NA))

fw_plot <- bowen_map(raster_layer = empty_rast,
                     title = title,
                     subtitle = subtitle,
                     caption = caption,
                     legend_label = "Presence") +
  tidyterra::geom_spatraster(data = rast(unlist(fw_df[fw_df$name == "Lakes", "path"])),
                             aes(fill = layer)) +
  scale_fill_gradientn(name = "",
                       labels = "Freshwater Lakes",
                       colours = unlist(fw_df[fw_df$name == "Lakes", "colour"]),
                       guide = "legend",
                       na.value = "transparent") +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = rast(unlist(fw_df[fw_df$name == "Ponds", "path"])),
                             aes(fill = layer)) +
  scale_fill_gradientn(name = "",
                       labels = "Freshwater Ponds",
                       colours = unlist(fw_df[fw_df$name == "Ponds", "colour"]),
                       guide = "legend",
                       na.value = "transparent") +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = rast(unlist(fw_df[fw_df$name == "Riparian", "path"])),
                             aes(fill = layer)) +
  scale_fill_gradientn(name = "",
                       labels = "Riparian",
                       colours = unlist(fw_df[fw_df$name == "Riparian", "colour"]),
                       guide = "legend",
                       na.value = "transparent") +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = rast(unlist(fw_df[fw_df$name == "Wetlands", "path"])),
                             aes(fill = layer)) +
  scale_fill_gradientn(name = "",
                       labels = "Wetlands",
                       colours = unlist(fw_df[fw_df$name == "Wetlands", "colour"]),
                       guide = "legend",
                       na.value = "transparent") +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = streams_rast,
                             aes(fill = layer)) +
  scale_fill_gradientn(name = "",
                       labels = "Streams",
                       colours = unlist(fw_df[fw_df$name == "Streams", "colour"]),
                       guide = "legend",
                       na.value = "transparent") +
  ggnewscale::new_scale_fill() +
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggplot2::theme(
    legend.margin = margin(-26,6,6,6),
    legend.key.width = ggplot2::unit(0.5, "cm"),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.spacing.y = ggplot2::unit(0, "lines"),
    legend.key.spacing.x = ggplot2::unit(0, "cm"),
    legend.direction = "vertical",
    legend.box = "vertical",
    legend.box.background = element_rect(fill="white",
                                         colour = "black"),
    legend.box.margin = margin(20, 5, 5, 5),
    legend.position = c(.05, .95),
    legend.justification = c("left", "top"),
    legend.box.just = "left"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

# Save plots
ggplot2::ggsave(
  here(output_dir, "/", paste0(Sys.Date(), "_", "3_1_bowen_water_map", ".png")),
  fw_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)



# Plots
title <- "Freshwater Habitat Richness"
subtitle <- "Freshwater features on Bowen Island, derived from layers provided by Alan Whitehead (2025)."

fw_rast_stack <- layers_df[layers_df$category == "Freshwater", "path"] %>%
  unlist() %>%
  lapply(rast) %>%
  rast() 
fw_richness <- fw_rast_stack %>%
  lapply(not.na) %>%
  lapply(function(x) {classify(x, cbind(FALSE, NA))}) %>%
  rast() %>%
  sum(na.rm = T)
writeRaster(fw_richness, here("inst/extdata/3_habitats/fw_richness.tif"), overwrite = T)

fw_richness_plot <- bowen_map(raster_layer = fw_richness,
                     title = title,
                     subtitle = subtitle,
                     caption = caption,
                     pal = "Mako",
                     legend_label = "Freshwater Habitat Richness") +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

# Save plots
ggplot2::ggsave(
  here(output_dir, "/", paste0(Sys.Date(), "_", "3_1_bowen_water_richness_map", ".png")),
  fw_richness_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

## 3.2 ‘Old and Large Forest: Old forest, Old growth management areas’ (use green colour ramp/categories?)

```{r forests}
# Plots
title <- "Forests: Old forest, Mature forest, Young forest."
subtitle <- "Forest features on Bowen Island, derived from Metro Vancouver Sensitive Ecosystem Inventory (2021). "

# Color Ramp
cols <- RColorBrewer::brewer.pal(4, "YlGn")

# Import Sensitive Ecosystem Inventory layers and define colours
bowen_island_OF <- layers_df[layers_df$name == "OF", "path"] %>%
  unlist() %>%
  rast()
bowen_island_OF_colour <- cols[4]
bowen_island_MF <- layers_df[layers_df$name == "MF", "path"] %>%
  unlist() %>%
  rast()
bowen_island_MF_colour <- cols[3]
bowen_island_YF <- layers_df[layers_df$name == "YF", "path"] %>%
  unlist() %>%
  rast()
bowen_island_YF_colour <- cols[2]
bowen_island_YS <- layers_df[layers_df$name == "YS", "path"] %>%
  unlist() %>%
  rast()
bowen_island_YS_colour <- cols[1]

bowen_plot <- bowen_map(raster_layer = empty_rast,
                        title = title,
                        subtitle = subtitle,
                        caption = caption,
                        legend_label = "Presence") +
  tidyterra::geom_spatraster(data = bowen_island_YS,
                             aes(fill = layer)) +
  scale_fill_gradientn(name = "",
                       labels = "Young Forest (small)",
                       colours = bowen_island_YS_colour,
                       guide = "legend",
                       na.value = "transparent") +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = bowen_island_YF,
                             aes(fill = layer)) +
  scale_fill_gradientn(name = "",
                       labels = "Young Forest (<80 years old)",
                       colours = bowen_island_YF_colour,
                       guide = "legend",
                       na.value = "transparent") +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = bowen_island_MF,
                             aes(fill = layer)) +
  scale_fill_gradientn(name = "",
                       labels = "Mature Forest (80 to 250 years old)",
                       colours = bowen_island_MF_colour,
                       guide = "legend",
                       na.value = "transparent") +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = bowen_island_OF,
                             aes(fill = layer)) +
  scale_fill_gradientn(name = "",
                       labels = "Old Forest (Greater than 250 years old)",
                       colours = bowen_island_OF_colour,
                       guide = "legend",
                       na.value = "transparent") +
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggplot2::theme(
    legend.margin = margin(-26,6,6,6),
    legend.key.width = ggplot2::unit(0.5, "cm"),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.spacing.y = ggplot2::unit(0, "lines"),
    legend.key.spacing.x = ggplot2::unit(0, "cm"),
    legend.direction = "vertical",
    legend.box = "vertical",
    legend.box.background = element_rect(fill="white",
                                         colour = "black"),
    legend.box.margin = margin(20, 5, 5, 5),
    legend.position = c(.05, .95),
    legend.justification = c("left", "top"),
    legend.box.just = "left"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

# Save plots
ggplot2::ggsave(
  here(output_dir, "/", paste0(Sys.Date(), "_", "3_2_bowen_forest_map", ".png")),
  bowen_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

## 3.3 Other Terrestrial Habitats: Terrestrial Ecosystem Mapping

```{r other_veg}
# Plots
subtitle <- "Habitat features on Bowen Island, derived from Terrestrial Ecosystem Mapping (2019). "

# Subset
tem_df <- layers_df[layers_df$source == "TEM",]
tem_df$colour <- distinctColorPalette(nrow(tem_df))

for(i in 1:nrow(tem_df)) {
  title <- paste0("Other Terrestrial Habitats: ", unlist(tem_df[i, "name"]))
  
  tem_ind_plot <- bowen_map(raster_layer = empty_rast,
                            title = title,
                            subtitle = subtitle,
                            caption = caption,
                            legend_label = "Presence") +
    ggplot2::theme(
      legend.margin = margin(-26,6,6,6),
      legend.key.width = ggplot2::unit(0.5, "cm"),
      legend.key.height = ggplot2::unit(0.5, "cm"),
      legend.key.spacing.y = ggplot2::unit(0, "lines"),
      legend.key.spacing.x = ggplot2::unit(0, "cm"),
      legend.direction = "vertical",
      legend.box = "vertical",
      legend.box.background = element_rect(fill="white",
                                           colour = "black"),
      legend.box.margin = margin(20, 5, 5, 5),
      legend.position = c(.05, .95),
      legend.justification = c("left", "top"),
      legend.box.just = "left"
    ) +
    tidyterra::geom_spatraster(data = rast(unlist(tem_df[i, "path"])),
                               aes(fill = layer)) +
    scale_fill_gradientn(name = "",
                         labels = unlist(tem_df[i, "name"]),
                         colours = unlist(tem_df[i, "colour"]),
                         guide = "legend",
                         na.value = "transparent"
    ) +
    geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    ) 
  # Save plots
  ggplot2::ggsave(
    here(output_dir, "/", paste0(Sys.Date(), "_", "3_3_bowen_", tools::file_path_sans_ext(unlist(tem_df[i, "filename"])), "_map", ".png")),
    tem_ind_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )
}
```

## 3.4 Intertidal Habitats: Sensitive Ecosystem Inventory

```{r intertidal}
# Subset
intertidal_df <- layers_df[layers_df$category == "Intertidal",]
intertidal_df$colour <- distinctColorPalette(nrow(intertidal_df))

for(i in 1:nrow(intertidal_df)) {
  layer_desc <- unlist(intertidal_df[i, "notes"]) %>%
    strsplit(":")
  title <- paste0("Intertidal Habitats: ", layer_desc$notes[1])
  subtitle <- paste0(stringr::str_to_sentence(unlist(intertidal_df[i, "notes"])), " Habitats on Bowen Island derived from Metro Vancouver Sensitive Ecosystem Inventory (2021).")
  
  tem_ind_plot <- bowen_map(raster_layer = empty_rast,
                            title = title,
                            subtitle = subtitle,
                            caption = caption,
                            legend_label = "Presence") +
    ggplot2::theme(
      legend.margin = margin(-26,6,6,6),
      legend.key.width = ggplot2::unit(0.5, "cm"),
      legend.key.height = ggplot2::unit(0.5, "cm"),
      legend.key.spacing.y = ggplot2::unit(0, "lines"),
      legend.key.spacing.x = ggplot2::unit(0, "cm"),
      legend.direction = "vertical",
      legend.box = "vertical",
      legend.box.background = element_rect(fill="white",
                                           colour = "black"),
      legend.box.margin = margin(20, 5, 5, 5),
      legend.position = c(.05, .95),
      legend.justification = c("left", "top"),
      legend.box.just = "left"
    ) +
    tidyterra::geom_spatraster(data = rast(unlist(intertidal_df[i, "path"])),
                               aes(fill = layer)) +
    scale_fill_gradientn(name = "",
                         labels = unlist(intertidal_df[i, "name"]),
                         colours = unlist(intertidal_df[i, "colour"]),
                         guide = "legend",
                         na.value = "transparent"
    ) + 
    geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    ) 
  
  # Save plots
  ggplot2::ggsave(
    here(output_dir, "/", paste0(Sys.Date(), "_", "3_4_bowen_", tools::file_path_sans_ext(unlist(intertidal_df[i, "filename"])), "_map", ".png")),
    tem_ind_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )
}
```

## 3.5 ‘Habitat Diversity: Number of habitats for each pixel’ All habitat layers combined (# of layers per pixel)

```{r}
# Prepare habitat stack
habitat_stack <- habitats_df %>%
  filter(category != "Human Disturbance") %>%
  select(path) %>%
  lapply(rast) %>% 
  rast()
# Sum habitat stack 
habitat_richness <- habitat_stack %>% sum(na.rm = T)
writeRaster(habitat_richness, here("inst/extdata/3_habitats/total_habitat_richness.tif"), overwrite = T)
# Create species richness plots: 
## Each species is marked present in a cell, if they are above a certain 
## threshold of probability in the input SDMs. 
title <- "Total Habitat Diversity: Number of habitat types by location"
subtitle <- paste0("Total number of habitats found in each cell of the map. Habitats derived from Metro Vancouver Sensitive Ecosystem Inventory (2021), Terrestrial Ecosystem Mapping (2019), and Alan Whitehead (2025).")

habitats_plot <- bowen_map(raster_layer = habitat_richness,
                                     title = title,
                                     subtitle = subtitle,
                                     caption = caption,
                                     legend_label = "Richness") +
  ggplot2::geom_sf(data = bowen_trails,
                   linewidth = 0.3,
                   aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(data = bowen_roads,
                   linewidth = 0.5,
                   aes(color = roads_colour)
  ) +
  scale_colour_identity(name = "",
                        breaks = c(trails_colour, roads_colour),
                        labels = c("Trails", "Roads"),
                        guide = "legend"
  ) + 
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

ggplot2::ggsave(
  here(output_dir, "/", paste0(Sys.Date(), "_", "3_5_bowen_habitat_richness_map", ".png")),
  habitats_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

# 4 Derived Data Products

## 4.1 Biodiversity Values (0-1)

```{r}
rankmap <- here(paste0("inst/extdata/output_zonation/", sheet_date, "/rankmap.tif")) %>% 
  rast() %>% 
  project("EPSG: 3857")

# Plot
combined_biodiversity_plot <- bowen_map(raster_layer = rankmap,
                        title = "Biodiversity Value: Species & Habitats Combined",
                        subtitle = "Zonation5 Prioritization Algorithm of Locations on Bowen Island. Environmental layers (n = 33) and species layers (n = 195).",
                        caption = caption,
                        legend_label = "Priority") +
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(data = bowen_trails,
                   linewidth = 0.3,
                   aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(data = bowen_roads,
                   linewidth = 0.5,
                   aes(color = roads_colour)
  ) +
  scale_colour_identity(name = "",
                        breaks = c(trails_colour, roads_colour),
                        labels = c("Trails", "Roads"),
                        guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

# Save plot
ggplot2::ggsave(
  paste0(output_dir, "/", Sys.Date(), "_","4_1_combined_biodiversity_values.png"),
  combined_biodiversity_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

## 4.2 Human Disturbance (Continuous)

```{r}
# Disturbance raster
disturbed <- here::here("inst", "extdata", "habitats", "bowen_human_footprint.tif") %>%
  terra::rast() %>%
  project(project_crs)

zonation_plot <- bowen_map(disturbed,
                           title = "Current Human Disturbance",
                           subtitle = "Continuous map of human disturbance on Bowen Island.",
                           caption = caption,
                           legend_label = "Disturbance",
                           pal = "Inferno") + 
  geom_sf(data = bowen_ocean_sf,
          linewidth = bowen_ocean_linewidth,
          fill = bowen_ocean_colour
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br", which_north = "true",
    pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  ) 

ggplot2::ggsave(
  paste0(output_dir, "/", Sys.Date(), "_","4_2_humandisturbance_continuous", ".png"),
  zonation_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

## 4.3 Human Disturbance (Categorical)

```{r}
# Human Footprint
disturbed_classified <- here::here("inst/extdata/habitats/bowen_human_footprint_recl.tif") %>%
  terra::rast() %>%
  as.factor()

# Plot
bowen_map_2 <- function(raster_layer,
                      title,
                      subtitle,
                      caption,
                      legend_label) {

  bowen_mask_ext <- raster_layer %>%
    project("EPSG: 3857") %>%
    ext()
  basemap_for_plot <- basemaps::basemap_terra(ext = raster_layer,
                                              map_service = "maptiler",
                                              map_type = "backdrop",
                                              map_token = "baL4WLstSFqSHP2fnYrE")
  
  output_plot <- ggplot2::ggplot() +
    ggplot2::theme_bw() +
    tidyterra::geom_spatraster_rgb(data = basemap_for_plot) +
    tidyterra::geom_spatraster(data = raster_layer) +
    scale_fill_manual(
      name = "Level of Disturbance",
      na.translate = F,
      na.value = NA,
      values = c("1" = "#ffeda0", "2" = "#feb24c", "3" = "#f03b20"),
      labels = c("Low", "Medium", "High"),
    ) +
    ggplot2::scale_x_continuous(expand = c(0,0), limits = c(bowen_mask_ext[1], bowen_mask_ext[2])) +
    ggplot2::scale_y_continuous(expand = c(0,0), limits = c(bowen_mask_ext[3], bowen_mask_ext[4])) +
    ggplot2::labs(
      title = title,
      subtitle = subtitle,
      caption = caption
    ) +
    ggplot2::theme(
      plot.title = ggtext::element_textbox_simple(
        size = 20,
        margin = ggplot2::margin(0, 0, 20, 0)
      ),
      plot.subtitle = ggtext::element_textbox_simple(
        lineheight = 1.5,
        margin= ggplot2::margin(0, 0, 10, 0)
      ),
      axis.text.y = ggplot2::element_text(
        angle = 90, vjust = 1, hjust = 0.5
      ),
      legend.position = "bottom",
      legend.title = ggplot2::element_text(size = 10),
      legend.key.height = ggplot2::unit(0.5, "cm"),
      legend.key.width = ggplot2::unit(1.5, "cm"),
      legend.direction = "horizontal",
      legend.box = "horizontal",
      legend.box.margin = margin(1, 1, 1, 1),
      plot.margin = unit(c(1.3,0.3,0.8,0), "cm")
    ) + 
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    ) 
}

zonation_plot <- bowen_map_2(disturbed_classified,
                           title = "Current Human Disturbance",
                           subtitle = "Categorical map of human disturbance on Bowen Island. Categorization of levels of human disturbance based on values from:   Kristen Hirsh-Pearson, Chris J. Johnson, Richard Schuster, Roger D. Wheate, and Oscar Venter. 2022. Canada’s human footprint reveals large intact areas juxtaposed against areas under immense anthropogenic pressure. FACETS. 7: 398-419.",
                           caption = caption,
                           legend_label = "Disturbance") 

ggplot2::ggsave(
  paste0(output_dir, "/", Sys.Date(), "_","4_3_humandisturbance_categorical", ".png"),
  zonation_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```

# 5 Overlap Statistics

Here we calculate the overlap of the top % of conservation values with
these other layers:

-   Protected areas
-   Private land
-   Human Footprint (HFP)
-   Freshwater habitats
    -   Lakes
    -   Ponds
    -   Streams
    -   Wetlands
    -   Riparian

```{r, warning=F}
# Function for converting Zonation output to boolean based on percentage (in top XX%)
rankmap <- here(paste0("inst/extdata/output_zonation/", sheet_date, "/rankmap.tif")) %>%
  rast() %>% project(project_crs)

#' Only keep top or bottom cell values by quantile 
#'
#' @param x SpatRaster 
#' @param prob Quantile between 0 and 1
#' @param direction "top" or "bottom", for direction of keep / discard cell values
#'
#' @returns SpatRaster
#' @export
remove_by_quantile <- function(x, prob, direction = "top") {
  val <- x %>%
    values() %>%
    quantile(probs = prob, na.rm = T)
  min_val <- x %>%
    values() %>%
    min(na.rm = T)
  max_val <- x %>%
    values() %>%
    max(na.rm = T)
  if(direction == "top") {
    m <- matrix(c(
      min_val, val, NA,
      val, max_val, 1
    ), ncol = 3, byrow = T)
  } else if (direction == "bottom") {
    m <- matrix(c(
      min_val, val, 1,
      val, max_val, NA
    ), ncol = 3, byrow = T)
  }
  mask_quantile <- x %>%
    classify(m,, include.lowest = T) 
  mask_quantile * x
}

#' Rasterize to Bowen Island Mask
bowen_rasterize_cover <- function(sf) {
  bowen_island_mask <- here("inst/extdata/bowen_mask.tif") %>%
    rast() %>%
    project(bowen.biodiversity.webapp::project_crs)

  output <- sf %>%
    terra::vect() %>% # Change to SpatVector for rasterization
    terra::project(bowen.biodiversity.webapp::project_crs) %>% # Reproject to the mask CRS
    terra::rasterize(bowen_island_mask,
                     cover = T, # Return proportion of cell covered by polygon 
                     background = NA) # Rasterize to match mask, set background values to NA
}

#' Provide ratio of overlap between two rasters (in terms of NA vs nonNA)
raster_overlap_ratio <- function(top_rast, area_rast) {
  overlap_res <- (top_rast * area_rast)
  top_cell_count <- top_rast %>% 
    global("sum", na.rm = T)
  overlap_cell_values <- overlap_res %>% 
    values(na.rm = T) 
  overlap_cell_area <-overlap_cell_values %>% sum()
  overlap_ratio <- (overlap_cell_area / top_cell_count) %>% as.numeric()
  return(overlap_ratio)
}

# Bowen entire area
bowen_island <- st_read(here("data-raw/bowen_island_shoreline_w_hutt.gpkg"), layer = "bowen_island_shoreline_w_hutt__bowen_islands")
# Protected Areas from JD
bowen_protectedareas_include <- bowen.biodiversity.webapp::bowen_protectedareas %>%
  filter(type != "Agricultural Land Reserve") # Remove ALR
# Protected Areas from Bowen Island Municipality 
bowen_protectedareas_2 <- st_read(here("data-raw/archive/bowen_island_protectedareas/BM_PROTECTED_AREAS.shp")) %>%
  filter(NAME != "Old Growth Management Area") 
# JD protected areas is more complete, with smaller municipal parks, covenants, and park land exchanges

bowen_protectedareas_rast <- bowen_protectedareas_include %>%
  bowen_rasterize_cover()
union_protectedareas <- bowen.biodiversity.webapp::bowen_protectedareas %>% 
  st_make_valid() %>%
  st_union()

# Check with polygon / polygon area calculations for full Bowen Island
sum(st_area(bowen_protectedareas_include)) / sum(st_area(bowen_island)) # 0.2149664
sum(st_area(bowen_protectedareas_2)) / sum(st_area(bowen_island)) # 0.17935


# Private Land
bowen_mask <- rast(here("inst/extdata/bowen_mask.tif"))
bowen_parcelmap_rast <- bowen.biodiversity.webapp::bowen_parcelmap %>%
  st_cast("MULTIPOLYGON") %>% # Need this due to MULTISURFACE - see: https://gis.stackexchange.com/questions/389814/r-st-centroid-geos-error-unknown-wkb-type-12 
  filter(OwnerType == "Private") %>%
  bowen_rasterize_cover()

bowen_parcelmap_union <- bowen.biodiversity.webapp::bowen_parcelmap %>%
  filter(OwnerType == "Private") %>%
  st_cast("MULTIPOLYGON") %>% # Need this due to MULTISURFACE - see: https://gis.stackexchange.com/questions/389814/r-st-centroid-geos-error-unknown-wkb-type-12 
  st_make_valid() %>%
  st_union()

# Other Land
bowen_mask <- rast(here("inst/extdata/bowen_mask.tif"))
bowen_parcelmap_other_rast <- bowen.biodiversity.webapp::bowen_parcelmap %>%
  st_cast("MULTIPOLYGON") %>%# Need this due to MULTISURFACE - see: https://gis.stackexchange.com/questions/389814/r-st-centroid-geos-error-unknown-wkb-type-12 
  filter(OwnerType != "Private") %>%
  bowen_rasterize_cover()

# Freshwater Habitats 
fw_rast_paths <- c(
  here("inst/extdata/habitats/lakes.tif"),
  here("inst/extdata/habitats/ponds.tif"),
  here("inst/extdata/habitats/riparian.tif"),
  here("inst/extdata/habitats/wetlands.tif"),
  here("inst/extdata/habitats/streams.tif")
)
fw_rast_stack <- lapply(fw_rast_paths, rast) %>%
  rast()
fw_rast_dissolve <- fw_rast_stack %>% 
  sum(na.rm = T) %>%
  not.na() %>%
  classify(cbind(FALSE, NA)) 

# Human Footprint (classified)
bowen_hfp <- here("inst/extdata/habitats/bowen_human_footprint_recl.tif") %>%
  rast() %>%
  as.factor()
bowen_hfp_low <- bowen_hfp %>%
  classify(cbind(3, NA)) %>%
  classify(cbind(2, NA)) %>%
  not.na() %>%
  classify(cbind(FALSE, NA)) 
bowen_hfp_med <- bowen_hfp %>%
  classify(cbind(3, NA)) %>%
  classify(cbind(1, NA)) %>%
  not.na() %>%
  classify(cbind(FALSE, NA)) 
bowen_hfp_high <- bowen_hfp %>%
  classify(cbind(2, NA)) %>%
  classify(cbind(1, NA)) %>%
  not.na() %>%
  classify(cbind(FALSE, NA)) 

sf_use_s2(FALSE)

conservation_val_pal <- "ag_GrnYl"
quants <- seq(from = 0.5, to = 0.9, by = 0.1)
# Top XX%
foreach(quant = quants) %do% {
  rankmap_bt_rm <- rankmap %>%
    remove_by_quantile(quant)
  rankmap_mask <- rankmap_bt_rm %>%
    not.na() %>%
    classify(cbind(FALSE, NA))
  
  top_pct <- (1 - quant) * 100

  # 5.1 Top XX% Biodiversity Values (0-1)
  top_plot <- bowen_map_toppct(rankmap_bt_rm,
                        title = paste0("Top ", top_pct, "% Biodiversity Values"),
                        subtitle = paste0("Top ", top_pct, "% of biodiversity locations on Bowen Island. Zonation5 Prioritization Algorithm of Locations on Bowen Island. Environmental layers (n = 33)  with species layers (n = 195)."),
                        caption = caption,
                        legend_label = "Relative Biodiversity",
                        pal = conservation_val_pal) +
    ggplot2::geom_sf(data = bowen_trails,
                     linewidth = 0.3,
                     aes(color = trails_colour)
    ) +
    ggplot2::geom_sf(data = bowen_roads,
                     linewidth = 0.5,
                     aes(color = roads_colour)
    ) +
    scale_colour_identity(name = "",
                          breaks = c(trails_colour, roads_colour),
                          labels = c("Trails", "Roads"),
                          guide = "legend"
    ) +
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )

  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_1_top_", top_pct,"_biodiversity_values", ".png"),
    top_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )

  # 5.2 Biodiversity Values (0-1) overlap with Protected Areas
  protectedareas_colour <- "purple"
  protectedareas_overlap <- raster_overlap_ratio(rankmap_bt_rm, bowen_protectedareas_rast) %>%
    round(2)
  protectedareas_plot <- bowen_map_toppct(rankmap_bt_rm,
                                   title = paste0("Top ", top_pct, "% Biodiversity Values with Protected Areas" ),
                                   subtitle = paste0("Top ", top_pct, "% of biodiversity locations on Bowen Island, with gradient scale corresponding to relative priority for conservation. Higher values, towards 1.0, indicate higher priority. Lower values, towards 0.0, show lower priority. Protected Areas are visualized as an overlay on top of the Zonation priotization output. The percentage of these biodiversity locations covered by Protected Areas is ", protectedareas_overlap*100, "%."),
                                   caption = caption,
                                   legend_label = "Priority",
                                   pal = conservation_val_pal) +
    geom_sf(data = union_protectedareas,
            aes(fill = protectedareas_colour,
                color = protectedareas_colour),
            alpha = 0.1,
            linewidth = 0.5) +
    scale_fill_identity(name = "",
                        breaks = c(protectedareas_colour),
                        labels = c("Protected Areas"),
                        guide = "legend") +
    scale_colour_identity(name = "",
                          breaks = c(protectedareas_colour),
                          labels = c("Protected Areas"),
                          guide = "legend"
    ) +
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )
  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_2_top_", top_pct, "_protectedareas", ".png"),
    protectedareas_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )

  # 5.3 Biodiversity Values (0-1) overlap with Private Land
  properties_colour <- "brown"
  privatelands_overlap <- raster_overlap_ratio(rankmap_bt_rm, bowen_parcelmap_rast) %>%
    round(2)
  privateland_plot <- bowen_map_toppct(rankmap_bt_rm,
                             title = paste0("Top ", top_pct, "% Biodiversity Value with Private Land"),
                             subtitle = paste0("Top ", top_pct, "% of biodiversity locations on Bowen Island, with gradient scale corresponding to relative priority for conservation. Higher values, towards 1.0, indicate higher priority. Lower values, towards 0.0, show lower priority. Private Lands are visualized as an overlay on top of the Zonation priotization output. The percentage of these biodiversity locations covered by Private Lands is ", privatelands_overlap*100, "%."),
                             caption = caption,
                             legend_label = "Priority",
                             pal = conservation_val_pal) +
    geom_sf(data = bowen_parcelmap_union,
            aes(fill = properties_colour,
                color = properties_colour),
            alpha = 0.2,
            linewidth = 0.5) +
    scale_fill_identity(name = "",
                        breaks = c(properties_colour),
                        labels = c("Private Land"),
                        guide = "legend") +
    scale_colour_identity(name = "",
                          breaks = c(properties_colour),
                          labels = c("Private Land"),
                          guide = "legend"
    ) +
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )

  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_3_top_", top_pct, "_privateland", ".png"),
    privateland_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )
  
  # 5.4 Biodiversity Values overlap with Human Disturbance (categorical) 
  bowen_hfp_top <- max(c(bowen_hfp, rankmap_mask)) %>% 
    as.factor()
  # overlap with each category (low, medium, high)
  hfp_low_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_low) %>%
    round(2)
  hfp_med_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_med) %>%
    round(2)
  hfp_high_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_high) %>%
    round(2)

  bowen_hfp_plot <- bowen_map_2(bowen_hfp_top,
                             title = paste0("Top ", top_pct, "% Biodiversity Value with Human Footprint (Categorical)"),
                             subtitle = paste0("Top ", top_pct, "% of biodiversity locations on Bowen Island, with scale corresponding to relative human disturbance. 0% of top biodiversity locations are considered intact. ", hfp_low_overlap*100,"% of top biodiversity locations considered to be less disturbed. ", hfp_med_overlap*100,"% of top biodiversity cells are considered moderately disturbed. ", hfp_high_overlap*100, "% of top biodiversity locations are highly disturbed. Citation: Kristen Hirsh-Pearson, Chris J. Johnson, Richard Schuster, Roger D. Wheate, and Oscar Venter. 2022. Canada’s human footprint reveals large intact areas juxtaposed against areas under immense anthropogenic pressure. FACETS. 7: 398-419."),
                             caption = caption,
                             legend_label = "Disturbance") +
    ggplot2::geom_sf(data = bowen_trails,
                     linewidth = 0.3,
                     aes(color = trails_colour)
    ) +
    ggplot2::geom_sf(data = bowen_roads,
                     linewidth = 0.5,
                     aes(color = roads_colour)
    ) +
    scale_colour_identity(name = "",
                          breaks = c(trails_colour, roads_colour),
                          labels = c("Trails", "Roads"),
                          guide = "legend"
    ) + 
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    ) 
  
  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_4_top_", top_pct, "_hfp_categorical", ".png"),
    bowen_hfp_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )

  # 5.5 Biodiversity Values overlap with Human Disturbance (continuous)
  bowen_hfp_continuous_top <- rankmap_mask * rast(here("inst/extdata/habitats/bowen_human_footprint.tif"))

  bowen_hfp_continuous_plot <- bowen_map(bowen_hfp_continuous_top,
                             title = paste0("Top ", top_pct, "% Biodiversity Value with Human Footprint (Continuous)"),
                             subtitle = paste0("Top ", top_pct, "% of biodiversity locations on Bowen Island, with scale corresponding to relative human disturbance. 0% of top biodiversity locations are considered intact. ", hfp_low_overlap*100,"% of top biodiversity locations considered to be less disturbed. ", hfp_med_overlap*100,"% of top biodiversity cells are considered moderately disturbed. ", hfp_high_overlap*100, "% of top biodiversity locations are highly disturbed. Citation: Kristen Hirsh-Pearson, Chris J. Johnson, Richard Schuster, Roger D. Wheate, and Oscar Venter. 2022. Canada’s human footprint reveals large intact areas juxtaposed against areas under immense anthropogenic pressure. FACETS. 7: 398-419."),
                             caption = caption,
                             legend_label = "Disturbance",
                             pal = "Inferno") +
    ggplot2::geom_sf(data = bowen_trails,
                     linewidth = 0.3,
                     aes(color = trails_colour)
    ) +
    ggplot2::geom_sf(data = bowen_roads,
                     linewidth = 0.5,
                     aes(color = roads_colour)
    ) +
    scale_colour_identity(name = "",
                          breaks = c(trails_colour, roads_colour),
                          labels = c("Trails", "Roads"),
                          guide = "legend"
    ) +
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )

  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_5_top_", top_pct, "_hfp_continuous", ".png"),
    bowen_hfp_continuous_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )

  # 5.6 Biodiversity Values overlap with Freshwater
  fw_mask <- fw_rast_dissolve %>%
    not.na() %>%
    classify(cbind(FALSE, NA))
  fw_top <- fw_richness * rankmap_mask

  freshwater_overlap = raster_overlap_ratio(rankmap_bt_rm, fw_rast_dissolve) %>%
    round(2)

  fw_plot <- bowen_map_toppct(empty_rast,
                       title = paste0("Top ", top_pct, "% Biodiversity Value with Freshwater Habitats"),
                       subtitle = paste0("Top ", top_pct, "% of biodiversity locations on Bowen Island, overlapping with Freshwater Ecosystems. There is a ", freshwater_overlap*100, "% overlap between top biodiversity locations and freshwater ecosystems."),
                       caption = caption,
                       legend_label = "Freshwater Habitat Richness") +
    ggnewscale::new_scale_fill() +
    tidyterra::geom_spatraster(data = rankmap_mask,
                               aes(fill = rankmap)) +
    scale_fill_gradientn(name = "",
                         labels = paste0("Top ", top_pct, "% Only"),
                         colours = "wheat3",
                         guide = "legend",
                         na.value = "transparent") +
    ggnewscale::new_scale_fill() +
    tidyterra::geom_spatraster(data = fw_top) +
    colorspace::scale_fill_continuous_sequential(
        na.value = NA,
        palette = "Mako",
        guide = ggplot2::guide_colourbar(nbin = 100,
                                         draw.ulim = FALSE,
                                         draw.llim = FALSE,
                                         title.position = "top"
                                         # title.hjust = 0.5
        ),
        name = "Freshwater Habitat Richness"
    ) +
    ggplot2::geom_sf(data = bowen_trails,
                     linewidth = 0.3,
                     aes(color = trails_colour)
    ) +
    ggplot2::geom_sf(data = bowen_roads,
                     linewidth = 0.5,
                     aes(color = roads_colour)
    ) +
    scale_colour_identity(name = "",
                          breaks = c(trails_colour, roads_colour),
                          labels = c("Trails", "Roads"),
                          guide = "legend"
    ) +
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )
  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_6_top_", top_pct, "_fw", ".png"),
    fw_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )
}
```

```{r}
# Bottom XX%
quants <- seq(from = 0.1, to = 0.5, by = 0.1)
foreach(quant = quants) %do% {
  rankmap_bt_rm <- rankmap %>%
    remove_by_quantile(quant, direction = "bottom")
  rankmap_mask <- rankmap_bt_rm %>%
    not.na() %>%
    classify(cbind(FALSE, NA))
  
  bottom_pct <- quant * 100

  # 5.1 bottom XX% Biodiversity Values (0-1)
  bottom_plot <- bowen_map_toppct(rankmap_bt_rm,
                        title = paste0("Bottom ", bottom_pct, "% Biodiversity Values"),
                        subtitle = paste0("Bottom ", bottom_pct, "% of biodiversity locations on Bowen Island. Zonation5 Prioritization Algorithm of Locations on Bowen Island. Environmental layers (n = 33)  with species layers (n = 195)."),
                        caption = caption,
                        legend_label = "Relative Biodiversity",
                        pal = conservation_val_pal) +
    ggplot2::geom_sf(data = bowen_trails,
                     linewidth = 0.3,
                     aes(color = trails_colour)
    ) +
    ggplot2::geom_sf(data = bowen_roads,
                     linewidth = 0.5,
                     aes(color = roads_colour)
    ) +
    scale_colour_identity(name = "",
                          breaks = c(trails_colour, roads_colour),
                          labels = c("Trails", "Roads"),
                          guide = "legend"
    ) +
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )

  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_1_bottom_", bottom_pct,"_biodiversity_values", ".png"),
    bottom_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )

  # 5.2 Biodiversity Values (0-1) overlap with Protected Areas
  protectedareas_colour <- "purple"
  protectedareas_overlap <- raster_overlap_ratio(rankmap_bt_rm, bowen_protectedareas_rast) %>%
    round(2)
  protectedareas_plot <- bowen_map_toppct(rankmap_bt_rm,
                                   title = paste0("Bottom ", bottom_pct, "% Biodiversity Values with Protected Areas" ),
                                   subtitle = paste0("Bottom ", bottom_pct, "% of biodiversity locations on Bowen Island, with gradient scale corresponding to relative priority for conservation. Higher values, towards 1.0, indicate higher priority. Lower values, towards 0.0, show lower priority. Protected Areas are visualized as an overlay on the Zonation priotization output. The percentage of these biodiversity locations covered by Protected Areas is ", protectedareas_overlap*100, "%."),
                                   caption = caption,
                                   legend_label = "Priority",
                                   pal = conservation_val_pal) +
    geom_sf(data = union_protectedareas,
            aes(fill = protectedareas_colour,
                color = protectedareas_colour),
            alpha = 0.1,
            linewidth = 0.5) +
    scale_fill_identity(name = "",
                        breaks = c(protectedareas_colour),
                        labels = c("Protected Areas"),
                        guide = "legend") +
    scale_colour_identity(name = "",
                          breaks = c(protectedareas_colour),
                          labels = c("Protected Areas"),
                          guide = "legend"
    ) +
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )
  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_2_bottom_", bottom_pct, "_protectedareas", ".png"),
    protectedareas_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )

  # 5.3 Biodiversity Values (0-1) overlap with Private Land
  properties_colour <- "brown"
  privatelands_overlap <- raster_overlap_ratio(rankmap_bt_rm, bowen_parcelmap_rast) %>%
    round(2)
  privateland_plot <- bowen_map_toppct(rankmap_bt_rm,
                             title = paste0("Bottom ", bottom_pct, "% Biodiversity Value with Private Land"),
                             subtitle = paste0("Bottom ", bottom_pct, "% of biodiversity locations on Bowen Island, with gradient scale corresponding to relative priority for conservation. Higher values, towards 1.0, indicate higher priority. Lower values, towards 0.0, show lower priority. Private Lands are visualized as an overlay on the Zonation priotization output. The percentage of these biodiversity locations covered by Private Lands is ", privatelands_overlap*100, "%."),
                             caption = caption,
                             legend_label = "Priority",
                             pal = conservation_val_pal) +
    geom_sf(data = bowen_parcelmap_union,
            aes(fill = properties_colour,
                color = properties_colour),
            alpha = 0.2,
            linewidth = 0.5) +
    scale_fill_identity(name = "",
                        breaks = c(properties_colour),
                        labels = c("Private Land"),
                        guide = "legend") +
    scale_colour_identity(name = "",
                          breaks = c(properties_colour),
                          labels = c("Private Land"),
                          guide = "legend"
    ) +
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )

  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_3_bottom_", bottom_pct, "_privateland", ".png"),
    privateland_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )
  
  # 5.4 Biodiversity Values overlap with Human Disturbance (categorical) 
  bowen_hfp_bottom <- max(c(bowen_hfp, rankmap_mask)) %>% 
    as.factor()
  # overlap with each category (low, medium, high)
  hfp_low_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_low) %>%
    round(2)
  hfp_med_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_med) %>%
    round(2)
  hfp_high_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_high) %>%
    round(2)

  bowen_hfp_plot <- bowen_map_2(bowen_hfp_bottom,
                             title = paste0("Bottom ", bottom_pct, "% Biodiversity Value with Human Footprint (Categorical)"),
                             subtitle = paste0("Bottom ", bottom_pct, "% of biodiversity locations on Bowen Island, with scale corresponding to relative human disturbance. 0% of bottom biodiversity locations are considered intact. ", hfp_low_overlap*100,"% of bottom biodiversity locations considered to be less disturbed. ", hfp_med_overlap*100,"% of bottom biodiversity cells are considered moderately disturbed. ", hfp_high_overlap*100, "% of bottom biodiversity locations are highly disturbed. Citation: Kristen Hirsh-Pearson, Chris J. Johnson, Richard Schuster, Roger D. Wheate, and Oscar Venter. 2022. Canada’s human footprint reveals large intact areas juxtaposed against areas under immense anthropogenic pressure. FACETS. 7: 398-419."),
                             caption = caption,
                             legend_label = "Disturbance") +
    ggplot2::geom_sf(data = bowen_trails,
                     linewidth = 0.3,
                     aes(color = trails_colour)
    ) +
    ggplot2::geom_sf(data = bowen_roads,
                     linewidth = 0.5,
                     aes(color = roads_colour)
    ) +
    scale_colour_identity(name = "",
                          breaks = c(trails_colour, roads_colour),
                          labels = c("Trails", "Roads"),
                          guide = "legend"
    ) + 
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    ) 
  
  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_4_bottom_", bottom_pct, "_hfp_categorical", ".png"),
    bowen_hfp_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )

  # 5.5 Biodiversity Values overlap with Human Disturbance (continuous)
  bowen_hfp_continuous_bottom <- rankmap_mask * rast(here("inst/extdata/habitats/bowen_human_footprint.tif"))

  bowen_hfp_continuous_plot <- bowen_map(bowen_hfp_continuous_bottom,
                             title = paste0("Bottom ", bottom_pct, "% Biodiversity Value with Human Footprint (Continuous)"),
                             subtitle = paste0("Bottom ", bottom_pct, "% of biodiversity locations on Bowen Island, with scale corresponding to relative human disturbance. 0% of bottom biodiversity locations are considered intact. ", hfp_low_overlap*100,"% of bottom biodiversity locations considered to be less disturbed. ", hfp_med_overlap*100,"% of bottom biodiversity cells are considered moderately disturbed. ", hfp_high_overlap*100, "% of bottom biodiversity locations are highly disturbed. Citation: Kristen Hirsh-Pearson, Chris J. Johnson, Richard Schuster, Roger D. Wheate, and Oscar Venter. 2022. Canada’s human footprint reveals large intact areas juxtaposed against areas under immense anthropogenic pressure. FACETS. 7: 398-419."),
                             caption = caption,
                             legend_label = "Disturbance",
                             pal = "Inferno") +
    ggplot2::geom_sf(data = bowen_trails,
                     linewidth = 0.3,
                     aes(color = trails_colour)
    ) +
    ggplot2::geom_sf(data = bowen_roads,
                     linewidth = 0.5,
                     aes(color = roads_colour)
    ) +
    scale_colour_identity(name = "",
                          breaks = c(trails_colour, roads_colour),
                          labels = c("Trails", "Roads"),
                          guide = "legend"
    ) +
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )

  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_5_bottom_", bottom_pct, "_hfp_continuous", ".png"),
    bowen_hfp_continuous_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )

  # 5.6 Biodiversity Values overlap with Freshwater
  fw_mask <- fw_rast_dissolve %>%
    not.na() %>%
    classify(cbind(FALSE, NA))
  fw_bottom <- fw_richness * rankmap_mask

  freshwater_overlap = raster_overlap_ratio(rankmap_bt_rm, fw_rast_dissolve) %>%
    round(2)

  fw_plot <- bowen_map_toppct(empty_rast,
                       title = paste0("Bottom ", bottom_pct, "% Biodiversity Value with Freshwater Habitats"),
                       subtitle = paste0("Bottom ", bottom_pct, "% of biodiversity locations on Bowen Island, overlapping with Freshwater Ecosystems. There is a ", freshwater_overlap*100, "% overlap between bottom biodiversity locations and freshwater ecosystems."),
                       caption = caption,
                       legend_label = "Freshwater Habitat Richness") +
    ggnewscale::new_scale_fill() +
    tidyterra::geom_spatraster(data = rankmap_mask,
                               aes(fill = rankmap)) +
    scale_fill_gradientn(name = "",
                         labels = paste0("bottom ", bottom_pct, "% Only"),
                         colours = "wheat3",
                         guide = "legend",
                         na.value = "transparent") +
    ggnewscale::new_scale_fill() +
    tidyterra::geom_spatraster(data = fw_bottom) +
    colorspace::scale_fill_continuous_sequential(
        na.value = NA,
        palette = "Mako",
        guide = ggplot2::guide_colourbar(nbin = 100,
                                         draw.ulim = FALSE,
                                         draw.llim = FALSE,
                                         title.position = "bottom"
                                         # title.hjust = 0.5
        ),
        name = "Freshwater Habitat Richness"
    ) +
    ggplot2::geom_sf(data = bowen_trails,
                     linewidth = 0.3,
                     aes(color = trails_colour)
    ) +
    ggplot2::geom_sf(data = bowen_roads,
                     linewidth = 0.5,
                     aes(color = roads_colour)
    ) +
    scale_colour_identity(name = "",
                          breaks = c(trails_colour, roads_colour),
                          labels = c("Trails", "Roads"),
                          guide = "legend"
    ) +
    geom_sf(data = bowen_ocean_sf,
            linewidth = bowen_ocean_linewidth,
            fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )
  ggplot2::ggsave(
    paste0(output_dir, "/", Sys.Date(), "_","5_6_bottom_", bottom_pct, "_fw", ".png"),
    fw_plot,
    device = ragg::agg_png,
    width = 9, height = 12, units = "in", res = 300
  )
}
```


```{r}

```

