{
  "hash": "f87e1142b7c0a537afb29c6e9f6ed06d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Protected Areas\"\nformat: html\nauthor: \"Jay Matsushiba\"\npublished: July 2 2025\ndate-modified: July 15 2025\n---\n\n\n\n\n# Protected Areas Candidates\nFirst map / filter\n- Public lands (crown, municipal, MV lands)\n- Not in existing protected areas\n\nSecond map / filter\n- Top 30% of conservation values \n- Wetland / water / riparian values\n \nAlgorithms in Zonation and Marxann for identifying these \n- Find cluster\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Current package within which this vignette is included\nlibrary(bowen.biodiversity.webapp)\n# Spatial \nlibrary(sf)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLinking to GEOS 3.11.1, GDAL 3.6.4, PROJ 9.1.1; sf_use_s2() is TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(terra)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nterra 1.8.5\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(tidyterra)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'tidyterra'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:stats':\n\n    filter\n```\n\n\n:::\n\n```{.r .cell-code}\n# Analysis / Plotting\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:terra':\n\n    intersect, union\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(tidyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'tidyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:terra':\n\n    extract\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nhere() starts at /home/jay/Programming_Projects/bowen.biodiversity.webapp\n```\n\n\n:::\n\n```{.r .cell-code}\n# Google Sheets\nlibrary(googlesheets4)\n# Prioritizr and deps\nlibrary(gurobi)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'gurobi' was built under R version 4.5.0\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: slam\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(prioritizr)\n\ncaption <- paste0(\"Map created: \", date(), \". Palen Lab. Created by Jay Matsushiba (jmatsush@sfu.ca)\")\n```\n:::\n\n\n\n\n## Input layers\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsdm_url <- \"https://docs.google.com/spreadsheets/d/1IGFwkr9LidcZwbzOJJGSEXLsmpKp0a9gBs65EY-H1xw/edit?usp=sharing\"\nhabitats_url <- \"https://docs.google.com/spreadsheets/d/1yDKw4r3tbXYivwtxbbfxc-pYSbtbj_o2ee1pwlNCOO4/edit?usp=drive_link\"\noutput_dir <- here(\"vignettes/figures/protected_areas\")\nif(!dir.exists(output_dir)) {\n  dir.create(output_dir)\n}\n\n#### Zonation Raster Layers ####\n# Load Zonation Output / Conservation Values\nzonation <- here(\"inst/extdata/output_zonation/2025-06-30/rankmap.tif\") %>%\n  rast()\n# For assessing freshwater habitat overlap with potential protected areas. \n# Read from Google Sheets\nhabitats_df <- read_sheet(habitats_url, sheet = \"2025-06-30\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nℹ Suitable tokens found in the cache, associated with these emails:\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n• 'hello@jmatsushiba.com'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n• 'jay.matsushiba@gmail.com'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n• 'palenlab@gmail.com'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n  Defaulting to the first email.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n! Using an auto-discovered, cached token.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n  To suppress this message, modify your code or options to clearly consent to\n  the use of a cached token.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n  See gargle's \"Non-interactive auth\" vignette for more details:\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n  <https://gargle.r-lib.org/articles/non-interactive-auth.html>\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nℹ The googlesheets4 package is using a cached token for\n  'hello@jmatsushiba.com'.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n✔ Reading from \"habitats\".\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n✔ Range ''2025-06-30''.\n```\n\n\n:::\n\n```{.r .cell-code}\nhabitats_df$weight <- habitats_df$weight / nrow(habitats_df)\nsdm_df <- read_sheet(sdm_url, sheet = \"2025-06-30\") \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n✔ Reading from \"sdm\".\n✔ Range ''2025-06-30''.\n```\n\n\n:::\n\n```{.r .cell-code}\nsdm_df$weight <- sdm_df$weight / nrow(sdm_df)\n# Bind all input layers together\nlayers_df <- sdm_df %>%\n  select(colnames(habitats_df)) %>% # Select common columns\n  bind_rows(habitats_df) %>%\n  filter(weight > 0)\n\n\n#### Vector Layers ####\nparcels <- bowen.biodiversity.webapp::bowen_parcelmap %>%\n  # filter(!OwnerType %in% c(\"Private\", \"Unclassified\", \"Mixed Ownership\")) %>%\n  filter(PID != 31243550) %>% # Remove ferry route \n  st_transform(st_crs(bowen_protectedareas))\n\nparcels$geom <- parcels$geom %>%\n  st_cast(\"MULTIPOLYGON\") %>%\n  st_make_valid()\n\nbowen_protectedareas_valid <- bowen_protectedareas %>%\n  st_make_valid()\n```\n:::\n\n\n\n\n## Parcels - Potential Protected Areas\n### Public Land Parcels outside of Protected Areas \nThis is the first filter for potential protected area candidates. We need to find public lands parcels that are not in existing protected areas. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Dissolve protected areas into one geometry\ndissolved_protectedareas <- bowen_protectedareas_valid %>%\n  summarise() %>%\n  st_cast() %>%\n  st_buffer(1) # cleans up geometry slivers compared to 0, buffer distance in metres\n# st_difference after \n# doing st_difference without dissolving protected areas into one geometry \nnotprotected_parcels <- st_difference(parcels, dissolved_protectedareas)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: attribute variables are assumed to be spatially constant throughout\nall geometries\n```\n\n\n:::\n\n```{.r .cell-code}\n# filter for public lands \nnotprotected_parcels$OwnerType %>% unique()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Private\"          \"Crown Provincial\" \"Local Government\" \"Mixed Ownership\" \n[5] \"Crown Agency\"     \"Federal\"          \"Unclassified\"    \n```\n\n\n:::\n\n```{.r .cell-code}\n# [1] \"Private\"          \"Crown Provincial\" \"Local Government\" \"Mixed Ownership\"  \"Crown Agency\"     \"Federal\"         \n# [7] \"Unclassified\" \nnotprotected_publiclands <- notprotected_parcels[!notprotected_parcels$OwnerType %in% c(\"Private\", \"Mixed Ownership\", \"Unclassified\"),] \nnotprotected_privatelands <- notprotected_parcels[notprotected_parcels$OwnerType %in% c(\"Private\", \"Mixed Ownership\", \"Unclassified\"),] \n```\n:::\n\n\n\n\n### Plotting Potential Protected Areas from Undeveloped Parcels \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npotential_protected_areas_ggfunc <- function() {\n  protected_colour <- \"#b3e2cd\"\n  notprotected_public_colour <-  \"#fdcdac\"\n  notprotected_private_colour <- \"#cbd5e8\"\n  output <- list(\n    geom_sf(data = bowen_protectedareas_valid, aes(fill = protected_colour)),\n    geom_sf(data = notprotected_publiclands, aes(fill = notprotected_public_colour)),\n    geom_sf(data = notprotected_privatelands, aes(fill = notprotected_private_colour)),\n    scale_fill_identity(name = \"\",\n                          breaks = c(protected_colour, notprotected_public_colour, notprotected_private_colour),\n                          labels = c(\"Protected\", \"Unprotected Public\", \"Unprotected Private\"),\n                          guide = \"legend\"\n    ),\n    ggnewscale::new_scale_fill(),\n    ggnewscale::new_scale_colour()\n  )\n  return(output)\n}\n\ncaption <- paste0(\"Map created: \", date(), \". Palen Lab. Created by Jay Matsushiba (jmatsush@sfu.ca)\")\nprotected_areas_ggplot <- bowen_map_ggplot(\n  potential_protected_areas_ggfunc,\n  title = \"Protected Areas and Parcels on Bowen Island\",\n  subtitle = \"Mapping the Protected Areas and unprotected parcels to identify potential parcels for future protection.\",\n  caption = caption\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `bowen_island_shoreline_w_hutt__bowen_islands' from data source \n  `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/bowen_island_shoreline_w_hutt.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 4001956 ymin: 2020764 xmax: 4013988 ymax: 2028901\nProjected CRS: NAD83 / Statistics Canada Lambert\nLoading basemap 'backdrop' from map service 'maptiler'...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n<SpatRaster> resampled to 501000 cells.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot2::ggsave(\n  here(output_dir, \"/\", paste0(Sys.Date(), \"_protected_areas_parcels.png\")),\n  protected_areas_ggplot,\n  device = ragg::agg_png,\n  width = 9, height = 12, units = \"in\", res = 300\n)\n```\n:::\n\n\n\n### Conservation Values by Unprotected Public Parcel \n- Top 30% of conservation values \n- Wetland / water / riparian values\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### Conservation values summed by parcel ####\n# extract zonation raster values from cells within each parcel\nnotprotected_cons_vals <- notprotected_parcels %>% \n  vect() %>%\n  terra::extract(zonation, ., \n                 sum, \n                 na.rm = TRUE, \n                 weights = TRUE, # sum biodiversity value by approx fraction of cell covered by polygon\n                 bind = TRUE) \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: [extract] transforming vector data to the CRS of the raster\n```\n\n\n:::\n\n```{.r .cell-code}\n#### Top 30% conservation values summed by parcel ####\n# create top 30% zonation raster \nrcl <- matrix(c(\n  0, 1, 1\n), ncol = 3, byrow = T)\nzonation_top_30 <- zonation %>%\n  remove_by_quantile(\n    prob = 0.7\n  ) %>% \n  classify(rcl)\nnames(zonation_top_30) <- \"rankmap_top_30\"\n# extract number of top conservation value cells within each parcel\nnotprotected_cons_1 <- notprotected_cons_vals %>%\n  terra::extract(zonation_top_30, ., \n                 sum, \n                 na.rm = TRUE, \n                 weights = TRUE, # sum biodiversity value by approx fraction of cell covered by polygon\n                 bind = TRUE) \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: [extract] transforming vector data to the CRS of the raster\n```\n\n\n:::\n\n```{.r .cell-code}\n#### Freshwater (wetland, ponds, rivers) ####\n# Get freshwater rasters, same used in zonation and data atlas\nfw_df <- layers_df[layers_df$category == \"Freshwater\",]\nfw_rast_stack <- layers_df[layers_df$category == \"Freshwater\", \"path\"] %>%\n  unlist() %>%\n  lapply(rast) %>%\n  rast() \nfw_rast_stack %>% sources() # see order of paths \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"/home/jay/Programming_Projects/bowen.biodiversity.webapp/inst/extdata/habitats/riparian.tif\"\n[2] \"/home/jay/Programming_Projects/bowen.biodiversity.webapp/inst/extdata/habitats/streams.tif\" \n[3] \"/home/jay/Programming_Projects/bowen.biodiversity.webapp/inst/extdata/habitats/lakes.tif\"   \n[4] \"/home/jay/Programming_Projects/bowen.biodiversity.webapp/inst/extdata/habitats/ponds.tif\"   \n[5] \"/home/jay/Programming_Projects/bowen.biodiversity.webapp/inst/extdata/habitats/wetlands.tif\"\n```\n\n\n:::\n\n```{.r .cell-code}\nnames(fw_rast_stack) <- c(\"riparian\", \"streams\", \"lakes\", \"ponds\", \"wetlands\") # assign names to layers\n# TODO: decide what to do with stream classes, leave them as is?\n# 3 is fish-bearing streams, 2 is tributary to fish-bearing, 1 is non-fishbearing / drainage channel / unclassified \n\nfw_richness <- fw_rast_stack %>%\n  lapply(not.na) %>%\n  lapply(function(x) {classify(x, cbind(FALSE, NA))}) %>%\n  rast() %>%\n  sum(na.rm = T) \nnames(fw_richness) <- \"fw_richness\"\n# summed richness by parcel\nnotprotected_cons_2 <- notprotected_cons_1 %>%\n  terra::extract(fw_richness, ., \n                 sum, \n                 na.rm = TRUE, \n                 weights = TRUE, # sum biodiversity value by approx fraction of cell covered by polygon\n                 bind = TRUE) \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: [extract] transforming vector data to the CRS of the raster\n```\n\n\n:::\n\n```{.r .cell-code}\nnotprotected_cons_2 <- notprotected_cons_2 %>%\n  tidyterra::rename(fw_sum_richness = \"fw_richness\")\n# fw habitat diversity by parcel\nnotprotected_cons_3 <- notprotected_cons_2 %>%\n  terra::extract(fw_rast_stack, ., \n                 max, \n                 na.rm = TRUE,\n                 bind = TRUE) \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: [extract] transforming vector data to the CRS of the raster\n```\n\n\n:::\n\n```{.r .cell-code}\n#### Convert to sf for better data.frame utilities ####\nnotprotected_cons_vals_sf <- notprotected_cons_3 %>%\n  st_as_sf() %>%\n  tidyr::replace_na(list( # Replace NAs with 0 in freshwater columns\n    riparian = 0, \n    streams = 0, \n    lakes = 0, \n    ponds = 0, \n    wetlands = 0\n  )) %>% \n  mutate(fw_num_hab_pres = rowSums(across(names(fw_rast_stack)), na.rm = T)) # Get number of habitat types in each parcel\n\n\n#### PLOTTING ####\n# Quick plot to check\nggplot(notprotected_cons_vals_sf) +\n  geom_sf(aes(fill = fw_num_hab_pres))\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Caption for all maps\ncaption <- paste0(\"Map created: \", date(), \". Palen Lab. Created by Jay Matsushiba (jmatsush@sfu.ca)\")\n\n# Conservation Vals Continuous\nconservation_vals_cont_gg <- function() {\n  notprotected_public_colour <-  \"green\"\n  notprotected_private_colour <- \"red\"\n  list(\n    geom_sf(data = notprotected_cons_vals_sf, aes(fill = rankmap), color = NA),\n    scale_fill_viridis_c(),\n    geom_sf(data = notprotected_privatelands, aes(colour = notprotected_private_colour), linewidth = 0.3, fill = NA),\n    geom_sf(data = notprotected_publiclands, aes(colour = notprotected_public_colour), linewidth = 0.3, fill = NA),\n    scale_colour_identity(\n      name = \"\",\n      breaks = c(notprotected_public_colour, notprotected_private_colour),\n      labels = c(\"Unprotected Public\", \"Unprotected Private\"),\n      guide = \"legend\"\n    ),\n    ggnewscale::new_scale_fill(),\n    ggnewscale::new_scale_colour()\n  )\n}\nconservation_vals_cont_ggplot <- bowen_map_ggplot(\n  conservation_vals_cont_gg,\n  title = \"Conservation Values by Unprotected Parcels\",\n  subtitle = \"Mapping the unprotected parcels and their relative biodiversity values to identify potential parcels for future protection.\",\n  caption = caption\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `bowen_island_shoreline_w_hutt__bowen_islands' from data source \n  `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/bowen_island_shoreline_w_hutt.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 4001956 ymin: 2020764 xmax: 4013988 ymax: 2028901\nProjected CRS: NAD83 / Statistics Canada Lambert\nLoading basemap 'backdrop' from map service 'maptiler'...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n<SpatRaster> resampled to 501000 cells.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot2::ggsave(\n  here(output_dir, \"/\", paste0(Sys.Date(), \"_conservation_vals_continuous_parcels.png\")),\n  conservation_vals_cont_ggplot,\n  device = ragg::agg_png,\n  width = 9, height = 12, units = \"in\", res = 300\n)\n\n# Conservation Vals Top 30\nconservation_vals_top_gg <- function() {\n  notprotected_public_colour <-  \"green\"\n  notprotected_private_colour <- \"red\"\n  list(\n    geom_sf(data = notprotected_cons_vals_sf, aes(fill = rankmap_top_30), color = NA),\n    scale_fill_viridis_c(),\n    geom_sf(data = notprotected_privatelands, aes(colour = notprotected_private_colour), linewidth = 0.3, fill = NA),\n    geom_sf(data = notprotected_publiclands, aes(colour = notprotected_public_colour), linewidth = 0.3, fill = NA),\n    scale_colour_identity(\n      name = \"\",\n      breaks = c(notprotected_public_colour, notprotected_private_colour),\n      labels = c(\"Unprotected Public\", \"Unprotected Private\"),\n      guide = \"legend\"\n    ),\n    ggnewscale::new_scale_fill(),\n    ggnewscale::new_scale_colour()\n  )\n}\nconservation_vals_top_ggplot <- bowen_map_ggplot(\n  conservation_vals_top_gg,\n  title = \"Top Conservation Values by Unprotected Parcels\",\n  subtitle = \"Mapping the unprotected parcels and number of top 30% conservation value cells to identify potential parcels for future protection.\",\n  caption = caption\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `bowen_island_shoreline_w_hutt__bowen_islands' from data source \n  `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/bowen_island_shoreline_w_hutt.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 4001956 ymin: 2020764 xmax: 4013988 ymax: 2028901\nProjected CRS: NAD83 / Statistics Canada Lambert\nLoading basemap 'backdrop' from map service 'maptiler'...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n<SpatRaster> resampled to 501000 cells.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot2::ggsave(\n  here(output_dir, \"/\", paste0(Sys.Date(), \"_conservation_vals_top_parcels.png\")),\n  conservation_vals_top_ggplot,\n  device = ragg::agg_png,\n  width = 9, height = 12, units = \"in\", res = 300\n)\n\n# Freshwater sum richness\nfreshwater_sum_gg <- function() {\n  notprotected_public_colour <-  \"green\"\n  notprotected_private_colour <- \"red\"\n  list(\n    geom_sf(data = notprotected_cons_vals_sf, aes(fill = fw_sum_richness), color = NA),\n    scale_fill_viridis_c(),\n    geom_sf(data = notprotected_privatelands, aes(colour = notprotected_private_colour), linewidth = 0.3, fill = NA),\n    geom_sf(data = notprotected_publiclands, aes(colour = notprotected_public_colour), linewidth = 0.3, fill = NA),\n    scale_colour_identity(\n      name = \"\",\n      breaks = c(notprotected_public_colour, notprotected_private_colour),\n      labels = c(\"Unprotected Public\", \"Unprotected Private\"),\n      guide = \"legend\"\n    ),\n    ggnewscale::new_scale_fill(),\n    ggnewscale::new_scale_colour()\n  )\n}\nfreshwater_sum_ggplot <- bowen_map_ggplot(\n  freshwater_sum_gg,\n  title = \"Relative Freshwater Habitat Richness by Unprotected Parcels\",\n  subtitle = \"Mapping the unprotected parcels and the total sum of freshwater habitat richness cells to identify potential parcels for future protection.\",\n  caption = caption\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `bowen_island_shoreline_w_hutt__bowen_islands' from data source \n  `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/bowen_island_shoreline_w_hutt.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 4001956 ymin: 2020764 xmax: 4013988 ymax: 2028901\nProjected CRS: NAD83 / Statistics Canada Lambert\nLoading basemap 'backdrop' from map service 'maptiler'...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n<SpatRaster> resampled to 501000 cells.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot2::ggsave(\n  here(output_dir, \"/\", paste0(Sys.Date(), \"_fw_sum_richness_parcels.png\")),\n  freshwater_sum_ggplot,\n  device = ragg::agg_png,\n  width = 9, height = 12, units = \"in\", res = 300\n)\n# Freshwater num habitats richness\nfreshwater_num_hab_gg <- function() {\n  notprotected_public_colour <-  \"green\"\n  notprotected_private_colour <- \"red\"\n  list(\n    geom_sf(data = notprotected_cons_vals_sf, aes(fill = fw_num_hab_pres), color = NA),\n    scale_fill_viridis_c(),\n    geom_sf(data = notprotected_privatelands, aes(colour = notprotected_private_colour), linewidth = 0.3, fill = NA),\n    geom_sf(data = notprotected_publiclands, aes(colour = notprotected_public_colour), linewidth = 0.3, fill = NA),\n    scale_colour_identity(\n      name = \"\",\n      breaks = c(notprotected_public_colour, notprotected_private_colour),\n      labels = c(\"Unprotected Public\", \"Unprotected Private\"),\n      guide = \"legend\"\n    ),\n    ggnewscale::new_scale_fill(),\n    ggnewscale::new_scale_colour()\n  )\n}\nfreshwater_num_hab_ggplot <- bowen_map_ggplot(\n  freshwater_num_hab_gg,\n  title = \"Number of Freshwater Habitats in Unprotected Parcels\",\n  subtitle = \"Mapping the unprotected parcels and number of freshwater habitat types present to identify potential parcels for future protection.\",\n  caption = caption\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `bowen_island_shoreline_w_hutt__bowen_islands' from data source \n  `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/bowen_island_shoreline_w_hutt.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 4001956 ymin: 2020764 xmax: 4013988 ymax: 2028901\nProjected CRS: NAD83 / Statistics Canada Lambert\nLoading basemap 'backdrop' from map service 'maptiler'...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n<SpatRaster> resampled to 501000 cells.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot2::ggsave(\n  here(output_dir, \"/\", paste0(Sys.Date(), \"_fw_num_hab_parcels.png\")),\n  freshwater_num_hab_ggplot,\n  device = ragg::agg_png,\n  width = 9, height = 12, units = \"in\", res = 300\n)\n\n#### PLOTTING PUBLIC LANDS ####\n# Conservation Vals Continuous\nconservation_vals_cont_pub_gg <- function() {\n  list(\n    geom_sf(data = notprotected_cons_vals_sf[!notprotected_cons_vals_sf$OwnerType %in% c(\"Private\", \"Mixed Ownership\", \"Unclassified\"),] , aes(fill = rankmap), color = NA),\n    scale_fill_viridis_c(),\n    ggnewscale::new_scale_fill(),\n    ggnewscale::new_scale_colour()\n  )\n}\nconservation_vals_cont_pub_ggplot <- bowen_map_ggplot(\n  conservation_vals_cont_pub_gg,\n  title = \"Conservation Values by Unprotected Parcels\",\n  subtitle = \"Mapping the unprotected parcels and their relative biodiversity values to identify potential parcels for future protection.\",\n  caption = caption\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `bowen_island_shoreline_w_hutt__bowen_islands' from data source \n  `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/bowen_island_shoreline_w_hutt.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 4001956 ymin: 2020764 xmax: 4013988 ymax: 2028901\nProjected CRS: NAD83 / Statistics Canada Lambert\nLoading basemap 'backdrop' from map service 'maptiler'...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n<SpatRaster> resampled to 501000 cells.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot2::ggsave(\n  here(output_dir, \"/\", paste0(Sys.Date(), \"_conservation_vals_continuous_pub_parcels.png\")),\n  conservation_vals_cont_pub_ggplot,\n  device = ragg::agg_png,\n  width = 9, height = 12, units = \"in\", res = 300\n)\n\n# Conservation Vals Top 30\nconservation_vals_top_pub_gg <- function() {\n  list(\n    geom_sf(data = notprotected_cons_vals_sf[!notprotected_cons_vals_sf$OwnerType %in% c(\"Private\", \"Mixed Ownership\", \"Unclassified\"),], aes(fill = rankmap_top_30), color = NA),\n    scale_fill_viridis_c(),\n    ggnewscale::new_scale_fill(),\n    ggnewscale::new_scale_colour()\n  )\n}\nconservation_vals_top_pub_ggplot <- bowen_map_ggplot(\n  conservation_vals_top_pub_gg,\n  title = \"Top Conservation Values by Unprotected Parcels\",\n  subtitle = \"Mapping the unprotected parcels and number of top 30% conservation value cells to identify potential parcels for future protection.\",\n  caption = caption\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `bowen_island_shoreline_w_hutt__bowen_islands' from data source \n  `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/bowen_island_shoreline_w_hutt.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 4001956 ymin: 2020764 xmax: 4013988 ymax: 2028901\nProjected CRS: NAD83 / Statistics Canada Lambert\nLoading basemap 'backdrop' from map service 'maptiler'...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n<SpatRaster> resampled to 501000 cells.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot2::ggsave(\n  here(output_dir, \"/\", paste0(Sys.Date(), \"_conservation_vals_top_pub_parcels.png\")),\n  conservation_vals_top_pub_ggplot,\n  device = ragg::agg_png,\n  width = 9, height = 12, units = \"in\", res = 300\n)\n\n# Freshwater sum richness\nfreshwater_sum_pub_gg <- function() {\n  list(\n    geom_sf(data = notprotected_cons_vals_sf[!notprotected_cons_vals_sf$OwnerType %in% c(\"Private\", \"Mixed Ownership\", \"Unclassified\"),], aes(fill = fw_sum_richness), color = NA),\n    scale_fill_viridis_c(),\n    ggnewscale::new_scale_fill(),\n    ggnewscale::new_scale_colour()\n  )\n}\nfreshwater_sum_pub_ggplot <- bowen_map_ggplot(\n  freshwater_sum_pub_gg,\n  title = \"Relative Freshwater Habitat Richness by Unprotected Parcels\",\n  subtitle = \"Mapping the unprotected parcels and the total sum of freshwater habitat richness cells to identify potential parcels for future protection.\",\n  caption = caption\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `bowen_island_shoreline_w_hutt__bowen_islands' from data source \n  `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/bowen_island_shoreline_w_hutt.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 4001956 ymin: 2020764 xmax: 4013988 ymax: 2028901\nProjected CRS: NAD83 / Statistics Canada Lambert\nLoading basemap 'backdrop' from map service 'maptiler'...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n<SpatRaster> resampled to 501000 cells.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot2::ggsave(\n  here(output_dir, \"/\", paste0(Sys.Date(), \"_fw_sum_richness_pub_parcels.png\")),\n  freshwater_sum_pub_ggplot,\n  device = ragg::agg_png,\n  width = 9, height = 12, units = \"in\", res = 300\n)\n# Freshwater num habitats richness\nfreshwater_num_hab_pub_gg <- function() {\n  list(\n    geom_sf(data = notprotected_cons_vals_sf[!notprotected_cons_vals_sf$OwnerType %in% c(\"Private\", \"Mixed Ownership\", \"Unclassified\"),], aes(fill = fw_num_hab_pres), color = NA),\n    scale_fill_viridis_c(),\n    ggnewscale::new_scale_fill(),\n    ggnewscale::new_scale_colour()\n  )\n}\nfreshwater_num_hab_pub_ggplot <- bowen_map_ggplot(\n  freshwater_num_hab_pub_gg,\n  title = \"Number of Freshwater Habitats in Unprotected Parcels\",\n  subtitle = \"Mapping the unprotected parcels and number of freshwater habitat types present to identify potential parcels for future protection.\",\n  caption = caption\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `bowen_island_shoreline_w_hutt__bowen_islands' from data source \n  `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/bowen_island_shoreline_w_hutt.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 4001956 ymin: 2020764 xmax: 4013988 ymax: 2028901\nProjected CRS: NAD83 / Statistics Canada Lambert\nLoading basemap 'backdrop' from map service 'maptiler'...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n<SpatRaster> resampled to 501000 cells.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot2::ggsave(\n  here(output_dir, \"/\", paste0(Sys.Date(), \"_fw_num_hab_pub_parcels.png\")),\n  freshwater_num_hab_pub_ggplot,\n  device = ragg::agg_png,\n  width = 9, height = 12, units = \"in\", res = 300\n)\n```\n:::\n\n\n\n\n## Crown Land - Outside of Parcels\n### Polygon extent of unprotected crown land not in parcels \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Dissolve protected areas into one geometry\ndissolved_protectedareas <- bowen_protectedareas_valid %>%\n  summarise() %>%\n  st_cast() %>%\n  st_buffer(1) \n\ncrown_valid <- crown %>% \n  st_snap(x = ., y = ., tolerance = 0.1) %>%\n  st_make_valid() \nnotprotected_crown <- st_difference(crown_valid, dissolved_protectedareas)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: attribute variables are assumed to be spatially constant throughout\nall geometries\n```\n\n\n:::\n\n```{.r .cell-code}\n# Manually check each crown land polygon\nfor(i in 1:nrow(notprotected_crown)) {\n  plot(notprotected_crown[i,])\n}\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-3.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-4.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-5.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-6.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-7.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-8.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-9.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-10.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-11.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-12.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-13.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-14.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-15.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-16.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-17.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-18.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-19.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-20.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-21.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-5-22.png){width=672}\n:::\n\n```{.r .cell-code}\n# Remove polygons that should not be included in notprotected areas \n# rowname 1 (Fairy Fen Natural Reserve), sliver\n# rowname 74 (Seymour Bay Park), wrong polygon in the first place\nnotprotected_crown_clean <- notprotected_crown[!rownames(notprotected_crown) %in% c(\"1\",\"74\"),]\n```\n:::\n\n\n\n### Identify potential protected areas within crown land not in parcels\nRasterize layer\nIdentify candidate protected areas\nTwo ways that crown land can be good candidates\n1. High value pixels that are contiguous with other protected areas\nThings that fall under the top 30% are adjacent to protected areas \nEx. large areas west of Killarney Lake, northeast corner of Bowen Island, \n\n\n2. Contiguous pixels of high value that are not connected to protected areas \nLarge enough for arguing for protection, 10 to 50 hectares or bigger\n\nGreat place to start using prioritizr! \nhttps://prioritizr.net/\n\n#### Inputs\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbowen_mask_broken <- rast(here(\"inst/extdata/bowen_mask.tif\")) %>%\n  project(zonation)\n# for some reason, when bowen_mask is reprojected to match the zonation\n# raster, it ends up changing NA values to an extremely large number. \n# probably some bit rollover issue?\nplot(bowen_mask_broken, main = \"Broken Bowen Mask\")\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbowen_mask_broken %>%\n  values() %>%\n  max() # 4294967296\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 4294967296\n```\n\n\n:::\n\n```{.r .cell-code}\n# this value is the highest unsigned 32-bit integer\n# https://github.com/rspatial/terra/issues/1356\n# seems like this issue has been reported, but not fixed\n\n# planning units\nbowen_mask <- rast(here(\"inst/extdata/bowen_mask.tif\")) %>%\n  project(zonation) %>% \n  mask(zonation) \n\nplot(bowen_mask, main = \"Bowen Mask\")\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n\n```{.r .cell-code}\n# features\nplot(zonation, main = \"Zonation Output\")\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-6-3.png){width=672}\n:::\n:::\n\n\n\n\n#### Prioritizr\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate budget, get prop of pixels of planning units\nprop_pixels <- 0.3 # for some reason, this provides weird results when not large enough\nbudget <- terra::global(bowen_mask, \"sum\", na.rm = T)[[1]] * prop_pixels \n\n# create problem\np1 <- problem(bowen_mask, features = zonation) %>%\n  add_min_shortfall_objective(budget) %>%\n  add_relative_targets(1) %>% # need to be at least double the budget\n  # since we only have one feature, this target is meaningless but is a\n  # requirement for priortizr to work \n  add_binary_decisions() %>%\n  add_default_solver(gap = 0.05, verbose = FALSE) \n  # gap needs to be smaller than the difference between prop_pixels and locked constraints\n  # if this is not, leads to nonsensical solutions \n  # gap value is the % from optimal\n  # therefore, if gap is too large, then any solution is close enough to optimal\n\n# print conservation problem\nprint(p1)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nA conservation problem (<ConservationProblem>)\n├•data\n│├•features:    \"rankmap\"\n│└•planning units:\n│ ├•data:       <SpatRaster> (5314 total)\n│ ├•costs:      constant values (all equal to 1)\n│ ├•extent:     1186687.5, 483187.5, 1195387.5, 492987.5 (xmin, ymin, xmax, ymax)\n│ └•CRS:        NAD83 / BC Albers (projected)\n├•formulation\n│├•objective:   minimum shortfall objective (`budget` = 1594.2)\n│├•penalties:   none specified\n│├•targets:     relative targets (between 1 and 1)\n│├•constraints: none specified\n│└•decisions:   binary decision\n└•optimization\n ├•portfolio:   default portfolio\n └•solver:      gurobi solver (`gap` = 0.05, `time_limit` = 2147483647, `first_feasible` = FALSE, …)\n# ℹ Use `summary(...)` to see complete formulation.\n```\n\n\n:::\n\n```{.r .cell-code}\npresolve_check(p1)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in presolve_check(compile(x), warn = warn): Problem failed presolve checks.\n\nThese checks indicate that solutions might not identify meaningful priority\nareas:\n\n✖ The problem only contains a single feature.\n→ Conservation planning generally requires multiple features (e.g., species,\n  ecosystem types) to identify meaningful priority areas.\n\nℹ For more information, see `presolve_check()`.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] FALSE\n```\n\n\n:::\n\n```{.r .cell-code}\ns1 <- solve(p1, force = T)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in solve(p1, force = T): → Problem failed presolve checks.\n\nThese checks indicate that solutions might not identify meaningful priority\nareas:\n\n✖ The problem only contains a single feature.\n→ Conservation planning generally requires multiple features (e.g., species,\n  ecosystem types) to identify meaningful priority areas.\n\nℹ For more information, see `presolve_check()`.\n```\n\n\n:::\n\n```{.r .cell-code}\n# extract the objective\nprint(attr(s1, \"objective\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nsolution_1 \n 0.4900132 \n```\n\n\n:::\n\n```{.r .cell-code}\n# compare plots, check for agreement between priortizr and zonation\nplot(s1, main = \"Priortizr Solution\", axes = FALSE)\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\nremove_by_quantile(zonation, 1 - prop_pixels) %>%\n  plot(main = \"Top Zonation Pixels\")\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n\n```{.r .cell-code}\n# check for number of cells \ns1 %>% values() %>% sum(na.rm = T) # 265 cells selected\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1594\n```\n\n\n:::\n\n```{.r .cell-code}\n# it works! basic top pixels identified, and agrees with zonation\n# the main goal is to not use priortizr for conservation values\n# the goal is to use the constraints and penalties that are part \n# of the package\n\n# Existing Protected Areas\nbowen_protectedareas %>% plot() \n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-7-3.png){width=672}\n:::\n\n```{.r .cell-code}\n# trying removing covenants, since very fragmented\nbowen_pa_rast <- bowen_protectedareas[bowen_protectedareas$type != \"Covenants\",] %>%\n  vect() %>%\n  project(bowen_mask) %>%\n  rasterize(bowen_mask, background = 0) %>%\n  mask(bowen_mask) \n\n# bowen_pa_rast_2 <- bowen_protectedareas %>%\n#   vect() %>%\n#   project(bowen_mask) %>%\n#   rasterize(bowen_mask, background = 0) %>%\n#   mask(bowen_mask) \n\nbowen_pa_cell_count <- bowen_pa_rast %>%\n  values() %>%\n  sum(na.rm = T)\nbowen_pa_prop <- bowen_pa_cell_count / sum(values(bowen_mask), na.rm = T)\n\nplot(bowen_pa_rast, main = \"Existing Protected Areas\")\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-7-4.png){width=672}\n:::\n\n```{.r .cell-code}\n# create new problem with locked in constraints \np2 <- \n  p1 %>%\n  add_locked_in_constraints(bowen_pa_rast)\n\ns2 <- solve(p2, force = T)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in solve(p2, force = T): → Problem failed presolve checks.\n\nThese checks indicate that solutions might not identify meaningful priority\nareas:\n\n✖ The problem only contains a single feature.\n→ Conservation planning generally requires multiple features (e.g., species,\n  ecosystem types) to identify meaningful priority areas.\n\nℹ For more information, see `presolve_check()`.\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(s2, main = \"Solution with Existing Protected Areas\")\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-7-5.png){width=672}\n:::\n\n```{.r .cell-code}\n# Crown land\n## Maybe combine analysis with parcels? \n## Keep seperate for now, combine later\n\ncrown_rast <- crown %>%\n  vect() %>%\n  project(bowen_mask) %>%\n  rasterize(bowen_mask, background = 0, touches = T) %>%\n  mask(bowen_mask)\n\n# need to make sure it includes the protected areas\ncrown_pa <- max(c(crown_rast, bowen_pa_rast))\n\n# reverse for locked out constraints\nm <- rbind(\n  c(0, 1),\n  c(1, 0)\n)\n\nlockedout <- crown_pa %>%\n  classify(m)\n\n# create new problem with locked out constraints\np3 <-\n  p2 %>%\n  add_locked_out_constraints(lockedout)\ns3 <- solve(p3, force = T)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in solve(p3, force = T): → Problem failed presolve checks.\n\nThese checks indicate that solutions might not identify meaningful priority\nareas:\n\n✖ The problem only contains a single feature.\n→ Conservation planning generally requires multiple features (e.g., species,\n  ecosystem types) to identify meaningful priority areas.\n\nℹ For more information, see `presolve_check()`.\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(s3, main = \"Solution with PA and Crown\")\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-7-6.png){width=672}\n:::\n\n```{.r .cell-code}\n# add boundary penalties\np4 <-\n  p3 %>%\n  add_boundary_penalties(penalty = 0.000001, edge_factor = 0.5)\ns4 <- solve(p4, force = T)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in solve(p4, force = T): → Problem failed presolve checks.\n\nThese checks indicate that solutions might not identify meaningful priority\nareas:\n\n✖ The problem only contains a single feature.\n→ Conservation planning generally requires multiple features (e.g., species,\n  ecosystem types) to identify meaningful priority areas.\n\nℹ For more information, see `presolve_check()`.\n```\n\n\n:::\n\n```{.r .cell-code}\ns4 %>% values() %>% sum(na.rm = T) # 1593\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1586\n```\n\n\n:::\n\n```{.r .cell-code}\n# the total pixels selected under no boundary penalty is 1594\n# therefore, with this penalty value of 0.000001\n# boundary penalty has an effect, but not overly so that \n# step just selects pixels around existing protected areas\n\nplot(s4, main = \"Solution with PA, Crown, and Boundary\")\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-7-7.png){width=672}\n:::\n\n```{.r .cell-code}\n# importance scores\nimp <- \n  p4 %>%\n  eval_rank_importance(s4, n = 5, force = T)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in matrix(compile(x)$lb(), ncol = n_z, nrow = n_pu): data length\n[15687] is not a sub-multiple or multiple of the number of rows [5314]\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in .local(x, solution, ...): → Problem failed presolve checks.\n\nThese checks indicate that solutions might not identify meaningful priority\nareas:\n\n✖ The problem only contains a single feature.\n→ Conservation planning generally requires multiple features (e.g., species,\n  ecosystem types) to identify meaningful priority areas.\n\nℹ For more information, see `presolve_check()`.\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(imp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \ndimensions  : 98, 87, 1  (nrow, ncol, nlyr)\nresolution  : 100, 100  (x, y)\nextent      : 1186688, 1195388, 483187.5, 492987.5  (xmin, xmax, ymin, ymax)\ncoord. ref. : NAD83 / BC Albers (EPSG:3005) \nsource(s)   : memory\nvarname     : rankmap \nname        : rs \nmin value   :  0 \nmax value   :  1 \n```\n\n\n:::\n\n```{.r .cell-code}\nimp <- terra::mask(imp, s4, maskvalues = 0, updatevalue = -1)\nplot(imp, main = \"Importance Scores\")\n```\n\n::: {.cell-output-display}\n![](protected_areas_files/figure-html/unnamed-chunk-7-8.png){width=672}\n:::\n\n```{.r .cell-code}\n# remove existing protected areas \nm <- c(\n  -1, 0, NA\n)\nimp_clean <- (imp - 2 * bowen_pa_rast) %>%\n  ifel(. <= -1, NA, .) \n```\n:::\n\n\n\n### Plotting\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# gg\ncrown_poten_ggfunc <- function() {\n  protected_colour <- \"#b3e2cd\"\n  parcels_colour <-  \"#fdcdac\"\n  output <- list(\n    geom_spatraster(data = imp_clean, na.rm = T),\n    scale_fill_viridis_c(na.value = NA, name = \"Protected Area Potential\"),\n    ggnewscale::new_scale_fill(),\n    geom_sf(data = parcels, aes(fill = parcels_colour)),\n    geom_sf(data = bowen_protectedareas_valid, aes(fill = protected_colour)),\n    scale_fill_identity(name = \"\",\n                          breaks = c(protected_colour, parcels_colour),\n                          labels = c(\"Protected\", \"Parcels\"),\n                          guide = \"legend\"\n    ),\n    ggnewscale::new_scale_fill(),\n    ggnewscale::new_scale_colour()\n  )\n  return(output)\n}\ncrown_poten_ggplot <- bowen_map_ggplot(\n  crown_poten_ggfunc,\n  title = \"Top Locations for Protected Areas (30x30)\",\n  subtitle = \"Mapping optimal Crown land for reaching 30x30 targets, using the conservation values analysis and existing protected areas. This output considers connectivity by applying boundary penalties, which prioritizes shorter boundaries relative to area. Currently, about 20% of Bowen Island is under some protection.\",\n  caption = caption\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `bowen_island_shoreline_w_hutt__bowen_islands' from data source \n  `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/bowen_island_shoreline_w_hutt.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 4001956 ymin: 2020764 xmax: 4013988 ymax: 2028901\nProjected CRS: NAD83 / Statistics Canada Lambert\nLoading basemap 'backdrop' from map service 'maptiler'...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n<SpatRaster> resampled to 501000 cells.\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot2::ggsave(\n  here(output_dir, \"/\", paste0(Sys.Date(), \"_crown_potential.png\")),\n  crown_poten_ggplot,\n  device = ragg::agg_png,\n  width = 9, height = 12, units = \"in\", res = 300\n)\n```\n:::\n",
    "supporting": [
      "protected_areas_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}