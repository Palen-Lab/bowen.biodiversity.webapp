---
title: "Bowen Island Biodiversity Data Atlas"
subtitle: "Species Distribution, Habitat Mapping, and Conservation Priorities"
author:
  - name: "Jay Matsushiba"
    affiliation: "Simon Fraser University"
  - name: "Wendy Palen"
    affiliation: "Simon Fraser University"
  - name: "Tom Sisk"
    affiliation: "Simon Fraser University"
date: "2026/02/03"
format:
  pdf:
    number-sections: true
    include-in-header:
      - "header.tex"
    toc: true
    documentclass: report
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, # Don't show code
  warning = FALSE, # Don't show warnings
  message = FALSE, # Don't show messages
  results = 'hide', # Hide text output
  fig.show = 'asis', # Show plots
  fig.width = 9, # Figure width in inches
  fig.height = 9.5, # Figure height in inches
  out.width = "\\linewidth" # Scale to full width
)
```

```{r setup, echo=F}
devtools::load_all()
# library(bowen.biodiversity.data, quietly = T)
#### Utilities ####
library(here, quietly = T)
library(dplyr, quietly = T)
library(magrittr, quietly = T)
library(stringr, quietly = T)
library(glue, quietly = T)
#### Spatial ####
library(sf, quietly = T)
library(terra, quietly = T)
library(tidyterra, quietly = T)
#### Tabular Data ####
library(readxl)
library(googlesheets4)
#### Plotting ####
library(ggplot2, quietly = T)
library(ggnewscale, quietly = T)
library(RColorBrewer, quietly = T)
library(randomcoloR, quietly = T)

#### Use planar coordinates ####
sf_use_s2(FALSE)

#### Output directories ####
output_dir <- here("output-figures/data-atlas")
if (!dir.exists(output_dir)) {
  dir.create(output_dir)
}

#### Define plot extent ####
bowen_mask <- rast(here("data/bowen_mask.tif")) %>%
  project('epsg:3857') # Project to Web Mercator for basemap
bowen_mask_ext <- bowen_mask %>%
  ext()

#### Base map for plots ####
# basemap_for_plot <- basemaps::basemap_terra(ext = raster_layer, map_service = "carto", map_type = "voyager")
basemap_for_plot <- basemaps::basemap_terra(
  ext = bowen_mask,
  map_service = "maptiler",
  map_type = "backdrop",
  map_token = "baL4WLstSFqSHP2fnYrE"
) %>% mask(vect(bowen_ocean_sf), inverse = T)

#### Consistent elements for plots ####
bowen_ocean_linewidth <- 0.5
bowen_ocean_colour <- "#dbdbdc"
trails_colour <- "brown"
roads_colour <- "darkgrey"
caption <- glue(
  "Map created: {date()}. Palen Lab."
)

plot_width = 9
plot_height = 12
plot_res = 300

template_plot <- ggplot2::ggplot() +
  ggplot2::theme_bw() +
  tidyterra::geom_spatraster_rgb(data = basemap_for_plot) +
  ggplot2::scale_x_continuous(
    expand = c(0, 0),
    limits = c(bowen_mask_ext[1], bowen_mask_ext[2])
  ) +
  ggplot2::scale_y_continuous(
    expand = c(0, 0),
    limits = c(bowen_mask_ext[3], bowen_mask_ext[4])
  ) +
  ggplot2::theme(
    axis.text.y = ggplot2::element_text(
      angle = 90,
      vjust = 1,
      hjust = 0.5
    ),
    legend.position = "bottom",
    legend.title = ggplot2::element_text(size = 10),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.width = ggplot2::unit(1.5, "cm"),
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.box.margin = margin(1, 1, 1, 1),
    legend.background = element_rect(fill = "transparent", color = NA),
    plot.margin = unit(c(0, 0, 0, 0), "cm"),
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = bowen_ocean_colour, color = NA),
    panel.grid = element_blank()
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_colour()

template_plot_overlay <- function() {
  list(
    ggnewscale::new_scale_fill(),
    ggnewscale::new_scale_colour(),
    geom_sf(
      data = bowen_ocean_sf,
      linewidth = bowen_ocean_linewidth,
      fill = NA
    ),
    geom_sf(
      data = bowen_trails,
      linewidth = 0.3,
      aes(color = trails_colour)
    ),
    geom_sf(
      data = bowen_roads,
      linewidth = 0.5,
      aes(color = roads_colour)
    ),
    scale_colour_identity(
      name = "",
      breaks = c(trails_colour, roads_colour),
      labels = c("Trails", "Roads"),
      guide = "legend"
    )
  )
}

template_plot_annotations <- function() {
  list(
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ),
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      pad_x = unit(0.2, "in"),
      pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    ),
    theme(
      legend.key = element_rect(fill = "white", color = NA)
    )
  )
}

template_plot_remove <- function() {
  list(
    theme(
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.line = element_blank(),
      axis.ticks = element_blank(),
      panel.background = element_rect(fill = "transparent", color = NA),
      panel.border = element_blank()
    )
  )
}

#### Input data layers ####
sdm_url <- "https://docs.google.com/spreadsheets/d/1IGFwkr9LidcZwbzOJJGSEXLsmpKp0a9gBs65EY-H1xw/edit?usp=sharing"
habitats_url <- "https://docs.google.com/spreadsheets/d/1yDKw4r3tbXYivwtxbbfxc-pYSbtbj_o2ee1pwlNCOO4/edit?usp=drive_link"
sheet_date <- "2025-06-30"

#### CREATE DATAFRAME FOR INPUT LAYERS ####
# TODO: raster paths need to be fixed now
# Read from Google Sheets
habitats_df <- read_sheet(habitats_url, sheet = sheet_date) %>%
  # New filepath for layers
  mutate(path = stringr::str_replace_all(
    path,                                 
    "/home/jay/Programming_Projects/bowen.biodiversity.webapp/inst/extdata", 
    "/home/jay/Programming_Projects/Palen-Lab/bowen.biodiversity.webapp/data-etl/output-data")
  ) 
habitats_df$weight <- habitats_df$weight / nrow(habitats_df)
sdm_df <- read_sheet(sdm_url, sheet = sheet_date) %>%
  # New filepath for layers
  mutate(path = stringr::str_replace_all(
    path,                                 
    "/home/jay/Programming_Projects/bowen.biodiversity.webapp/inst/extdata/bowen_sdm", 
    "/home/jay/Programming_Projects/Palen-Lab/bowen.biodiversity.webapp/data-etl/output-data/sdm")
  ) 
sdm_df$weight <- sdm_df$weight / nrow(sdm_df)
# Bind all input layers together
layers_df <- sdm_df %>%
  select(colnames(habitats_df)) %>% # Select common columns
  bind_rows(habitats_df) %>%
  filter(weight > 0)
presence_threshold <- 0.7

# Prepare raster function 
prep_rast <- function(path) {
  path %>%
    unlist() %>%
    rast() %>%
    project("EPSG: 3857") %>% 
    higher_res_edges()
}
```

# Introduction

This Data Atlas presents a comprehensive assessment of biodiversity values across Bowen Island, British Columbia. The analysis integrates species distribution models for 193 vertebrate species, habitat mapping data from multiple sources, and conservation prioritization results to identify areas of high ecological significance.

This work was developed through a collaboration between Simon Fraser University's Palen Lab and Bowen Island Conservancy, with the goal of supporting evidence-based conservation planning and land use decision-making. The maps and data presented here synthesize information from government datasets, scientific research, local expertise, and community observations collected over several decades.

The atlas is organized into sections covering: (1) species distributions and richness patterns, (2) habitat diversity and extent, (3) integrated biodiversity values, and (4) conservation priorities and threat assessments.

## Disclaimer

The maps and analyses in this atlas represent our best understanding of Bowen Island's biodiversity based on available data as of May 2025. However, users should be aware of the following limitations:

- **Data gaps and omissions**: Not all species or habitats on Bowen Island have been systematically surveyed. Some areas, particularly private lands and remote locations, may have limited observation data.

- **Model uncertainty**: Species distribution models are statistical predictions based on environmental conditions and observation records. Actual species presence or absence at any specific location may differ from model predictions.

- **Accuracy and resolution**: Spatial data layers vary in their accuracy, resolution, and currency. Habitat boundaries and classifications should be verified through field surveys for site-specific applications.

- **Temporal changes**: Ecological conditions change over time due to natural processes, climate change, and human activities. Maps reflect conditions at the time of data collection and may not represent current conditions.

- **Analytical limitations**: Conservation prioritization analyses depend on weighting schemes, input data selection, and algorithmic assumptions that involve subjective choices.

- **Legal**: This atlas is not a legal document and should not be used as a definitive reference for property boundaries, zoning regulations, land ownership, development restrictions, or other legal or regulatory matters. Consult official municipal records and regulatory authorities for legal determinations.

This atlas is intended as a planning tool to inform decision-making, not as a definitive or comprehensive inventory. Field verification and expert consultation are recommended for site-specific assessments and conservation actions.

## Contact Information

For questions, corrections, or additional information about this Data Atlas:

**Primary Contact:**
Jay Matsushiba

Email: hello@jmatsushiba.com

**Project Information:**
Palen Lab, Simon Fraser University

GitHub: https://github.com/Palen-Lab/bowen.biodiversity.webapp

## Acknowledgements

This work was made possible through contributions from many individuals and organizations:

**Contributors:**

- Michael Tylo - Data analysis and processing

- Maya Persam - Workshop facilitation

- Kyra Rolfe - Workshop facilitation

- Valerie Kwok - Workshop facilitation

**Data Providers:**

- Bowen Heron Watch

- Alan Whitehead Consulting

- Metro Vancouver

- BC Government

- iNaturalist and eBird communities

See the project documentation for complete citations and acknowledgements.

{{< pagebreak >}}

# Overview
## Transportation Network, Bowen Island
Base Bowen Island map with hillshade, roads, and trails. 
```{r basic}
basic_plot <- template_plot +
  # Can add ggplot2 elements in between
  template_plot_overlay() +
  template_plot_annotations()

basic_plot_no_annotations <- template_plot +
  template_plot_overlay() +
  template_plot_remove()

ggplot2::ggsave(
  here(output_dir, "2_1_basic_map.png"),
  basic_plot,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)

ggplot2::ggsave(
  here(output_dir, "2_1_basic_map_no_annotations.png"),
  basic_plot_no_annotations,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)

basic_plot
```

{{< pagebreak >}}

# Focal Vertebrate Species
## Total Species Richness
Based on >0.7 probability of occurrence in Species Distribution Models.
```{r species_richness}
#### Preparing Raster #### 
# List SDMs filepaths
SDM_filepaths <- sdm_df[
  sdm_df$category %in% c("Bird", "MammalSmall", "Amphibian", "Reptile"),
  "path"
] 
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create species richness SDM
total_richness <- sdm_to_species_richness(
  SDM_stack = SDM_stack,
  presence_threshold = presence_threshold
) 
# Save raster
writeRaster(
  total_richness,
  here("output-data/2_species/total_richness.tif"),
  overwrite = T
)
# Prepare raster for plot
total_richness <- total_richness %>%
  project("EPSG: 3857") %>% 
  higher_res_edges()
#### Plotting ####
# Base plot
total_richness_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = total_richness) +
  colorspace::scale_fill_continuous_sequential(
    name = "Species Richness",
    na.value = NA,
    palette = "ag_GrnYl",
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
    ),
  ) +
  template_plot_overlay() 
# Annotated plot
total_richness_plot_annotations <- total_richness_plot_base + 
  template_plot_annotations()
# No annotation plot
total_richness_plot_no_annotations <- total_richness_plot_base +
  template_plot_remove()
# Save plot
ggplot2::ggsave(
  here(output_dir, "3_1_total_species_richness.png"),
  total_richness_plot_annotations,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)
ggplot2::ggsave(
  here(output_dir, "3_1_total_species_richness_no_annotations.png"),
  total_richness_plot_no_annotations,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)
# Render in PDF
total_richness_plot_annotations
```
<!-- ## Total Species Diversity -->
<!-- ## TODO: Bird Species Richness -->
<!-- Based on >presence_threshold probability of occurrence in Species Distribution Models. -->
```{r, eval=F}
# Create species richness plots:
## Each species is marked present in a cell, if they are above a certain
## threshold of probability in the input SDMs.

# Create SDM stack from paths
SDM_stack <- sdm_df[sdm_df$category == "Bird", "path"] %>%
  lapply(rast) %>%
  rast()
# Create species richness SDM
bird_richness <- sdm_to_species_richness(
  SDM_stack = SDM_stack,
  presence_threshold = presence_threshold
)
writeRaster(
  bird_richness,
  here("inst/extdata/2_species/birds_richness.tif"),
  overwrite = T
)

title <- "Bird Species Richness"
subtitle <- paste0()

bird_richness_plot <- bowen_map(
  raster_layer = bird_richness,
  title = title,
  subtitle = subtitle,
  caption = caption,
  legend_label = "Richness"
) +
  geom_sf(
    data = bowen_ocean_sf,
    linewidth = bowen_ocean_linewidth,
    fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(
    data = bowen_trails,
    linewidth = 0.3,
    aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(
    data = bowen_roads,
    linewidth = 0.5,
    aes(color = roads_colour)
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(trails_colour, roads_colour),
    labels = c("Trails", "Roads"),
    guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "in"),
    pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )

ggplot2::ggsave(
  here(
    output_dir,
    "/",
    paste0(Sys.Date(), "_2_1_bird_species_richness_map.png")
  ),
  bird_richness_plot,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
```

<!-- ## Small Mammal Species Richness -->
<!-- ## Amphibian & Reptile Species Richness -->
<!-- ## Threatened & Endangered Species Richness -->

# Habitats
## Freshwater Habitats: Streams, Wetlands, Riparian Corridors 
Freshwater features on Bowen Island, derived from layers provided by Alan Whitehead (2025).
```{r fw_habitats}
#### Prepare raster for plots ####
fw_df <- layers_df[layers_df$category == "Freshwater", ]
# Color ramp
fw_df$colour <- RColorBrewer::brewer.pal(nrow(fw_df), "YlGnBu")

# Prepare streams rast
streams_rast <- fw_df[fw_df$name == "Streams", "path"] %>%
  unlist() %>%
  rast() %>%
  not.na() %>%
  classify(cbind(FALSE, NA)) %>%
  project("EPSG: 3857") %>% 
  higher_res_edges()

#### Plotting ####
fw_plot_base <- template_plot +
  tidyterra::geom_spatraster(
    data = prep_rast(fw_df[fw_df$name == "Lakes", "path"]),
    aes(fill = layer)
  ) +
  scale_fill_gradientn(
    name = "",
    labels = "Freshwater Lakes",
    colours = unlist(fw_df[fw_df$name == "Lakes", "colour"]),
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(
    data = prep_rast(fw_df[fw_df$name == "Ponds", "path"]),
    aes(fill = layer)
  ) +
  scale_fill_gradientn(
    name = "",
    labels = "Freshwater Ponds",
    colours = unlist(fw_df[fw_df$name == "Ponds", "colour"]),
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(
    data = prep_rast(fw_df[fw_df$name == "Riparian", "path"]),
    aes(fill = layer)
  ) +
  scale_fill_gradientn(
    name = "",
    labels = "Riparian",
    colours = unlist(fw_df[fw_df$name == "Riparian", "colour"]),
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(
    data = prep_rast(fw_df[fw_df$name == "Wetlands", "path"]),
    aes(fill = layer)
  ) +
  scale_fill_gradientn(
    name = "",
    labels = "Wetlands",
    colours = unlist(fw_df[fw_df$name == "Wetlands", "colour"]),
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = streams_rast, aes(fill = layer)) +
  scale_fill_gradientn(
    name = "",
    labels = "Streams",
    colours = unlist(fw_df[fw_df$name == "Streams", "colour"]),
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
    ggplot2::theme(
    legend.margin = margin(-26, 6, 6, 6),
    legend.key.width = ggplot2::unit(0.5, "cm"),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.spacing.y = ggplot2::unit(0, "lines"),
    legend.key.spacing.x = ggplot2::unit(0, "cm"),
    legend.direction = "vertical",
    legend.box = "vertical",
    legend.box.background = element_rect(fill = "white", colour = "black"),
    legend.box.margin = margin(20, 5, 5, 5),
    legend.position = c(.05, .95),
    legend.justification = c("left", "top"),
    legend.box.just = "left"
  ) 

fw_plot_annotation <- fw_plot_base +
  template_plot_annotations()
fw_plot_no_annotation <- fw_plot_base +
  template_plot_remove()

# Save plots
ggplot2::ggsave(
  here(output_dir, "4_1_bowen_water_map_annotation.png"),
  fw_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "4_1_bowen_water_map_no_annotation.png"),
  fw_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
# Render for PDF
fw_plot_annotation
```

{{< pagebreak >}}

## Freshwater Habitats Richness
Freshwater features on Bowen Island, derived from layers provided by Alan Whitehead (2025).
```{r fw_habitat_richness}
#### Prepare raster for plots ####
fw_rast_stack <- layers_df[layers_df$category == "Freshwater", "path"] %>%
  prep_rast()
fw_richness <- fw_rast_stack %>%
  lapply(not.na) %>%
  lapply(function(x) {
    classify(x, cbind(FALSE, NA))
  }) %>%
  rast() %>%
  sum(na.rm = T)
writeRaster(
  fw_richness,
  here("output-data/3_habitats/fw_richness.tif"),
  overwrite = T
)
#### Plotting ####
fw_richness_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = fw_richness) +
  colorspace::scale_fill_continuous_sequential(
    name = "Freshwater Habitat Richness",
    na.value = NA,
    palette = "Mako",
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
    )
  ) +
  template_plot_overlay()
fw_richness_plot_annotation <- fw_richness_plot_base +
  template_plot_annotations()
fw_richness_plot_no_annotation <- fw_richness_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "4_2_bowen_water_richness_map.png"),
  fw_richness_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "4_2_bowen_water_richness_map_no_annotation.png"),
  fw_richness_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
fw_richness_plot_annotation
```

<!-- ## Old & Large Forest: Old Forest, Old Growth Management Areas -->
<!-- ## Other Habitats: Sensitive Ecosystem Inventory -->

{{< pagebreak >}}

## Total Habitat Richness: Number of Habitat Types by Location
Total number of habitats found in each cell of the map. Habitats derived from Metro Vancouver Sensitive Ecosystem Inventory (2021), Terrestrial Ecosystem Mapping (2019), and Alan Whitehead (2025).
```{r habitat_richness}
#### Prepare raster for plots ####
habitat_stack <- habitats_df %>%
  filter(category != "Human Disturbance") %>%
  select(path) %>%
  prep_rast()
# Sum habitat stack
habitat_richness <- habitat_stack %>% sum(na.rm = T)
writeRaster(
  habitat_richness,
  here("output-data/3_habitats/total_habitat_richness.tif"),
  overwrite = T
)
#### Plotting ####
habitats_plot_base <- template_plot +
  tidyterra::geom_spatraster(
    data = habitat_richness
  ) +
  colorspace::scale_fill_continuous_sequential(
    name = "Habitat Richness",
    na.value = NA,
    palette = "ag_GrnYl",
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
    )
  ) +
  template_plot_overlay()
habitats_plot_annotation <- habitats_plot_base +
  template_plot_annotations()
habitats_plot_no_annotation <- habitats_plot_base +
  template_plot_remove()
# Saving plot
ggplot2::ggsave(
  here(output_dir, "4_3_bowen_habitat_richness_map.png"),
  habitats_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "4_3_bowen_habitat_richness_map_no_annotation.png"),
  habitats_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
habitats_plot_annotation
```

# Values 
## Biodiversity Value: Species & Habitats Combined
Zonation5 Prioritization Algorithm of Locations on Bowen Island. Environmental layers (n = 33) and species layers (n = 195).
```{r}
# Biodiversity values layer 
rankmap <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project("EPSG: 3857") 
rankmap_for_map <- rankmap %>%
  higher_res_edges()

# Base plot 
combined_biodiversity_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = rankmap_for_map) +
  colorspace::scale_fill_continuous_sequential(
    name = "Relative Biodiversity",
    na.value = NA,
    palette = "ag_GrnYl",
    limits = c(0,1),
    breaks = c(0,1),
    labels = c("Lower", "Higher"),
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    )
  ) +
  template_plot_overlay()

# With annotations
combined_biodiversity_plot <- combined_biodiversity_plot_base +
  template_plot_annotations()

# Without annotations and axis 
combined_biodiversity_plot_no_annotations <- combined_biodiversity_plot_base +
  template_plot_remove()

# Save plot
ggplot2::ggsave(
  here(output_dir, "5_1_combined_biodiversity_values.png"),
  combined_biodiversity_plot,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)
ggplot2::ggsave(
  here(output_dir, "5_1_combined_biodiversity_values_no_annotations.png"),
  combined_biodiversity_plot_no_annotations,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)

# Render in PDF
combined_biodiversity_plot
```

{{< pagebreak >}}

## Top 30% Biodiversity Value
Top 30% of biodiversity locations on Bowen Island. Zonation5 Prioritization Algorithm of Locations on Bowen Island. Environmental layers (n = 33)  with species layers (n = 195).
```{r}
#### Prepare raster for plotting #### 
rankmap_top30_lowres <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project("EPSG: 3857") %>% 
  remove_by_quantile(0.7) 
rankmap_top30 <- rankmap_top30_lowres %>%
  higher_res_edges() 
rankmap_mask <- rankmap_top30_lowres %>%
  not.na() %>%
  classify(cbind(FALSE, NA))

#### Plotting ####
top_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = rankmap_top30) +
  colorspace::scale_fill_continuous_sequential(
    name = "Relative Biodiversity",
    na.value = NA,
    palette = "ag_GrnYl",
    limits = c(0,1),
    breaks = c(0,1),
    labels = c("Lower", "Higher"),
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    )
  ) +
  template_plot_overlay()
top_plot_annotation <- top_plot_base +
  template_plot_annotations()
top_plot_no_annotation <- top_plot_base +
  template_plot_remove()
# Save plots 
ggplot2::ggsave(
  here(output_dir,"5_2_top_30_biodiversity_values.png"),
  top_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir,"5_2_top_30_biodiversity_values_no_annotation.png"),
  top_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
top_plot_annotation
```


# Threats
## Human Disturbance: Continuous
Continuous map of human disturbance on Bowen Island.
```{r human_disturbance_continuous}
#### Prepare raster for plotting ####
disturbed <- here("output-data/habitats/bowen_human_footprint.tif") %>%
  prep_rast()
max_hfp <- global(disturbed, fun = "max", na.rm = T) %>% unlist()
min_hfp <- global(disturbed, fun = "min", na.rm = T) %>% unlist()

#### Plotting ####
disturb_cont_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = disturbed) +
  colorspace::scale_fill_continuous_sequential(
    name = "Intactness",
    na.value = NA,
    palette = "Inferno",
    limits = c(min_hfp, max_hfp),
    breaks = c(min_hfp, max_hfp),
    labels = c("Higher", "Lower"),
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    )
  ) +
  template_plot_overlay()
disturb_cont_plot_annotation <- disturb_cont_plot_base +
  template_plot_annotations()
disturb_cont_plot_no_annotation <- disturb_cont_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "6_1_humandisturbance_continuous.png"),
  disturb_cont_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "6_1_humandisturbance_continuous_no_annotation.png"),
  disturb_cont_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
# Render for PDF
disturb_cont_plot_annotation
```
{{< pagebreak >}}

## Human Disturbance: Top 30% Biodiversity Value 
Top 30% of biodiversity locations on Bowen Island, with scale corresponding to relative human disturbance. 0% of top biodiversity locations are considered intact. 0.4% of top biodiversity locations considered to be less disturbed. 61.3% of top biodiversity cells are considered moderately disturbed. 35.5% of top biodiversity locations are highly disturbed. Citation: Kristen Hirsh-Pearson, Chris J. Johnson, Richard Schuster, Roger D. Wheate, and Oscar Venter. 2022. Canadaâ€™s human footprint reveals large intact areas juxtaposed against areas under immense anthropogenic pressure. FACETS. 7: 398-419."
```{r human_disturbance_top30}
#### Prepare layers for plots ####
# Biodiversity values layer 
rankmap <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project(bowen.biodiversity.webapp::project_crs)
rankmap_for_map <- rankmap %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_bt_rm <- rankmap %>%
  remove_by_quantile(0.7)
rankmap_bt_rm_for_map <-rankmap_bt_rm %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_mask <- rankmap_bt_rm %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
# Human Footprint (classified)
bowen_hfp_class <- here("output-data/habitats/bowen_human_footprint_recl.tif") %>%
  rast() %>%
  project(rankmap) %>%
  as.factor()
bowen_hfp_low <- bowen_hfp_class %>%
  classify(cbind(3, NA)) %>%
  classify(cbind(2, NA)) %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
bowen_hfp_med <- bowen_hfp_class %>%
  classify(cbind(3, NA)) %>%
  classify(cbind(1, NA)) %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
bowen_hfp_high <- bowen_hfp_class %>%
  classify(cbind(2, NA)) %>%
  classify(cbind(1, NA)) %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
#### Statistics ####
bowen_hfp_top <- mask(bowen_hfp_class, rankmap_mask) %>%
  as.factor()
# overlap with each category (low, medium, high)
hfp_low_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_low) %>%
  round(3)
# 0.004
hfp_med_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_med) %>%
  round(3)
# 0.613
hfp_high_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_high) %>%
  round(3)
# 0.355
hfp_cont <- here("output-data/habitats/bowen_human_footprint.tif") %>%
  rast() %>%
  project(rankmap_mask) 
hfp_top30 <- hfp_cont %>%
  mask(rankmap_mask) %>%
  project("EPSG: 3857") %>% 
  higher_res_edges()
#### Plotting ####
max_hfp <- global(hfp_cont, fun = "max", na.rm = T) %>% unlist()
min_hfp <- global(hfp_cont, fun = "min", na.rm = T) %>% unlist()

hfp_biod_vals_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = hfp_top30) +
  colorspace::scale_fill_continuous_sequential(
    name = "Intactness",
    na.value = NA,
    palette = "Inferno",
    limits = c(min_hfp, max_hfp),
    breaks = c(min_hfp, max_hfp),
    labels = c("Higher", "Lower"),
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    )
  ) +
  template_plot_overlay()
hfp_biod_vals_plot_annotation <- hfp_biod_vals_plot_base +
  template_plot_annotations()
hfp_biod_vals_plot_no_annotation <- hfp_biod_vals_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "6_2_humandisturbance_top30bv.png"),
  hfp_biod_vals_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "6_2_humandisturbance_top30bv_no_annotation.png"),
  hfp_biod_vals_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
# Render for PDF
hfp_biod_vals_plot_annotation
```

{{< pagebreak >}}

## Wildfire Vulnerability Index: Continuous
This is not an assessment of the probability or behaviour of the fire. The intention of this index is to describe the relative vulnerability to biodiversity loss due to fire, under a scenario where the habitats burn. The three major components of this vulnerability index are slope, aspect, and fuel.
```{r}
#### Preparing raster for plotting #### 
fire_index_mp <- rast(here("output-data/6_threats/fire_index_40m.tif")) %>%
  project("EPSG: 3857") %>%
  terra::subst(4294967296, NA) %>% # Max value should be NA
  terra::scale_linear()
#### Plotting ####
# TODO: change colour palette from cool to warm
fire_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = fire_index_mp) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "Batlow",
    rev = FALSE,
    limits = c(0,1),
    breaks = c(0,1),
    labels = c("Lower", "Higher"),
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Wildfire Vul. Index"
  ) +
  template_plot_overlay()
fire_plot_annotation <- fire_plot_base + 
  template_plot_annotations()
fire_plot_no_annotation <- fire_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "6_3_fire_vulnerability_index.png"),
  fire_plot_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
ggplot2::ggsave(
  here(output_dir, "6_3_fire_vulnerability_index_no_annotation.png"),
  fire_plot_no_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
# Render for PDF
fire_plot_annotation
```
{{< pagebreak >}}

## Wildfire Vulnerability Index: Top 30% Biodiversity Value and Top 30% WVI
This is not an assessment of the probability or behaviour of the fire. The intention of this index is to describe the relative vulnerability to biodiversity loss due to fire, under a scenario where the habitats burn. The three major components of this vulnerability index are slope, aspect, and fuel.

26.3% of top 30% biodiversity values are within the top 30% of wildfire vulnerability index values. 

```{r}
#### Preparing raster for plotting #### 
top30_wvi <- rast(here("output-data/6_threats/fire_index_40m.tif")) %>%
  project("EPSG: 3857") %>%
  terra::subst(4294967296, NA) %>% # Max value should be NA
  terra::scale_linear() %>% 
  remove_by_quantile(0.7) 

rankmap_top30_lowres <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project("EPSG: 3857") %>% 
  remove_by_quantile(0.7) 
rankmap_top30 <- rankmap_top30_lowres %>%
  higher_res_edges() 
rankmap_mask <- rankmap_top30_lowres %>%
  not.na() %>%
  classify(cbind(FALSE, NA))

rankmap_mask_re <- rankmap_mask %>% 
  resample(top30_wvi) 
grey_rast <- rankmap_mask_re %>%
  higher_res_edges() %>%
  as.factor()
fire_biod_val <- mask(top30_wvi, rankmap_mask_re)

# Calculate statistics
top30_wvi_resamp <- top30_wvi %>%
  resample(rankmap_mask, method = "average") %>%
  mask(rankmap_mask)
top30_wvi_resamp %>% 
  terra::not.na() %>%
  values() %>%
  sum()
# 426
rankmap_mask %>% 
  terra::not.na() %>%
  values() %>%
  sum()
# 1621
426 / 1621
# 0.2628007 
# This proportion of top 30% biodiversity values are within the top 30% of wildfire vulnerability index values. 

#### Plotting ####
fire_biod_val_plot_base <- template_plot +
  tidyterra::geom_spatraster(
    data = grey_rast
  ) +
  scale_fill_manual(
    values = c("grey40"),           
    labels = c(""),          
    na.value = NA,                  
    na.translate = FALSE,
    guide = ggplot2::guide_legend(
      title.position = "top",
      order = 2
    ),
    name = "Outside Top 30% WVI"
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_colour() +
  tidyterra::geom_spatraster(data = fire_biod_val) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "Batlow",
    rev = FALSE,
    limits = c(0,1),
    breaks = c(0,1),
    labels = c("Lower", "Higher"),
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
    ),
    name = "Wildfire Vul. Index"
  ) +
  template_plot_overlay()
fire_biod_val_plot_annotation <- fire_biod_val_plot_base + 
  template_plot_annotations()
fire_biod_val_plot_no_annotation <- fire_biod_val_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "6_4_wvi_top30.png"),
  fire_biod_val_plot_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
ggplot2::ggsave(
  here(output_dir, "6_4_wvi_top30_no_annotation.png"),
  fire_biod_val_plot_no_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
# Render for PDF
fire_biod_val_plot_annotation
```
{{< pagebreak >}}

## Wildland Urban Interface
The Province of British Columbia produces the Wildland Urban Interface (WUI) maps, with their intention being to use these maps to inform the relative impact of wildfires on human development. These maps take into consideration three key variables - fuel load, climate conditons, and human development at the interface between urban and wildland areas. This map shows the combinations of WUI Classification and Provincial Strategic Threat Analysis (PSTA) Threat Rating.
```{r}
#### Prepare layers for plotting ####
bowen_wui <- here("data-raw/datasets/bc_wui/wui.gpkg") %>% 
  st_read(quiet = T) %>%
  select(Name, PSTA) %>%
  rename(WUI = Name) %>%
  mutate(WUI_PSTA = paste0(WUI, " / ", PSTA))
wui_factor_lvls <- c("No Data (Private Land) / 1-4", "Water / 1-4", "Low / 1-4", "Moderate / 1-4", "Moderate / 5-6")
wui_factor <- bowen_wui %>%
  mutate(
    WUI_PSTA = factor(WUI_PSTA, levels = wui_factor_lvls)
  )
wui_factor_cols <- c("grey", "lightblue", "#fff7bc", "#fec44f", "#d95f0e")
names(wui_factor_cols) <- wui_factor_lvls

#### Plotting ####
wui_plot_base <- template_plot +
  geom_sf(data = bowen_wui, aes(fill = WUI_PSTA), colour = NA) +
  scale_fill_manual(
    values = wui_factor_cols, 
    name = NULL,
    guide = guide_legend(order = 1)
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_colour() +
  template_plot_overlay() +
  ggplot2::theme(
    legend.margin = margin(-9, 6, 6, 6),
    legend.key.width = ggplot2::unit(0.5, "cm"),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.spacing.y = ggplot2::unit(0, "lines"),
    legend.key.spacing.x = ggplot2::unit(0, "cm"),
    legend.direction = "vertical",
    legend.box = "vertical",
    legend.box.background = element_rect(fill = "white", colour = "black"),
    legend.box.margin = margin(20, 5, 5, 5),
    legend.position = c(.05, .95),
    legend.justification = c("left", "top"),
    legend.box.just = "left"
  )

wui_plot_annotation <- wui_plot_base +
  template_plot_annotations()
wui_plot_no_annotation <- wui_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "6_5_wui.png"),
  wui_plot_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
ggplot2::ggsave(
  here(output_dir, "6_5_wui_no_annotation.png"),
  wui_plot_no_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
# Render for PDF
wui_plot_annotation
```

# Land Management

## Development Pressure: Biodiversity Value by Parcel
Summed relative biodiversity value of properties (parcels). Relative measure of which parcels deserve closer consideration during the development process. 
```{r}
#### Preparing layers for plot ####
# Load and prepare parcel map
parcelmap_bowen_prepd <- parcelmap_bowen %>%
  filter(OBJECTID != 2096841) # Remove ferry route

# Load biodiversity values generated from Zonation
biod_vals <- rast(here("output-data/5_values/rankmap.tif"))
# Match parcelmap projection to the Zonation rast
parcelmap_vect <- parcelmap_bowen_prepd %>%
  vect() %>%
  project(biod_vals)
# Extract values that overlap cells
parcelmap_extract <- terra::extract(
  biod_vals,
  parcelmap_vect,
  sum, # sums all cells that overlap with each parcel
  bind = T, # bind to SpatVector
  weights = T # weight by fraction of cell that is within the polygon
)
parcelmap_extract_sf <- parcelmap_extract %>%
  st_as_sf()
#### Plotting ####
parcelmap_biod_vals_plot_base <- template_plot +
  geom_sf(
    data = parcelmap_extract_sf,
    aes(fill = rankmap),
    color = NA
  ) +
  scale_fill_continuous(
    palette = "YlGn",
    name = "Relative Biodiversity / Parcel",
    breaks = c(min(parcelmap_extract_sf$rankmap, na.rm = T), max(parcelmap_extract_sf$rankmap, na.rm = T)),
    labels = c("Lower", "Higher"),
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    )
  ) +
  template_plot_overlay()
parcelmap_biod_vals_plot_annotation <- parcelmap_biod_vals_plot_base +
  template_plot_annotations()
parcelmap_biod_vals_plot_no_annotation <- parcelmap_biod_vals_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "7_1_parcelmap_biod_vals_plot.png"),
  parcelmap_biod_vals_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "7_1_parcelmap_biod_vals_plot_no_annotation.png"),
  parcelmap_biod_vals_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
# Render for PDF
parcelmap_biod_vals_plot_annotation
```
{{< pagebreak >}}

## Development Pressure: Subdivision Potential
Quantifying the development potential on Bowen Island, via subdivisions of properties that enable increased development / density.The current zoning restricts the number of buildings per lot and the minimum area per lot. Therefore, splitting properties into multiple smaller but above minimum area properties increases the number of buildings that can be built. 

Daniel Martin, Manager of Planning and Development at Bowen Island Municipality, provided these spreadsheets with information on the potential for individual lots to be subdivided. Additionally, Martin provided the number of potential further developments possible in Comprehensive Development Zones on Bowen Island. 
```{r}
#### Preparing layers for plotting #### 
# RR1 and RR2 (Rural Residential 1 and 2 Zoning)
rr1_rr2 <- here("data-raw/datasets/development_potential_danielmartin/zoning subdivision potential.xlsx") %>%
  readxl::read_xlsx(sheet = "RR1,RR2")
# RR3 (Rural Residential 3 Zoning)
rr3 <- here("data-raw/datasets/development_potential_danielmartin/zoning subdivision potential.xlsx") %>%
  readxl::read_xlsx(sheet = "RR3 properties")
# SR (Settlement Residential zoning)
sr <- here("data-raw/datasets/development_potential_danielmartin/zoning subdivision potential.xlsx") %>%
  readxl::read_xlsx(sheet = "SR properties")
# CD (Comprehensive Development Zones)
## Deal with these separately, need to do some wrangling 
ocp_subdivision <- rbind(rr1_rr2, rr3, sr) %>%
  filter(!is.na(pid))
ocp_subdivision_parcelmap <- merge(ocp_subdivision, parcelmap_bowen, by.x = "pid", by.y = "PARCEL_NAME") %>%
  mutate(subdividable = case_when(
    `Can Subdivide?` == 0 ~ FALSE,
    `Can Subdivide?` > 0 ~ TRUE
  )) %>%
  st_as_sf() %>%
  st_transform(project_crs)
ocp_subdivision_parcelmap_f <- ocp_subdivision_parcelmap %>%
  mutate(
    pid = as.numeric(pid)
  )
# Removing duplicated columns
unique(ocp_subdivision_parcelmap_f$pid == ocp_subdivision_parcelmap_f$PID_NUMBER) # TRUE
unique(ocp_subdivision_parcelmap_f$parcelclass == toupper(ocp_subdivision_parcelmap_f$PARCEL_CLASS)) # TRUE
unique(ocp_subdivision_parcelmap_f$ownertype == toupper(ocp_subdivision_parcelmap_f$OWNER_TYPE)) # FALSE
which(ocp_subdivision_parcelmap_f$ownertype != toupper(ocp_subdivision_parcelmap_f$OWNER_TYPE)) # 1740
# turns out its UNCLASS and Unclassified, so the same 
ocp_subdivision_parcelmap_fd <- ocp_subdivision_parcelmap_f %>%
  select(!c(
    parcelclass, ownertype, pid, Shape__Area, area_sqm, SHAPE_Area, SHAPE_Length, objectid
  )) 
# Remove outlier and duplicate PID
unique(ocp_subdivision_parcelmap_fd$PID_NUMBER) %>% length() # 1755, so one fewer than than nrows
ocp_subdivision_parcelmap_fdr <- ocp_subdivision_parcelmap_fd %>%
  filter(`Can Subdivide?` != 46)
write_sf(
  ocp_subdivision_parcelmap_fdr, 
  here("data-raw/datasets/development_potential_danielmartin/ocp_subdivision_parcelmap.gpkg"), 
  delete_layer = TRUE
)

#### Plotting ####
subdivide_plot_base <- template_plot +
  geom_sf(
    data = parcelmap_bowen[parcelmap_bowen$OWNER_TYPE %in% c("Private", "Unclassified"),], 
    aes(geometry = geom), color = NA, fill = "grey"
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_color() +
  geom_sf(
    data = ocp_subdivision_parcelmap_fdr, 
    aes(fill = `Can Subdivide?`, geometry = geom), color = NA
  ) +
  scale_fill_distiller(
    palette = "RdPu",
    direction = 1,
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    )
  )
subdivide_plot_annotation <- subdivide_plot_base +
  template_plot_annotations()
subdivide_plot_no_annotation <- subdivide_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "7_2_parcelmap_subdiv.png"),
  subdivide_plot_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
ggplot2::ggsave(
  here(output_dir, "7_2_parcelmap_subdiv_no_annotation.png"),
  subdivide_plot_no_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
subdivide_plot_annotation
```
{{< pagebreak >}}

## Protected Areas: Top 30% Biodiversity Values 
Top 30% of biodiversity locations on Bowen Island, with gradient scale corresponding to relative priority for conservation. Protected Areas are visualized as an overlay on top of the Zonation priotization output. The percentage of top 30% biodiversity locations covered by Protected Areas is 28.3% 
```{r}
#### Preparing layers for plotting ####
# Biodiversity values layer 
rankmap <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project(bowen.biodiversity.webapp::project_crs)
rankmap_for_map <- rankmap %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_bt_rm <- rankmap %>%
  remove_by_quantile(0.7)
rankmap_bt_rm_for_map <-rankmap_bt_rm %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_mask <- rankmap_bt_rm %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
# Bowen entire area
bowen_island <- st_read(
  here("data-raw/datasets/bowen_island_shoreline_w_hutt.gpkg"),
  layer = "bowen_island_shoreline_w_hutt__bowen_islands"
)
# Protected Areas from JD
bowen_protectedareas_include <- bowen.biodiversity.webapp::bowen_protectedareas %>%
  filter(type != "Agricultural Land Reserve") # Remove ALR
# Protected Areas from Bowen Island Municipality
# TODO: figure out why there are two shapefiles / folders of protectedareas
bowen_protectedareas_2 <- st_read(here(
  "data-raw/datasets/bowen_island_protectedareas/BM_PROTECTED_AREAS.shp"
)) %>%
  filter(NAME != "Old Growth Management Area")
# JD protected areas is more complete, with smaller municipal parks, covenants, and park land exchanges
# Use JD protected areas instead of BM_PROTECTED_AREAS.shp
union_protectedareas <- bowen.biodiversity.webapp::bowen_protectedareas %>%
  st_make_valid() %>%
  st_union()

#### Statistics ####
bowen_protectedareas_rast <- union_protectedareas %>%
  vect() %>%
  project(rankmap_mask) %>%
  rasterize(rankmap_bt_rm, cover = TRUE)
n_cells_top30bv_protected <- (bowen_protectedareas_rast * rankmap_mask) %>%
  global("sum", na.rm = T)
n_cells_top30bv <- rankmap_mask %>% 
  global("sum", na.rm = T)
n_cells_top30bv_protected / n_cells_top30bv
# 0.2825755

# Check with polygon / polygon area calculations for full Bowen Island
sum(st_area(bowen_protectedareas_include)) / sum(st_area(bowen_island)) 
# 0.2149664
sum(st_area(bowen_protectedareas_2)) / sum(st_area(bowen_island)) 
# 0.17935

#### Plotting ####
protectedareas_colour <- "purple"

protectedareas_plot_base <- template_plot +
  geom_spatraster(data = rankmap_bt_rm_for_map) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "ag_GrnYl",
    limits = c(0,1),
    breaks = c(0,1),
    labels = c("Lower", "Higher"),
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Relative Biodiversity"
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_color() +
  geom_sf(
    data = union_protectedareas,
    aes(fill = protectedareas_colour, color = protectedareas_colour),
    alpha = 0.1,
    linewidth = 0.5
  ) +
  scale_fill_identity(
    name = "",
    breaks = c(protectedareas_colour),
    labels = c("Protected Areas"),
    guide = "legend"
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(protectedareas_colour),
    labels = c("Protected Areas"),
    guide = "legend"
  ) 
protectedareas_plot_annotations <- protectedareas_plot_base +
  template_plot_annotations()
protectedareas_plot_no_annotations <- protectedareas_plot_base + 
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "7_3_biod_vals_protected_areas.png"),
  protectedareas_plot_annotations,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "7_3_biod_vals_protected_areas_no_annotation.png"),
  protectedareas_plot_no_annotations,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
# Render for PDF
protectedareas_plot_annotations
```
{{< pagebreak >}}

## Private Land: Top 30% Biodiversity Values
Top 30% of biodiversity locations on Bowen Island, with gradient scale corresponding to relative priority for conservation. Private Lands are visualized as an overlay on top of the Zonation priotization output. Private lands cover 48.7% of Bowen Island. The percentage of top 30% biodiversity locations covered by Private Lands is 49.8%
```{r biod_vals_private_land}
#### Preparing layers for plotting ####
# Biodiversity values layer 
rankmap <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project(bowen.biodiversity.webapp::project_crs)
rankmap_for_map <- rankmap %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_bt_rm <- rankmap %>%
  remove_by_quantile(0.7)
rankmap_bt_rm_for_map <-rankmap_bt_rm %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_mask <- rankmap_bt_rm %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
# Bowen entire area
bowen_island <- st_read(
  here("data-raw/datasets/bowen_island_shoreline_w_hutt.gpkg"),
  layer = "bowen_island_shoreline_w_hutt__bowen_islands"
)
# Private Land
bowen_mask <- rast(here("output-data/bowen_mask.tif"))

bowen_parcelmap_union <- parcelmap_bowen %>%
  filter(OWNER_TYPE %in% c("Private", "Unclassified")) %>%
  st_make_valid() %>%
  st_union()

#### Statistics ####
# Overlay by raster
bowen_parcelmap_rast <- bowen_parcelmap_union %>%
  vect() %>%
  rasterize(rankmap_bt_rm, cover = TRUE)
n_cells_top30bv_privateland <- (bowen_parcelmap_rast * rankmap_mask) %>%
  global("sum", na.rm = T)
n_cells_top30bv <- rankmap_mask %>% 
  global("sum", na.rm = T)
n_cells_top30bv_privateland / n_cells_top30bv
# 0.490764 of top30bv is in private land, calc by rast weighted rast

# Check with polygon / polygon area calculations for full Bowen Island
sum(st_area(bowen_parcelmap_union)) / sum(st_area(bowen_island)) 
# 0.4865091 of Bowen Island area is private land

#### Plotting ####
properties_colour <- "brown"
privatelands_overlap_plot_base <- template_plot +
  geom_spatraster(data = rankmap_bt_rm_for_map) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "ag_GrnYl",
    limits = c(0,1),
    breaks = c(0,1),
    labels = c("Lower", "Higher"),
    guide = ggplot2::guide_colourbar(
      order = 1,
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Relative Biodiversity"
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_color() +
  geom_sf(
    data = bowen_parcelmap_union,
    aes(fill = properties_colour, color = properties_colour),
    alpha = 0.2,
    linewidth = 0.5
  ) +
  scale_fill_identity(
    name = "",
    breaks = c(properties_colour),
    labels = c("Private Land"),
    guide = "legend"
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(properties_colour),
    labels = c("Private Land"),
    guide = "legend"
  ) 
privatelands_overlap_plot_annotation <- privatelands_overlap_plot_base +
  template_plot_annotations()
privatelands_overlap_plot_no_annotation <- privatelands_overlap_plot_base +
  template_plot_remove()
ggplot2::ggsave(
  here(output_dir,"7_4_biodvals_private_land.png"),
  privatelands_overlap_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir,"7_4_biodvals_private_land_no_annotation.png"),
  privatelands_overlap_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
privatelands_overlap_plot_annotation
```
{{< pagebreak >}}

## Land Ownership / Authority: Top 30% Biodiversity Value
Aligning to grid cells of the relative biodiversity values, this map provides an overview of the ownership or authority over areas across Bowen Island. Private land entirely cover 36.2% of grid cells. Protected areas entirely cover 13.6% of grid cells. Other public lands, such as crown land, entirely cover 24.3% of grid cells. 25.9% of grid cells have some mix of private and public land categories. 

```{r land_ownership}
#### Preparing layers for plotting ####
# Biodiversity values layer 
rankmap <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project(bowen.biodiversity.webapp::project_crs)
rankmap_for_map <- rankmap %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_bt_rm <- rankmap %>%
  remove_by_quantile(0.7)
rankmap_bt_rm_for_map <-rankmap_bt_rm %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_mask <- rankmap_bt_rm %>%
  not.na() %>%
  classify(cbind(FALSE, NA))

# Bowen entire area
bowen_island <- st_read(
  here("data-raw/datasets/bowen_island_shoreline_w_hutt.gpkg"),
  layer = "bowen_island_shoreline_w_hutt__bowen_islands"
)

# Private Land
private_raster <- parcelmap_bowen %>%
  filter(OWNER_TYPE %in% c("Private", "Unclassified")) %>%
  bowen_rasterize() %>%
  project(rankmap_bt_rm) 
private_raster_for_map <- private_raster %>%
  project("EPSG: 3857") %>%
  higher_res_edges() %>%
  as.factor()

# Protected Areas from JD
protectedareas <- bowen.biodiversity.webapp::bowen_protectedareas %>%
  filter(type != "Agricultural Land Reserve") # Remove ALR
protectedareas_rast <- bowen_protectedareas_include %>%
  bowen_rasterize() %>%
  project(rankmap_bt_rm) %>% 
  subst(1, 2) %>%
  as.factor()
# Dissolve protected areas into one geometry
dissolved_protectedareas <- protectedareas %>%
  st_make_valid() %>%
  summarise() %>%
  st_cast() %>%
  st_buffer(1) 

# Public Land
# Crown Land
crown_valid <- crown %>% 
  st_snap(x = ., y = ., tolerance = 0.1) %>%
  st_make_valid() %>%
  st_transform(st_crs(dissolved_protectedareas))
notprotected_crown <- st_difference(crown_valid, dissolved_protectedareas) 
# Remove polygons that should not be included in notprotected areas 
# rowname 1 (Fairy Fen Natural Reserve), sliver
# rowname 74 (Seymour Bay Park), wrong polygon in the first place
notprotected_crown <- notprotected_crown[!rownames(notprotected_crown) %in% c("1","74"),]
notprotected_crown_rast <- notprotected_crown %>%
  bowen_rasterize() %>%
  project(rankmap_bt_rm) %>% 
  subst(1, 3) %>%
  as.factor()

# Combined Raster
# In a given cell: 
# If both Protected Areas and Crown Land, become Protected Area coded
# If Private Land, become Mixed coded
pub_prot_rast <- cover(protectedareas_rast, notprotected_crown_rast)
mixed_rast <- mask(pub_prot_rast, private_raster) %>%
  not.na(falseNA = TRUE) %>%
  subst(1, 4) %>%
  as.factor()
comb_rast <- cover(mixed_rast, pub_prot_rast) %>%
  cover(private_raster) %>%
  as.factor()
comb_rast_for_map <- comb_rast %>%
  project("EPSG: 3857") %>%
  higher_res_edges() %>%
  as.factor()
# 1 = private 
# 2 = protected areas
# 3 = crown land
# 4 = mixed 

#### Statistics ####
comb_rast %>% 
  summary() 
# 1   :1916  
# 2   : 718  
# 3   :1286  
# 4   :1372  
1916 + 718 + 1286 + 1372 # 5292
1916 / 5292 # 0.3620559
718 / 5292 # 0.1356765
1286 / 5292 # 0.2430083
1372 / 5292 # 0.2592593

#### Plotting ####
authority_factor_lvls <- c(1, 2, 3, 4)
authority_factor_cols <- c("brown", "purple", "lightgreen", "blue")
names(authority_factor_cols) <- authority_factor_lvls

authority_plot_base <- template_plot +
  tidyterra::geom_spatraster(
    data = comb_rast_for_map,
    aes(fill = layer),
    alpha = 0.3,
    na.rm = TRUE
  ) +
  scale_fill_manual(
    values = authority_factor_cols, 
    aesthetics = c("colour", "fill"),
    labels = c("Private", "Protected", "Public", "Mixed"),
    name = "",
    na.value = NA,
    na.translate = FALSE,
    guide = guide_legend(order = 1)
  ) +
  template_plot_overlay() +
  ggplot2::theme(
    legend.margin = margin(-9, 6, 6, 6),
    legend.key.width = ggplot2::unit(0.5, "cm"),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.spacing.y = ggplot2::unit(0, "lines"),
    legend.key.spacing.x = ggplot2::unit(0, "cm"),
    legend.direction = "vertical",
    legend.box = "vertical",
    legend.box.background = element_rect(fill = "white", colour = "black"),
    legend.box.margin = margin(10, 5, 5, 5),
    legend.position = c(.05, .95),
    legend.justification = c("left", "top"),
    legend.box.just = "left"
  ) 
  
authority_plot_annotations <- authority_plot_base +
  template_plot_annotations()
authority_plot_no_annotations <- authority_plot_base +
  template_plot_remove()
ggplot2::ggsave(
  here(output_dir,"7_5_authority_plot.png"),
  authority_plot_annotations,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir,"7_5_authority_plot_no_annotations.png"),
  authority_plot_no_annotations,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
authority_plot_annotations
```

{{< pagebreak >}}

## Example Candidate Locations for Protected Areas 
Mapping optimal Crown land for reaching 30x30 targets, using the conservation values analysis and existing protected areas. This output considers connectivity by applying boundary penalties, which prioritizes shorter boundaries relative to area. Currently, about 20% of Bowen Island is under some protection.
```{r}
#### Loading layers ####
bowen_pa <- here("output-data/7_protected_areas/existing_protected_areas.gpkg") %>%
  st_read()
bowen_ogma <- ogma %>%
  st_transform(st_crs(bowen_pa))
bowen_new_pa <- here("output-data/7_protected_areas/new_protected_areas.gpkg") %>%
  st_read() %>%
  st_transform(st_crs(bowen_pa))
#### Statistics ####
# TODO: calculate % of orange protential protected areas coverage of bowen island

#### Plotting ####
protected_colour <- "purple"
ogma_colour <- "#a1d76a"
new_colour <- "orange"
protectedareas_example_plot_base <- template_plot +
  geom_sf(data = bowen_pa, 
          aes(fill = protected_colour, color = protected_colour), 
          alpha = 0.1,
          linewidth = 0.5) +
  geom_sf(data = bowen_ogma, 
          aes(fill = ogma_colour, color = ogma_colour), 
          alpha = 0.1,
          linewidth = 0.5) +
  geom_sf(data = bowen_new_pa, 
          aes(fill = new_colour, color = new_colour), 
          alpha = 0.1,
          linewidth = 0.5) +
  scale_fill_identity(name = "",
                      breaks = c(protected_colour, ogma_colour, new_colour),
                      labels = c("Current Protected", "Old Growth Management Areas", "Proposed Protected"),
                      guide = guide_legend(order = 1)
  ) +
  scale_color_identity(name = "",
                       breaks = c(protected_colour, ogma_colour, new_colour),
                       labels = c("Current Protected", "Old Growth Management Areas", "Proposed Protected"),
                       guide = guide_legend(order = 1)
  ) +
  template_plot_overlay() +
  ggplot2::theme(
    legend.margin = margin(-9, 6, 6, 6),
    legend.key.width = ggplot2::unit(0.5, "cm"),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.spacing.y = ggplot2::unit(0, "lines"),
    legend.key.spacing.x = ggplot2::unit(0, "cm"),
    legend.direction = "vertical",
    legend.box = "vertical",
    legend.box.background = element_rect(fill = "white", colour = "black"),
    legend.box.margin = margin(10, 5, 5, 5),
    legend.position = c(.05, .95),
    legend.justification = c("left", "top"),
    legend.box.just = "left"
  ) 
pa_example_plot_annotations <- protectedareas_example_plot_base +
  template_plot_annotations()
pa_example_plot_no_annotations <- protectedareas_example_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir,"7_6_candidate_protectedareas.png"),
  pa_example_plot_annotations,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir,"7_6_candidate_protectedareas_no_annotations.png"),
  pa_example_plot_no_annotations,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
# Render for PDF
pa_example_plot_annotations
```

# Appendix
## Bowen Island iNaturalist Observations
This map shows the number of iNaturalist observations per 100 m by 100 m cell on Bowen Island. Observations have been up to date as of September 2nd, 2025.
```{r inaturalist}
#### Creating sf object from all iNaturalist observations on Bowen Island ####
# Updated as of 2025/09/02
# Load records
bowen_inat_raw <- st_read(
  here("data-raw/datasets/inat/observations-610962.csv"), 
  options=c("X_POSSIBLE_NAMES=longitude","Y_POSSIBLE_NAMES=latitude")
)
bowen_inat <- bowen_inat_raw %>%
  st_set_crs(4326) %>%
  dplyr::select(!c("private_longitude", "private_latitude"))

#### Creating raster with iNaturalist observation counts per cell ####
# Matches the Zonation raster cells
# Load Bowen Mask to create raster
bowen_mask <- rast(here("output-data/bowen_mask.tif"))
# Convert sf to vect
bowen_inat_vect <- bowen_inat %>%
  vect() %>%
  project(bowen_mask)
# Count points in each pixel
bowen_inat_count_rast <- terra::rasterize(bowen_inat_vect, bowen_mask, fun = "count") %>%
  mask(bowen_mask) %>% # Mask to cells with Zonation values
  project("EPSG: 3857")
bowen_inat_count_rast_for_map <- bowen_inat_count_rast %>%
  higher_res_edges()

#### Plotting #### 
colours_vect <- c('#feebe2','#fcc5c0','#fa9fb5','#f768a1','#dd3497','#ae017e','#7a0177')
colour_ramp <- colorRamp(colours_vect)
colour_breaks <- c(1, 4, 10, 50, 200, 700, 3000)
colour_labels <- c("1 - 4", "4 - 10", "10 - 50", "50 - 200", "200 - 700", "700 - 3000", "3000 - 10000")
inaturalist_plot_base <- template_plot +
  geom_spatraster(data = bowen_inat_count_rast_for_map) +
  scale_fill_stepsn(
    name = "iNaturalist Obs.",
    colours = colours_vect,
    na.value = NA,
    transform = "log10", 
    breaks = colour_breaks,
    labels = colour_labels,
    guide = guide_legend(order = 1)
  ) +
  template_plot_overlay() +
  ggplot2::theme(
    legend.margin = margin(-9, 6, 6, 6),
    legend.key.width = ggplot2::unit(0.5, "cm"),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.spacing.y = ggplot2::unit(0, "lines"),
    legend.key.spacing.x = ggplot2::unit(0, "cm"),
    legend.direction = "vertical",
    legend.box = "vertical",
    legend.box.background = element_rect(fill = "white", colour = "black"),
    legend.box.margin = margin(20, 5, 5, 5),
    legend.position = c(.05, .95),
    legend.justification = c("left", "top"),
    legend.box.just = "left"
  ) 

inaturalist_plot_annotations <- inaturalist_plot_base + 
  template_plot_annotations()
inaturalist_plot_no_annotations <- inaturalist_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "8_1_inaturalist.png"),
  inaturalist_plot_annotations,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)
ggplot2::ggsave(
  here(output_dir, "8_1_inaturalist_no_annotations.png"),
  inaturalist_plot_no_annotations,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)
# Render for PDF
inaturalist_plot_annotations
```


<!-- ## Habitat Layers: Sensitive Ecosystem Inventory & Human Footprint -->
<!-- ## Focal Vertebrate Species Layers  -->
<!-- ## Provincial Conservation Status Ranks -->
<!-- ## BC Red, Blue, Yellow Lists -->
<!-- ## COSEWIC Status Domain Values -->
<!-- ## IUCN Red List Categories -->
<!-- ## Final Methods Summary -->




