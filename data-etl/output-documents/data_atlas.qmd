---
title: "Bowen Island Biodiversity Data Atlas"
subtitle: "Species Distribution, Habitat Mapping, and Conservation Priorities"
author:
  - name: "Jay Matsushiba"
    affiliation: "Simon Fraser University"
  - name: "Wendy Palen"
    affiliation: "Simon Fraser University"
  - name: "Tom Sisk"
    affiliation: "Simon Fraser University"
date: "2025/05/02"
format:
  pdf:
    number-sections: true
    include-in-header:
      - "header.tex"
    toc: true
    documentclass: report
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, # Don't show code
  warning = FALSE, # Don't show warnings
  message = FALSE, # Don't show messages
  results = 'hide', # Hide text output
  fig.show = 'asis', # Show plots
  fig.width = 6, # Figure width in inches
  fig.height = 7.5, # Figure height in inches
  out.width = "\\linewidth" # Scale to full width
)
```

```{r setup, echo=F}
devtools::load_all()
# library(bowen.biodiversity.data, quietly = T)
#### Utilities ####
library(here, quietly = T)
library(dplyr, quietly = T)
library(magrittr, quietly = T)
library(stringr, quietly = T)
library(glue, quietly = T)
#### Spatial ####
library(sf, quietly = T)
library(terra, quietly = T)
library(tidyterra, quietly = T)
#### Tabular Data ####
library(readxl)
library(googlesheets4)
#### Plotting ####
library(ggplot2, quietly = T)
library(ggnewscale, quietly = T)
library(RColorBrewer, quietly = T)
library(randomcoloR, quietly = T)

#### Use planar coordinates ####
sf_use_s2(FALSE)

#### Output directories ####
output_dir <- here("output-figures/data-atlas")
if (!dir.exists(output_dir)) {
  dir.create(output_dir)
}

#### Define plot extent ####
bowen_mask <- rast(here("data/bowen_mask.tif")) %>%
  project('epsg:3857') # Project to Web Mercator for basemap
bowen_mask_ext <- bowen_mask %>%
  ext()

#### Base map for plots ####
# basemap_for_plot <- basemaps::basemap_terra(ext = raster_layer, map_service = "carto", map_type = "voyager")
basemap_for_plot <- basemaps::basemap_terra(
  ext = bowen_mask,
  map_service = "maptiler",
  map_type = "backdrop",
  map_token = "baL4WLstSFqSHP2fnYrE"
) %>% mask(vect(bowen_ocean_sf), inverse = T)

#### Consistent elements for plots ####
bowen_ocean_linewidth <- 0.5
bowen_ocean_colour <- "#dbdbdc"
trails_colour <- "brown"
roads_colour <- "darkgrey"
caption <- glue(
  "Map created: {date()}. Palen Lab."
)

plot_width = 9
plot_height = 12
plot_res = 300

template_plot <- ggplot2::ggplot() +
  ggplot2::theme_bw() +
  tidyterra::geom_spatraster_rgb(data = basemap_for_plot) +
  ggplot2::scale_x_continuous(
    expand = c(0, 0),
    limits = c(bowen_mask_ext[1], bowen_mask_ext[2])
  ) +
  ggplot2::scale_y_continuous(
    expand = c(0, 0),
    limits = c(bowen_mask_ext[3], bowen_mask_ext[4])
  ) +
  ggplot2::theme(
    axis.text.y = ggplot2::element_text(
      angle = 90,
      vjust = 1,
      hjust = 0.5
    ),
    legend.position = "bottom",
    legend.title = ggplot2::element_text(size = 10),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.width = ggplot2::unit(1.5, "cm"),
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.box.margin = margin(1, 1, 1, 1),
    legend.background = element_rect(fill = "transparent", color = NA),
    plot.margin = unit(c(0.5, 0, 0, 1), "cm"),
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = bowen_ocean_colour, color = NA),
    panel.grid = element_blank()
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_colour()

template_plot_overlay <- function() {
  list(
    ggnewscale::new_scale_fill(),
    ggnewscale::new_scale_colour(),
    geom_sf(
      data = bowen_ocean_sf,
      linewidth = bowen_ocean_linewidth,
      fill = NA
    ),
    geom_sf(
      data = bowen_trails,
      linewidth = 0.3,
      aes(color = trails_colour)
    ),
    geom_sf(
      data = bowen_roads,
      linewidth = 0.5,
      aes(color = roads_colour)
    ),
    scale_colour_identity(
      name = "",
      breaks = c(trails_colour, roads_colour),
      labels = c("Trails", "Roads"),
      guide = "legend"
    )
  )
}

template_plot_annotations <- function() {
  list(
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ),
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      pad_x = unit(0.2, "in"),
      pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    ),
    theme(
      legend.key = element_rect(fill = "white", color = NA)
    )
  )
}

template_plot_remove <- function() {
  list(
    theme(
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.line = element_blank(),
      axis.ticks = element_blank(),
      panel.background = element_rect(fill = "transparent", color = NA),
      panel.border = element_blank()
    )
  )
}

#### Input data layers ####
sdm_url <- "https://docs.google.com/spreadsheets/d/1IGFwkr9LidcZwbzOJJGSEXLsmpKp0a9gBs65EY-H1xw/edit?usp=sharing"
habitats_url <- "https://docs.google.com/spreadsheets/d/1yDKw4r3tbXYivwtxbbfxc-pYSbtbj_o2ee1pwlNCOO4/edit?usp=drive_link"
sheet_date <- "2025-06-30"

#### CREATE DATAFRAME FOR INPUT LAYERS ####
# TODO: raster paths need to be fixed now
# Read from Google Sheets
habitats_df <- read_sheet(habitats_url, sheet = sheet_date) %>%
  # New filepath for layers
  mutate(path = stringr::str_replace_all(
    path,                                 
    "/home/jay/Programming_Projects/bowen.biodiversity.webapp/inst/extdata", 
    "/home/jay/Programming_Projects/Palen-Lab/bowen.biodiversity.webapp/data-etl/output-data")
  ) 
habitats_df$weight <- habitats_df$weight / nrow(habitats_df)
sdm_df <- read_sheet(sdm_url, sheet = sheet_date) %>%
  # New filepath for layers
  mutate(path = stringr::str_replace_all(
    path,                                 
    "/home/jay/Programming_Projects/bowen.biodiversity.webapp/inst/extdata/bowen_sdm", 
    "/home/jay/Programming_Projects/Palen-Lab/bowen.biodiversity.webapp/data-etl/output-data/sdm")
  ) 
sdm_df$weight <- sdm_df$weight / nrow(sdm_df)
# Bind all input layers together
layers_df <- sdm_df %>%
  select(colnames(habitats_df)) %>% # Select common columns
  bind_rows(habitats_df) %>%
  filter(weight > 0)
presence_threshold <- 0.7

# Prepare raster function 
prep_rast <- function(path) {
  path %>%
    unlist() %>%
    rast() %>%
    project("EPSG: 3857") %>% 
    higher_res_edges()
}
```

# Overview

## Introduction

This Data Atlas presents a comprehensive assessment of biodiversity values across Bowen Island, British Columbia. The analysis integrates species distribution models for 193 vertebrate species, habitat mapping data from multiple sources, and conservation prioritization results to identify areas of high ecological significance.

This work was developed through a collaboration between Simon Fraser University's Palen Lab and Bowen Island Conservancy, with the goal of supporting evidence-based conservation planning and land use decision-making. The maps and data presented here synthesize information from government datasets, scientific research, local expertise, and community observations collected over several decades.

The atlas is organized into sections covering: (1) species distributions and richness patterns, (2) habitat diversity and extent, (3) integrated biodiversity values, and (4) conservation priorities and threat assessments.

### Disclaimer

The maps and analyses in this atlas represent our best understanding of Bowen Island's biodiversity based on available data as of May 2025. However, users should be aware of the following limitations:

- **Data gaps and omissions**: Not all species or habitats on Bowen Island have been systematically surveyed. Some areas, particularly private lands and remote locations, may have limited observation data.

- **Model uncertainty**: Species distribution models are statistical predictions based on environmental conditions and observation records. Actual species presence or absence at any specific location may differ from model predictions.

- **Accuracy and resolution**: Spatial data layers vary in their accuracy, resolution, and currency. Habitat boundaries and classifications should be verified through field surveys for site-specific applications.

- **Temporal changes**: Ecological conditions change over time due to natural processes, climate change, and human activities. Maps reflect conditions at the time of data collection and may not represent current conditions.

- **Analytical limitations**: Conservation prioritization analyses depend on weighting schemes, input data selection, and algorithmic assumptions that involve subjective choices.

- **Legal**: This atlas is not a legal document and should not be used as a definitive reference for property boundaries, zoning regulations, land ownership, development restrictions, or other legal or regulatory matters. Consult official municipal records and regulatory authorities for legal determinations.

This atlas is intended as a planning tool to inform decision-making, not as a definitive or comprehensive inventory. Field verification and expert consultation are recommended for site-specific assessments and conservation actions.

### Contact Information

For questions, corrections, or additional information about this Data Atlas:

**Primary Contact:**
Jay Matsushiba

Email: hello@jmatsushiba.com

**Project Information:**
Palen Lab, Simon Fraser University

GitHub: https://github.com/Palen-Lab/bowen.biodiversity.webapp

## Acknowledgements

This work was made possible through contributions from many individuals and organizations:

**Contributors:**
- Michael Tylo - Data analysis and processing

- Maya Persam - Workshop facilitation

- Kyra Rolfe - Workshop facilitation

- Valerie Kwok - Workshop facilitation

**Data Providers:**
- Bowen Heron Watch

- Alan Whitehead Consulting

- Metro Vancouver

- BC Government

- iNaturalist and eBird communities

See the project documentation for complete citations and acknowledgements.

{{< pagebreak >}}

## Transportation Network, Bowen Island
Base Bowen Island map with hillshade, roads, and trails. 
```{r basic}
basic_plot <- template_plot +
  # Can add ggplot2 elements in between
  template_plot_overlay() +
  template_plot_annotations()

basic_plot_no_annotations <- template_plot +
  template_plot_overlay() +
  template_plot_remove()

ggplot2::ggsave(
  here(output_dir, "1_1_basic_map.png"),
  basic_plot,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)

ggplot2::ggsave(
  here(output_dir, "1_1_basic_map_no_annotations.png"),
  basic_plot_no_annotations,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)

basic_plot
```

# Focal Vertebrate Species
## Total Species Richness
Based on >presence_threshold probability of occurrence in Species Distribution Models.
```{r species_richness}
#### Preparing Raster #### 
# List SDMs filepaths
SDM_filepaths <- sdm_df[
  sdm_df$category %in% c("Bird", "MammalSmall", "Amphibian", "Reptile"),
  "path"
] 
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create species richness SDM
total_richness <- sdm_to_species_richness(
  SDM_stack = SDM_stack,
  presence_threshold = presence_threshold
) 
# Save raster
writeRaster(
  total_richness,
  here("output-data/2_species/total_richness.tif"),
  overwrite = T
)
# Prepare raster for plot
total_richness <- total_richness %>%
  project("EPSG: 3857") %>% 
  higher_res_edges()
#### Plotting ####
# Base plot
total_richness_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = total_richness) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "ag_GrnYl",
    # limits = c(0,1),
    # breaks = c(0, 0.5, 1),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Richness"
  ) +
  template_plot_overlay() 
# Annotated plot
total_richness_plot_annotations <- total_richness_plot_base + 
  template_plot_annotations()
# No annotation plot
total_richness_plot_no_annotations <- total_richness_plot_base +
  template_plot_remove()
# Save plot
ggplot2::ggsave(
  here(output_dir, "2_5_total_species_richness.png"),
  total_richness_plot_annotations,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)
ggplot2::ggsave(
  here(output_dir, "2_5_total_species_richness_no_annotations.png"),
  total_richness_plot_no_annotations,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)
# Render in PDF
total_richness_plot_annotations
```
## Total Species Diversity
## TODO: Bird Species Richness
Based on >presence_threshold probability of occurrence in Species Distribution Models.
```{r, eval=F}
# Create species richness plots:
## Each species is marked present in a cell, if they are above a certain
## threshold of probability in the input SDMs.

# Create SDM stack from paths
SDM_stack <- sdm_df[sdm_df$category == "Bird", "path"] %>%
  lapply(rast) %>%
  rast()
# Create species richness SDM
bird_richness <- sdm_to_species_richness(
  SDM_stack = SDM_stack,
  presence_threshold = presence_threshold
)
writeRaster(
  bird_richness,
  here("inst/extdata/2_species/birds_richness.tif"),
  overwrite = T
)

title <- "Bird Species Richness"
subtitle <- paste0()

bird_richness_plot <- bowen_map(
  raster_layer = bird_richness,
  title = title,
  subtitle = subtitle,
  caption = caption,
  legend_label = "Richness"
) +
  geom_sf(
    data = bowen_ocean_sf,
    linewidth = bowen_ocean_linewidth,
    fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(
    data = bowen_trails,
    linewidth = 0.3,
    aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(
    data = bowen_roads,
    linewidth = 0.5,
    aes(color = roads_colour)
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(trails_colour, roads_colour),
    labels = c("Trails", "Roads"),
    guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "in"),
    pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )

ggplot2::ggsave(
  here(
    output_dir,
    "/",
    paste0(Sys.Date(), "_2_1_bird_species_richness_map.png")
  ),
  bird_richness_plot,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
```

## Small Mammal Species Richness
## Amphibian & Reptile Species Richness
## Threatened & Endangered Species Richness

# Habitats
## Freshwater Habitats: Streams, Wetlands, Riparian Corridors 
Freshwater features on Bowen Island, derived from layers provided by Alan Whitehead (2025).
```{r fw_habitats}
#### Prepare raster for plots ####
fw_df <- layers_df[layers_df$category == "Freshwater", ]
# Color ramp
fw_df$colour <- RColorBrewer::brewer.pal(nrow(fw_df), "YlGnBu")

# Prepare streams rast
streams_rast <- fw_df[fw_df$name == "Streams", "path"] %>%
  unlist() %>%
  rast() %>%
  not.na() %>%
  classify(cbind(FALSE, NA)) %>%
  project("EPSG: 3857") %>% 
  higher_res_edges()

#### Plotting ####
fw_plot_base <- template_plot +
  tidyterra::geom_spatraster(
    data = prep_rast(fw_df[fw_df$name == "Lakes", "path"]),
    aes(fill = layer)
  ) +
  scale_fill_gradientn(
    name = "",
    labels = "Freshwater Lakes",
    colours = unlist(fw_df[fw_df$name == "Lakes", "colour"]),
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(
    data = prep_rast(fw_df[fw_df$name == "Ponds", "path"]),
    aes(fill = layer)
  ) +
  scale_fill_gradientn(
    name = "",
    labels = "Freshwater Ponds",
    colours = unlist(fw_df[fw_df$name == "Ponds", "colour"]),
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(
    data = prep_rast(fw_df[fw_df$name == "Riparian", "path"]),
    aes(fill = layer)
  ) +
  scale_fill_gradientn(
    name = "",
    labels = "Riparian",
    colours = unlist(fw_df[fw_df$name == "Riparian", "colour"]),
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(
    data = prep_rast(fw_df[fw_df$name == "Wetlands", "path"]),
    aes(fill = layer)
  ) +
  scale_fill_gradientn(
    name = "",
    labels = "Wetlands",
    colours = unlist(fw_df[fw_df$name == "Wetlands", "colour"]),
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = streams_rast, aes(fill = layer)) +
  scale_fill_gradientn(
    name = "",
    labels = "Streams",
    colours = unlist(fw_df[fw_df$name == "Streams", "colour"]),
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
    ggplot2::theme(
    legend.margin = margin(-26, 6, 6, 6),
    legend.key.width = ggplot2::unit(0.5, "cm"),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.spacing.y = ggplot2::unit(0, "lines"),
    legend.key.spacing.x = ggplot2::unit(0, "cm"),
    legend.direction = "vertical",
    legend.box = "vertical",
    legend.box.background = element_rect(fill = "white", colour = "black"),
    legend.box.margin = margin(20, 5, 5, 5),
    legend.position = c(.05, .95),
    legend.justification = c("left", "top"),
    legend.box.just = "left"
  ) 

fw_plot_annotation <- fw_plot_base +
  template_plot_annotations()
fw_plot_no_annotation <- fw_plot_base +
  template_plot_remove()

# Save plots
ggplot2::ggsave(
  here(output_dir, "3_1_bowen_water_map_annotation.png"),
  fw_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "3_1_bowen_water_map_no_annotation.png"),
  fw_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
```

## Freshwater Habitats Richness
Freshwater features on Bowen Island, derived from layers provided by Alan Whitehead (2025).
```{r fw_habitat_richness}
#### Prepare raster for plots ####
fw_rast_stack <- layers_df[layers_df$category == "Freshwater", "path"] %>%
  prep_rast()
fw_richness <- fw_rast_stack %>%
  lapply(not.na) %>%
  lapply(function(x) {
    classify(x, cbind(FALSE, NA))
  }) %>%
  rast() %>%
  sum(na.rm = T)
writeRaster(
  fw_richness,
  here("output-data/3_habitats/fw_richness.tif"),
  overwrite = T
)
#### Plotting ####
fw_richness_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = fw_richness) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "Mako",
    # limits = c(0,1),
    # breaks = c(0, 0.5, 1),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Freshwater Habitat Richness"
  ) 
fw_richness_plot_annotation <- fw_richness_plot_base +
  template_plot_annotations()
fw_richness_plot_no_annotation <- fw_richness_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "3_2_bowen_water_richness_map.png"),
  fw_richness_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "3_2_bowen_water_richness_map_no_annotation.png"),
  fw_richness_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
fw_richness_plot_annotation
```

## Old & Large Forest: Old Forest, Old Growth Management Areas
## Other Habitats: Sensitive Ecosystem Inventory
## Total Habitat Richness: Number of Habitat Types by Location
Total number of habitats found in each cell of the map. Habitats derived from Metro Vancouver Sensitive Ecosystem Inventory (2021), Terrestrial Ecosystem Mapping (2019), and Alan Whitehead (2025).
```{r habitat_richness}
#### Prepare raster for plots ####
habitat_stack <- habitats_df %>%
  filter(category != "Human Disturbance") %>%
  select(path) %>%
  prep_rast()
# Sum habitat stack
habitat_richness <- habitat_stack %>% sum(na.rm = T)
writeRaster(
  habitat_richness,
  here("output-data/3_habitats/total_habitat_richness.tif"),
  overwrite = T
)
#### Plotting ####
habitats_plot_base <- template_plot +
  tidyterra::geom_spatraster(
    data = habitat_richness
  ) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "ag_GrnYl",
    # limits = c(0,1),
    # breaks = c(0, 0.5, 1),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Richness"
  ) +
  template_plot_overlay()
habitats_plot_annotation <- habitats_plot_base +
  template_plot_annotations()
habitats_plot_no_annotation <- habitats_plot_base +
  template_plot_remove()
# Saving plot
ggplot2::ggsave(
  here(output_dir, "3_5_bowen_habitat_richness_map.png"),
  habitats_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "3_5_bowen_habitat_richness_map_no_annotation.png"),
  habitats_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
habitats_plot_annotation
```

# Values 
## Biodiversity Value: Species & Habitats Combined
Zonation5 Prioritization Algorithm of Locations on Bowen Island. Environmental layers (n = 33) and species layers (n = 195).
```{r}
# Biodiversity values layer 
rankmap <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project("EPSG: 3857") 
rankmap_for_map <- rankmap %>%
  higher_res_edges()

# Base plot 
combined_biodiversity_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = rankmap_for_map) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "ag_GrnYl",
    # limits = c(0,1),
    # breaks = c(0, 0.5, 1),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Conservation Value"
  ) +
  template_plot_overlay()

# With annotations
combined_biodiversity_plot <- combined_biodiversity_plot_base +
  template_plot_annotations()

# Without annotations and axis 
combined_biodiversity_plot_no_annotations <- combined_biodiversity_plot_base +
  template_plot_remove()

# Save plot
ggplot2::ggsave(
  here(output_dir, "4_1_combined_biodiversity_values.png"),
  combined_biodiversity_plot,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)
ggplot2::ggsave(
  here(output_dir, "4_1_combined_biodiversity_values_no_annotations.png"),
  combined_biodiversity_plot_no_annotations,
  device = ragg::agg_png,
  width = plot_width,
  height = plot_height,
  units = "in",
  res = plot_res
)

# Render in PDF
combined_biodiversity_plot
```

## Top 30% Biodiversity Value
Top 30% of biodiversity locations on Bowen Island. Zonation5 Prioritization Algorithm of Locations on Bowen Island. Environmental layers (n = 33)  with species layers (n = 195).
```{r}
#### Prepare raster for plotting #### 
rankmap_top30_lowres <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project("EPSG: 3857") %>% 
  remove_by_quantile(0.7) 
rankmap_top30 <- rankmap_top30_lowres %>%
  higher_res_edges() 
rankmap_mask <- rankmap_top30_lowres %>%
  not.na() %>%
  classify(cbind(FALSE, NA))

#### Plotting ####
top_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = rankmap_top30) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "ag_GrnYl",
    limits = c(0,1),
    breaks = c(0, 0.5, 1),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Relative Biodiversity"
  ) +
  template_plot_overlay()
top_plot_annotation <- top_plot_base +
  template_plot_annotations()
top_plot_no_annotation <- top_plot_base +
  template_plot_remove()
# Save plots 
ggplot2::ggsave(
  here(output_dir,"5_1_top_30_biodiversity_values.png"),
  top_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir,"5_1_top_30_biodiversity_values_no_annotation.png"),
  top_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
top_plot_annotation
```


# Threats
## Human Disturbance: Continuous
Continuous map of human disturbance on Bowen Island.
```{r human_disturbance_continuous}
#### Prepare raster for plotting ####
disturbed <- here("output-data/habitats/bowen_human_footprint.tif") %>%
  prep_rast()
#### Plotting ####
disturb_cont_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = disturbed) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "Inferno",
    # limits = c(0,1),
    # breaks = c(0, 0.5, 1),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Disturbance"
  ) +
  template_plot_overlay()
disturb_cont_plot_annotation <- disturb_cont_plot_base +
  template_plot_annotations()
disturb_cont_plot_no_annotation <- disturb_cont_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "4_2_humandisturbance_continuous.png"),
  disturb_cont_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "4_2_humandisturbance_continuous_no_annotation.png"),
  disturb_cont_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
# Render for PDF
disturb_cont_plot_annotation
```
## Human Disturbance: Top 30% Biodiversity Value 
Top 30% of biodiversity locations on Bowen Island, with scale corresponding to relative human disturbance. 0% of top biodiversity locations are considered intact. 0.4% of top biodiversity locations considered to be less disturbed. 61.3% of top biodiversity cells are considered moderately disturbed. 35.5% of top biodiversity locations are highly disturbed. Citation: Kristen Hirsh-Pearson, Chris J. Johnson, Richard Schuster, Roger D. Wheate, and Oscar Venter. 2022. Canadaâ€™s human footprint reveals large intact areas juxtaposed against areas under immense anthropogenic pressure. FACETS. 7: 398-419."
```{r human_disturbance_top30}
#### Prepare layers for plots ####
# Biodiversity values layer 
rankmap <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project(bowen.biodiversity.webapp::project_crs)
rankmap_for_map <- rankmap %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_bt_rm <- rankmap %>%
  remove_by_quantile(0.7)
rankmap_bt_rm_for_map <-rankmap_bt_rm %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_mask <- rankmap_bt_rm %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
# Human Footprint (classified)
bowen_hfp_class <- here("output-data/habitats/bowen_human_footprint_recl.tif") %>%
  rast() %>%
  project(rankmap) %>%
  as.factor()
bowen_hfp_low <- bowen_hfp_class %>%
  classify(cbind(3, NA)) %>%
  classify(cbind(2, NA)) %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
bowen_hfp_med <- bowen_hfp_class %>%
  classify(cbind(3, NA)) %>%
  classify(cbind(1, NA)) %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
bowen_hfp_high <- bowen_hfp_class %>%
  classify(cbind(2, NA)) %>%
  classify(cbind(1, NA)) %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
#### Statistics ####
bowen_hfp_top <- mask(bowen_hfp_class, rankmap_mask) %>%
  as.factor()
# overlap with each category (low, medium, high)
hfp_low_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_low) %>%
  round(3)
# 0.004
hfp_med_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_med) %>%
  round(3)
# 0.613
hfp_high_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_high) %>%
  round(3)
# 0.355
hfp_cont <- here("output-data/habitats/bowen_human_footprint.tif") %>%
  rast() %>%
  project(rankmap_mask) 
hfp_top30 <- hfp_cont %>%
  mask(rankmap_mask) %>%
  project("EPSG: 3857") %>% 
  higher_res_edges()
#### Plotting ####
max_hfp <- global(hfp_cont, fun = "max", na.rm = T) %>% unlist()
min_hfp <- global(hfp_cont, fun = "min", na.rm = T) %>% unlist()

hfp_biod_vals_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = hfp_top30) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "Inferno",
    limits = c(min_hfp, max_hfp),
    breaks = c(min_hfp, max_hfp),
    labels = c("Lower", "Higher"),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Disturbance"
  ) +
  template_plot_overlay()
hfp_biod_vals_plot_annotation <- hfp_biod_vals_plot_base +
  template_plot_annotations()
hfp_biod_vals_plot_no_annotation <- hfp_biod_vals_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "4_3_humandisturbance_top30bv.png"),
  hfp_biod_vals_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "4_3_humandisturbance_top30bv_no_annotation.png"),
  hfp_biod_vals_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
# Render for PDF
hfp_biod_vals_plot_annotation
```


## Wildfire Vulnerability Index: Continuous
Index of Vulnerability to Fire. This is not an assessment of the probability or behaviour of the fire. The intention of this index is to describe the relative vulnerability to biodiversity loss due to fire, under a scenario where the habitats burn. The three major components of this vulnerability index are slope, aspect, and fuel.
```{r}
#### Preparing raster for plotting #### 
fire_index_mp <- rast(here("output-data/6_threats/fire_index_40m.tif")) %>%
  project("EPSG: 3857") %>%
  terra::subst(4294967296, NA) %>% # Max value should be NA
  terra::scale_linear()
#### Plotting ####
# TODO: change colour palette from cool to warm
fire_plot_base <- template_plot +
  tidyterra::geom_spatraster(data = fire_index_mp) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "Batlow",
    rev = FALSE,
    limits = c(0,1),
    breaks = c(0,1),
    labels = c("Low", "High"),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Fire Vul. Index"
  ) +
  template_plot_overlay()
fire_plot_annotation <- fire_plot_base + 
  template_plot_annotations()
fire_plot_no_annotation <- fire_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "6_1_fire_vulnerability_index.png"),
  fire_plot_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
ggplot2::ggsave(
  here(output_dir, "6_1_fire_vulnerability_index_no_annotation.png"),
  fire_plot_no_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
# Render for PDF
fire_plot_annotation
```

## Wildfire Vulnerability Index: Top 30% Biodiversity Value and Top 30% WVI
26.3% of top 30% biodiversity values are within the top 30% of wildfire vulnerability index values. 

```{r}
#### Preparing raster for plotting #### 
top30_wvi <- rast(here("output-data/6_threats/fire_index_40m.tif")) %>%
  project("EPSG: 3857") %>%
  terra::subst(4294967296, NA) %>% # Max value should be NA
  terra::scale_linear() %>% 
  remove_by_quantile(0.7) 

rankmap_top30_lowres <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project("EPSG: 3857") %>% 
  remove_by_quantile(0.7) 
rankmap_top30 <- rankmap_top30_lowres %>%
  higher_res_edges() 
rankmap_mask <- rankmap_top30_lowres %>%
  not.na() %>%
  classify(cbind(FALSE, NA))

rankmap_mask_re <- rankmap_mask %>% 
  resample(top30_wvi) 
grey_rast <- rankmap_mask_re %>%
  higher_res_edges() %>%
  as.factor()
fire_biod_val <- mask(top30_wvi, rankmap_mask_re)

# Calculate statistics
top30_wvi_resamp <- top30_wvi %>%
  resample(rankmap_mask, method = "average") %>%
  mask(rankmap_mask)
top30_wvi_resamp %>% 
  terra::not.na() %>%
  values() %>%
  sum()
# 426
rankmap_mask %>% 
  terra::not.na() %>%
  values() %>%
  sum()
# 1621
426 / 1621
# 0.2628007 
# This proportion of top 30% biodiversity values are within the top 30% of wildfire vulnerability index values. 

#### Plotting ####
fire_biod_val_plot_base <- template_plot +
  tidyterra::geom_spatraster(
    data = grey_rast
  ) +
  scale_fill_manual(
    values = c("grey40"),           
    labels = c(""),          
    na.value = NA,                  
    na.translate = FALSE,
    guide = ggplot2::guide_legend(
      title.position = "top"
    ),
    name = "Outside Top 30% WVI"
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_colour() +
  tidyterra::geom_spatraster(data = fire_biod_val) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "Batlow",
    rev = FALSE,
    limits = c(0,1),
    breaks = c(0,1),
    labels = c("Low", "High"),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
    ),
    name = "Wildfire Vul. Index"
  ) +
  template_plot_overlay()
fire_biod_val_plot_annotation <- fire_biod_val_plot_base + 
  template_plot_annotations()
fire_biod_val_plot_no_annotation <- fire_biod_val_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "6_2_wvi_top30.png"),
  fire_biod_val_plot_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
ggplot2::ggsave(
  here(output_dir, "6_2_wvi_top30_no_annotation.png"),
  fire_biod_val_plot_no_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
# Render for PDF
fire_biod_val_plot_annotation
```
## Wildland Urban Interface
The Province of British Columbia produces the Wildland Urban Interface (WUI) maps, with their intention being to use these maps to inform the relative impact of wildfires on human development. These maps take into consideration three key variables - fuel load, climate conditons, and human development at the interface between urban and wildland areas. This map shows the combinations of WUI Classification and Provincial Strategic Threat Analysis (PSTA) Threat Rating.
```{r}
#### Prepare layers for plotting ####
bowen_wui <- here("data-raw/datasets/bc_wui/wui.gpkg") %>% 
  st_read(quiet = T) %>%
  select(Name, PSTA) %>%
  rename(WUI = Name) %>%
  mutate(WUI_PSTA = paste0(WUI, "_", PSTA))
wui_factor_lvls <- c("No Data (Private Land)_1-4", "Water_1-4", "Low_1-4", "Moderate_1-4", "Moderate_5-6")
wui_factor <- bowen_wui %>%
  mutate(
    WUI_PSTA = factor(WUI_PSTA, levels = wui_factor_lvls)
  )
wui_factor_cols <- c("grey", "lightblue", "#fff7bc", "#fec44f", "#d95f0e")
names(wui_factor_cols) <- wui_factor_lvls

#### Plotting ####
wui_plot_base <- template_plot +
  geom_sf(data = bowen_wui, aes(fill = WUI_PSTA), colour = NA) +
  scale_fill_manual(
    values = wui_factor_cols, 
    aesthetics = c("colour", "fill"),
    labels = gsub("_", " / ", wui_factor_lvls),
    name = NULL
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_colour() +
  template_plot_overlay() +
  ggplot2::theme(
    legend.margin = margin(-9, 6, 6, 6),
    legend.key.width = ggplot2::unit(0.5, "cm"),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.spacing.y = ggplot2::unit(0, "lines"),
    legend.key.spacing.x = ggplot2::unit(0, "cm"),
    legend.direction = "vertical",
    legend.box = "vertical",
    legend.box.background = element_rect(fill = "white", colour = "black"),
    legend.box.margin = margin(20, 5, 5, 5),
    legend.position = c(.05, .95),
    legend.justification = c("left", "top"),
    legend.box.just = "left"
  ) 

wui_plot_annotation <- wui_plot_base +
  template_plot_annotations()
wui_plot_no_annotation <- wui_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "6_3_wui.png"),
  wui_plot_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
ggplot2::ggsave(
  here(output_dir, "6_3_wui_no_annotation.png"),
  wui_plot_no_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
# Render for PDF
wui_plot_annotation
```


## Development Pressure: Biodiversity Value by Parcel
Summed conservation value of properties (parcels) within this category. Relative measure of which parcels deserve closer consideration during the development process. 
```{r}
#### Preparing layers for plot ####
# Load and prepare parcel map
parcelmap <- st_read(here(
  "data-raw/datasets/parcelmap/bowen_parcelmap.gpkg"
)) %>%
  filter(PID != 31243550) # Remove ferry route
parcelmap$geom <- parcelmap$geom %>%
  st_cast("MULTIPOLYGON") %>%
  st_make_valid()
# parcelmap$area <- st_area(parcelmap) # equal to SHAPE_Area, units in m^2

# Load biodiversity values generated from Zonation
biod_vals <- rast(here("output-data/5_values/rankmap.tif"))
# Match parcelmap projection to the Zonation rast
parcelmap_vect <- parcelmap %>%
  vect() %>%
  project(biod_vals)
# Extract values that overlap cells
parcelmap_extract <- terra::extract(
  biod_vals,
  parcelmap_vect,
  sum, # sums all cells that overlap with each parcel
  bind = T, # bind to SpatVector
  weights = T # weight by fraction of cell that is within the polygon
)
#### Plotting ####
parcelmap_biod_vals_plot_base <- template_plot +
  geom_sf(
    data = parcelmap_extract_sf,
    aes(fill = rankmap),
    color = NA
  ) +
  scale_fill_continuous(
    palette = "YlGn",
    name = "Rel. Biodiversity Value",
    breaks = c(min(parcelmap_extract_sf$rankmap, na.rm = T), max(parcelmap_extract_sf$rankmap, na.rm = T)),
    labels = c("Low", "High"),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    )
  ) +
  template_plot_overlay()
 parcelmap_biod_vals_plot_annotation <- parcelmap_biod_vals_plot_base +
  template_plot_annotations()
parcelmap_biod_vals_plot_no_annotation <- parcelmap_biod_vals_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "6_4_parcelmap_biod_vals_plot.png"),
  parcelmap_biod_vals_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "6_4_parcelmap_biod_vals_plot_no_annotation.png"),
  parcelmap_biod_vals_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
# Render for PDF
parcelmap_biod_vals_plot_annotation
```

## Development Pressure: Subdivision Potential
Information from Daniel Martin (Bowen Island Municipality Manager of Planning & Development). This section is on quantifying the development potential on Bowen Island, via subdivisions of land to enable increased development / density. Subdivisions refer to taking larger properties of land and splitting them into smaller properties, which enables increased development and density as it allows more buildings to be built. The current zoning restricts the number of buildings per lot and the minimum area per lot. Therefore, splitting properties that could be made into multiple smaller but above minimum properties increases the number of buildings that can be built. 

Daniel Martin, Manager of Planning and Development at Bowen Island Municipality, provided these spreadsheets with information on the potential for individual lots to be subdivided. Additionally, Martin provided the number of potential further developments possible in Comprehensive Development Zones on Bowen Island. 
```{r}
#### Preparing layers for plotting #### 
# RR1 and RR2 (Rural Residential 1 and 2 Zoning)
rr1_rr2 <- here("data-raw/datasets/development_potential_danielmartin/zoning subdivision potential.xlsx") %>%
  readxl::read_xlsx(sheet = "RR1,RR2")
# RR3 (Rural Residential 3 Zoning)
rr3 <- here("data-raw/datasets/development_potential_danielmartin/zoning subdivision potential.xlsx") %>%
  readxl::read_xlsx(sheet = "RR3 properties")
# SR (Settlement Residential zoning)
sr <- here("data-raw/datasets/development_potential_danielmartin/zoning subdivision potential.xlsx") %>%
  readxl::read_xlsx(sheet = "SR properties")
# CD (Comprehensive Development Zones)
## Deal with these separately, need to do some wrangling 
ocp_subdivision <- rbind(rr1_rr2, rr3, sr) %>%
  filter(!is.na(pid))
ocp_subdivision_parcelmap <- merge(ocp_subdivision, bowen_parcelmap, by.x = "pid", by.y = "Name") %>%
  mutate(subdividable = case_when(
    `Can Subdivide?` == 0 ~ FALSE,
    `Can Subdivide?` > 0 ~ TRUE
  )) %>%
  st_as_sf() %>%
  st_transform(project_crs)
ocp_subdivision_parcelmap_f <- ocp_subdivision_parcelmap %>%
  mutate(
    pid = as.numeric(pid)
  )
# Removing duplicated columns
unique(ocp_subdivision_parcelmap_f$pid == ocp_subdivision_parcelmap_f$PID) # TRUE
unique(ocp_subdivision_parcelmap_f$parcelclass == toupper(ocp_subdivision_parcelmap_f$ParcelClass)) # TRUE
unique(ocp_subdivision_parcelmap_f$ownertype == toupper(ocp_subdivision_parcelmap_f$OwnerType)) # FALSE
which(ocp_subdivision_parcelmap_f$ownertype != toupper(ocp_subdivision_parcelmap_f$OwnerType)) # 1763
# turns out its UNCLASS and Unclassified, so the same 
ocp_subdivision_parcelmap_fd <- ocp_subdivision_parcelmap_f %>%
  select(!c(
    ParcelClass, OwnerType, PID
  )) 
# Remove outlier and duplicate PID
unique(ocp_subdivision_parcelmap_fd$pid) %>% length() # 1778, so one fewer than than nrows
ocp_subdivision_parcelmap_fdr <- ocp_subdivision_parcelmap_fd %>%
  filter(`Can Subdivide?` != 46)
write_sf(ocp_subdivision_parcelmap_fdr, here("data-raw/datasets/development_potential_danielmartin/ocp_subdivision_parcelmap.gpkg"), delete_layer = TRUE)

#### Plotting ####
title <- "Bowen Island OCP Subdividable"
subtitle <- "This map shows whether parcels are subdividable into additional units on Bowen Island. Data provided by Daniel Martin (2025)."

subdivide_plot_base <- template_plot +
  geom_sf(
    data = ocp_subdivision_parcelmap_fdr, 
    aes(fill = `Can Subdivide?`, geometry = geom), color = NA
  ) +
  scale_fill_distiller(
    palette = "RdPu",
    direction = 1,
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    )
  )
subdivide_plot_annotation <- subdivide_plot_base +
  template_plot_annotations()
subdivide_plot_no_annotation <- subdivide_plot_base +
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "6_5_parcelmap_subdiv.png"),
  subdivide_plot_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
ggplot2::ggsave(
  here(output_dir, "6_5_parcelmap_subdiv_no_anootation.png"),
  subdivide_plot_no_annotation,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
subdivide_plot_annotation
```

# Action
## Protected Areas: Top 30% Biodiversity Values 
% of biodiversity locations on Bowen Island, with gradient scale corresponding to relative priority for conservation. Higher values, towards 1.0, indicate higher priority. Lower values, towards 0.0, show lower priority. Protected Areas are visualized as an overlay on top of the Zonation priotization output. The percentage of these biodiversity locations covered by Protected Areas is 41% 
```{r}
#### Preparing layers for plotting ####
# Biodiversity values layer 
rankmap <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project(bowen.biodiversity.webapp::project_crs)
rankmap_for_map <- rankmap %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_bt_rm <- rankmap %>%
  remove_by_quantile(0.7)
rankmap_bt_rm_for_map <-rankmap_bt_rm %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_mask <- rankmap_bt_rm %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
# Bowen entire area
bowen_island <- st_read(
  here("data-raw/datasets/bowen_island_shoreline_w_hutt.gpkg"),
  layer = "bowen_island_shoreline_w_hutt__bowen_islands"
)
# Protected Areas from JD
bowen_protectedareas_include <- bowen.biodiversity.webapp::bowen_protectedareas %>%
  filter(type != "Agricultural Land Reserve") # Remove ALR
# Protected Areas from Bowen Island Municipality
# TODO: figure out why there are two shapefiles / folders of protectedareas
bowen_protectedareas_2 <- st_read(here(
  "data-raw/datasets/bowen_island_protectedareas/BM_PROTECTED_AREAS.shp"
)) %>%
  filter(NAME != "Old Growth Management Area")
# JD protected areas is more complete, with smaller municipal parks, covenants, and park land exchanges
# Use JD protected areas instead of BM_PROTECTED_AREAS.shp
bowen_protectedareas_rast <- bowen_protectedareas_include %>%
  bowen_rasterize() %>%
  project(rankmap_bt_rm)
union_protectedareas <- bowen.biodiversity.webapp::bowen_protectedareas %>%
  st_make_valid() %>%
  st_union()

#### Statistics ####
# Check with polygon / polygon area calculations for full Bowen Island
sum(st_area(bowen_protectedareas_include)) / sum(st_area(bowen_island)) 
# 0.2149664
sum(st_area(bowen_protectedareas_2)) / sum(st_area(bowen_island)) 
# 0.17935

# Check with raster
n_cells_top30bv_protectedareas <- rankmap_bt_rm %>% 
  mask(bowen_protectedareas_rast) %>%
  terra::noNA() %>%
  global("sum", na.rm = T)
# 668 cells noNA within protectedareas rast
n_cells_top30bv <- rankmap_bt_rm %>% 
  terra::noNA() %>%
  global("sum", na.rm = T)
# 1623 cells noNA in total
n_cells_top30bv_protectedareas / n_cells_top30bv
# 0.41 when calculate with raster

#### Plotting ####
protectedareas_colour <- "purple"

protectedareas_plot_base <- template_plot +
  geom_spatraster(data = rankmap_bt_rm_for_map) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "ag_GrnYl",
    limits = c(0,1),
    breaks = c(0, 0.5, 1),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Relative Biodiversity"
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_color() +
  geom_sf(
    data = union_protectedareas,
    aes(fill = protectedareas_colour, color = protectedareas_colour),
    alpha = 0.1,
    linewidth = 0.5
  ) +
  scale_fill_identity(
    name = "",
    breaks = c(protectedareas_colour),
    labels = c("Protected Areas"),
    guide = "legend"
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(protectedareas_colour),
    labels = c("Protected Areas"),
    guide = "legend"
  ) 
protectedareas_plot_annotations <- protectedareas_plot_base +
  template_plot_annotations()
protectedareas_plot_no_annotations <- protectedareas_plot_base + 
  template_plot_remove()
# Save plots
ggplot2::ggsave(
  here(output_dir, "7_1_biod_vals_protected_areas.png"),
  protectedareas_plot_annotations,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir, "7_1_biod_vals_protected_areas_no_annotation.png"),
  protectedareas_plot_no_annotations,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
# Render for PDF
protectedareas_plot_annotations
```


## Private Land: Top 30% Biodiversity Values
% of biodiversity locations on Bowen Island, with gradient scale corresponding to relative priority for conservation. Higher values, towards 1.0, indicate higher priority. Lower values, towards 0.0, show lower priority. Private Lands are visualized as an overlay on top of the Zonation priotization output. The percentage of these biodiversity locations covered by Private Lands is 43.9%
```{r biod_vals_private_land}
#### Preparing layers for plotting ####
# Biodiversity values layer 
rankmap <- here("output-data/5_values/rankmap.tif") %>%
  rast() %>%
  project(bowen.biodiversity.webapp::project_crs)
rankmap_for_map <- rankmap %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_bt_rm <- rankmap %>%
  remove_by_quantile(0.7)
rankmap_bt_rm_for_map <-rankmap_bt_rm %>%
  project("EPSG: 3857") %>%
  higher_res_edges() 
rankmap_mask <- rankmap_bt_rm %>%
  not.na() %>%
  classify(cbind(FALSE, NA))
# Bowen entire area
bowen_island <- st_read(
  here("data-raw/datasets/bowen_island_shoreline_w_hutt.gpkg"),
  layer = "bowen_island_shoreline_w_hutt__bowen_islands"
)
# Private Land
bowen_mask <- rast(here("output-data/bowen_mask.tif"))
bowen_parcelmap_rast <- bowen.biodiversity.webapp::bowen_parcelmap %>%
  st_cast("MULTIPOLYGON") %>% # Need this due to MULTISURFACE - see: https://gis.stackexchange.com/questions/389814/r-st-centroid-geos-error-unknown-wkb-type-12
  filter(OwnerType == "Private") %>%
  bowen_rasterize() %>%
  project(rankmap_bt_rm)
bowen_parcelmap_union <- bowen.biodiversity.webapp::bowen_parcelmap %>%
  filter(OwnerType == "Private") %>%
  st_cast("MULTIPOLYGON") %>% # Need this due to MULTISURFACE - see: https://gis.stackexchange.com/questions/389814/r-st-centroid-geos-error-unknown-wkb-type-12
  st_make_valid() %>%
  st_union()

#### Statistics ####
# Overlay by raster
n_cells_top30bv_privateland <- rankmap_bt_rm %>% 
  mask(bowen_parcelmap_rast) %>%
  terra::noNA() %>%
  global("sum", na.rm = T)
n_cells_top30bv <- rankmap_bt_rm %>% 
  terra::noNA() %>%
  global("sum", na.rm = T)
n_cells_top30bv_privateland / n_cells_top30bv
# 0.6691312 of top30bv is in private land, calc by rast

# Check with polygon / polygon area calculations for full Bowen Island
sum(st_area(bowen_parcelmap_union)) / sum(st_area(bowen_island)) 
# 0.4398537 of Bowen Island area is private land

#### Plotting ####
properties_colour <- "brown"
privatelands_overlap_plot_base <- template_plot +
  geom_spatraster(data = rankmap_bt_rm_for_map) +
  colorspace::scale_fill_continuous_sequential(
    na.value = NA,
    palette = "ag_GrnYl",
    limits = c(0,1),
    breaks = c(0, 0.5, 1),
    guide = ggplot2::guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      title.position = "top"
      # title.hjust = 0.5
    ),
    name = "Relative Biodiversity"
  ) +
  ggnewscale::new_scale_fill() +
  ggnewscale::new_scale_color() +
  geom_sf(
    data = bowen_parcelmap_union,
    aes(fill = properties_colour, color = properties_colour),
    alpha = 0.2,
    linewidth = 0.5
  ) +
  scale_fill_identity(
    name = "",
    breaks = c(properties_colour),
    labels = c("Private Land"),
    guide = "legend"
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(properties_colour),
    labels = c("Private Land"),
    guide = "legend"
  ) 
privatelands_overlap_plot_annotation <- privatelands_overlap_plot_base +
  template_plot_annotations()
privatelands_overlap_plot_no_annotation <- privatelands_overlap_plot_base +
  template_plot_remove()
ggplot2::ggsave(
  here(output_dir,"7_2_biodvals_private_land.png"),
  privatelands_overlap_plot_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
ggplot2::ggsave(
  here(output_dir,"7_2_biodvals_private_land_no_annotation.png"),
  privatelands_overlap_plot_no_annotation,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
privatelands_overlap_plot_annotation
```

## Land Ownership / Authority: Top 30% Biodiversity Value
- record ownership / authority category by pixel
- pink for private land
- purple for protected areas 
- brown for public land 
- mixed category (if there are any private land)

NOTE: check Fairweather, south Bowen Island neighbourhood 
- shared strata land that is private is not appearing as private on the map

## Example Locations for Protected Areas 
Let's update this where we use the same colour scheme as for existing protected areas above (purple), keep the OGMAs (maybe make slightly more distinct colour), and then add potential candidate areas for protection

- restricted to Crown Land
- input of biodiversity values
- considers optimizing for boundary length, contiguousness, and existing protected areas 
- calculate % of orange protential protected areas coverage of bowen island
```{r}
#### Loading layers ####
bowen_pa <- here("output-data/7_protected_areas/existing_protected_areas.gpkg") %>%
  st_read()
bowen_ogma <- ogma %>%
  st_transform(st_crs(bowen_pa))
bowen_new_pa <- here("output-data/7_protected_areas/new_protected_areas.gpkg") %>%
  st_read() %>%
  st_transform(st_crs(bowen_pa))
#### Plotting ####
protected_colour <- "purple"
ogma_colour <- "#a1d76a"
new_colour <- "orange"
protectedareas_example_plot_base <- template_plot +
  geom_sf(data = bowen_pa, 
          aes(fill = protected_colour, color = protected_colour), 
          alpha = 0.1,
          linewidth = 0.5) +
  geom_sf(data = bowen_ogma, 
          aes(fill = ogma_colour, color = ogma_colour), 
          alpha = 0.1,
          linewidth = 0.5) +
  geom_sf(data = bowen_new_pa, 
          aes(fill = new_colour, color = new_colour), 
          alpha = 0.1,
          linewidth = 0.5) +
  scale_fill_identity(name = "",
                      breaks = c(protected_colour, ogma_colour, new_colour),
                      labels = c("Current Protected", "Old Growth Management Areas", "Proposed Protected"),
                      guide = "legend"
  ) +
  scale_color_identity(name = "",
                       breaks = c(protected_colour, ogma_colour, new_colour),
                       labels = c("Current Protected", "Old Growth Management Areas", "Proposed Protected"),
                       guide = "legend"
  ) +
  template_plot_overlay()

geom_sf(
    data = union_protectedareas,
    aes(fill = protectedareas_colour, color = protectedareas_colour),
    alpha = 0.1,
    linewidth = 0.5
  ) +
  
  geom_sf(
    data = union_protectedareas,
    aes(fill = protectedareas_colour, color = protectedareas_colour),
    alpha = 0.1,
    linewidth = 0.5
  ) +
  scale_fill_identity(
    name = "",
    breaks = c(protectedareas_colour),
    labels = c("Protected Areas"),
    guide = "legend"
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(protectedareas_colour),
    labels = c("Protected Areas"),
    guide = "legend"
  ) 



# gg
protect_gg <- function() {
  protected_colour <- "#a1d76a"
  ogma_colour <- "beige"
  new_colour <- "orange"
  output <- list(
    geom_sf(data = bowen_pa, aes(fill = protected_colour), alpha = 0.5),
    geom_sf(data = bowen_ogma, aes(fill = ogma_colour), alpha = 0.5),
    geom_sf(data = bowen_new_pa, aes(fill = new_colour), alpha = 0.5),
    scale_fill_identity(name = "",
                          breaks = c(protected_colour, ogma_colour, new_colour),
                          labels = c("Current Protected", "Old Growth Management Areas", "Proposed Protected"),
                          guide = "legend"
    ),
    ggnewscale::new_scale_fill(),
    ggnewscale::new_scale_colour()
  )
  return(output)
}

protect_ggplot <- bowen_map_ggplot(
  protect_gg,
  title = "Top Locations for Protected Areas (30x30)",
  subtitle = "Mapping optimal Crown land for reaching 30x30 targets, using the conservation values analysis and existing protected areas. This output considers connectivity by applying boundary penalties, which prioritizes shorter boundaries relative to area. Currently, about 20% of Bowen Island is under some protection.",
  caption = paste0("Map created: ", date(), ". Palen Lab. Created by Jay Matsushiba (jmatsush@sfu.ca)")
)

ggplot2::ggsave(
  here(output_dir, "/", paste0(Sys.Date(), "_protect_ggplot.png")),
  protect_ggplot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)


protectedareas_example_plot_base
```



# Other Overlays
## Top 30% Biodiversity Value with Freshwater Habitats

# Appendix
## iNaturalist Observations
## Habitat Layers: Sensitive Ecosystem Inventory & Human Footprint
## Focal Vertebrate Species Layers 
## Provincial Conservation Status Ranks
## BC Red, Blue, Yellow Lists
## COSEWIC Status Domain Values
## IUCN Red List Categories
## Final Methods Summary

# OLD MAP CODE
## 2.2 Small Mammal Species Richness

```{r, eval=F}
# List SDMs filepaths
SDM_filepaths <- sdm_df[sdm_df$category == "MammalSmall", "path"]
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create species richness SDM
mammalsmall_richness <- sdm_to_species_richness(
  SDM_stack = SDM_stack,
  presence_threshold = presence_threshold
)
writeRaster(
  mammalsmall_richness,
  here("inst/extdata/2_species/sm_mammals_richness.tif"),
  overwrite = T
)

# Create species richness plots:
## Each species is marked present in a cell, if they are above a certain
## threshold of probability in the input SDMs.
title <- "Small Mammal Species Richness"
subtitle <- paste0(
  "Based on >",
  presence_threshold,
  " probability of occurrence in Species Distribution Models."
)

mammalsmall_richness_plot <- bowen_map(
  raster_layer = mammalsmall_richness,
  title = title,
  subtitle = subtitle,
  caption = caption,
  legend_label = "Richness"
) +
  geom_sf(
    data = bowen_ocean_sf,
    linewidth = bowen_ocean_linewidth,
    fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(
    data = bowen_trails,
    linewidth = 0.3,
    aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(
    data = bowen_roads,
    linewidth = 0.5,
    aes(color = roads_colour)
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(trails_colour, roads_colour),
    labels = c("Trails", "Roads"),
    guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "in"),
    pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )

ggplot2::ggsave(
  here(
    output_dir,
    "/",
    paste0(Sys.Date(), "_2_2_small_mammal_species_richness_map.png")
  ),
  mammalsmall_richness_plot,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
```

## 2.3 Amphibian & Reptile Species Richness

```{r, eval=F}
# List SDMs filepaths
SDM_filepaths <- sdm_df[sdm_df$category %in% c("Amphibian", "Reptile"), "path"]
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create species richness SDM
herptile_richness <- sdm_to_species_richness(
  SDM_stack = SDM_stack,
  presence_threshold = presence_threshold
)
writeRaster(
  herptile_richness,
  here("inst/extdata/2_species/herptiles_richness.tif"),
  overwrite = T
)

# Create species richness plots:
## Each species is marked present in a cell, if they are above a certain
## threshold of probability in the input SDMs.
title <- "Amphibian & Reptile Species Richness"
subtitle <- paste0(
  "Based on >",
  presence_threshold,
  " probability of occurrence in Species Distribution Models."
)

herptile_richness_plot <- bowen_map(
  raster_layer = herptile_richness,
  title = title,
  subtitle = subtitle,
  caption = caption,
  legend_label = "Richness"
) +
  geom_sf(
    data = bowen_ocean_sf,
    linewidth = bowen_ocean_linewidth,
    fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(
    data = bowen_trails,
    linewidth = 0.3,
    aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(
    data = bowen_roads,
    linewidth = 0.5,
    aes(color = roads_colour)
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(trails_colour, roads_colour),
    labels = c("Trails", "Roads"),
    guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "in"),
    pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )

ggplot2::ggsave(
  here(
    output_dir,
    "/",
    paste0(Sys.Date(), "_2_3_amphibian_reptile_species_richness_map.png")
  ),
  herptile_richness_plot,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
```

## 2.4 Threatened & Endangered Species Richness

```{r, eval=F}
# List SDMs filepaths
SDM_filepaths <- sdm_df[sdm_df$bc_status %in% c("Red", "Blue"), "path"]
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create species richness SDM
thr_richness <- sdm_to_species_richness(
  SDM_stack = SDM_stack,
  presence_threshold = presence_threshold
)
writeRaster(
  thr_richness,
  here("inst/extdata/2_species/threatened_richness.tif"),
  overwrite = T
)

# Create species richness plots:
## Each species is marked present in a cell, if they are above a certain
## threshold of probability in the input SDMs.
title <- "Threatened & Endangered Species Richness"
subtitle <- paste0(
  "Based on >",
  presence_threshold,
  " probability of occurrence in Species Distribution Models. Species that are listed under the Red or Blue Lists according to the British Columbia Conservation Data Centre are included in this map. There are 24 of these species present on Bowen Island with species distribution models available."
)

thr_richness_plot <- bowen_map(
  raster_layer = thr_richness,
  title = title,
  subtitle = subtitle,
  caption = caption,
  legend_label = "Richness"
) +
  geom_sf(
    data = bowen_ocean_sf,
    linewidth = bowen_ocean_linewidth,
    fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(
    data = bowen_trails,
    linewidth = 0.3,
    aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(
    data = bowen_roads,
    linewidth = 0.5,
    aes(color = roads_colour)
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(trails_colour, roads_colour),
    labels = c("Trails", "Roads"),
    guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "in"),
    pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )

ggplot2::ggsave(
  here(
    output_dir,
    "/",
    paste0(Sys.Date(), "_2_4_threatened_species_richness_map.png")
  ),
  thr_richness_plot,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
```


## 2.6 Focal Species Distribution Models - Summed SDMs

```{r sdm_stack, eval=F}
# List SDMs filepaths
SDM_filepaths <- sdm_df[, "path"]
# Prepare SDM stack
SDM_stack <- lapply(SDM_filepaths, rast) %>% rast()
# Create summed SDM
SDM_sum <- SDM_stack %>% sum(na.rm = T)
writeRaster(SDM_sum, here("inst/extdata/2_species/sum_sdms.tif"), overwrite = T)

# Create plot
bowen_plot <- bowen_map(
  raster_layer = SDM_sum,
  title = "Total Species Diversity",
  subtitle = "193 species included in this analysis. The values from each species distribution model (ranging from 0 to 1 as probability of occurrence in the cell) are summed to provide a relative biodiversity layer. Higher values correspond to cells with higher probability of species occurring, and vice versa.",
  caption = caption,
  legend_label = "Relative Biodiversity"
) +
  geom_sf(
    data = bowen_ocean_sf,
    linewidth = bowen_ocean_linewidth,
    fill = bowen_ocean_colour
  ) +
  ggplot2::geom_sf(
    data = bowen_trails,
    linewidth = 0.3,
    aes(color = trails_colour)
  ) +
  ggplot2::geom_sf(
    data = bowen_roads,
    linewidth = 0.5,
    aes(color = roads_colour)
  ) +
  scale_colour_identity(
    name = "",
    breaks = c(trails_colour, roads_colour),
    labels = c("Trails", "Roads"),
    guide = "legend"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "in"),
    pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )

# Save plot
ggplot2::ggsave(
  paste0(output_dir, "/", Sys.Date(), "_2_6_bowen_summed_sdm_map.png"),
  bowen_plot,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
```

## 3.2 â€˜Old and Large Forest: Old forest, Old growth management areasâ€™ (use green colour ramp/categories?)

```{r forests, eval=F}
# Plots
title <- "Forests: Old forest, Mature forest, Young forest."
subtitle <- "Forest features on Bowen Island, derived from Metro Vancouver Sensitive Ecosystem Inventory (2021). "

# Color Ramp
cols <- RColorBrewer::brewer.pal(4, "YlGn")

# Import Sensitive Ecosystem Inventory layers and define colours
bowen_island_OF <- layers_df[layers_df$name == "OF", "path"] %>%
  unlist() %>%
  rast()
bowen_island_OF_colour <- cols[4]
bowen_island_MF <- layers_df[layers_df$name == "MF", "path"] %>%
  unlist() %>%
  rast()
bowen_island_MF_colour <- cols[3]
bowen_island_YF <- layers_df[layers_df$name == "YF", "path"] %>%
  unlist() %>%
  rast()
bowen_island_YF_colour <- cols[2]
bowen_island_YS <- layers_df[layers_df$name == "YS", "path"] %>%
  unlist() %>%
  rast()
bowen_island_YS_colour <- cols[1]

bowen_plot <- bowen_map(
  raster_layer = empty_rast,
  title = title,
  subtitle = subtitle,
  caption = caption,
  legend_label = "Presence"
) +
  tidyterra::geom_spatraster(data = bowen_island_YS, aes(fill = layer)) +
  scale_fill_gradientn(
    name = "",
    labels = "Young Forest (small)",
    colours = bowen_island_YS_colour,
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = bowen_island_YF, aes(fill = layer)) +
  scale_fill_gradientn(
    name = "",
    labels = "Young Forest (<80 years old)",
    colours = bowen_island_YF_colour,
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = bowen_island_MF, aes(fill = layer)) +
  scale_fill_gradientn(
    name = "",
    labels = "Mature Forest (80 to 250 years old)",
    colours = bowen_island_MF_colour,
    guide = "legend",
    na.value = "transparent"
  ) +
  ggnewscale::new_scale_fill() +
  tidyterra::geom_spatraster(data = bowen_island_OF, aes(fill = layer)) +
  scale_fill_gradientn(
    name = "",
    labels = "Old Forest (Greater than 250 years old)",
    colours = bowen_island_OF_colour,
    guide = "legend",
    na.value = "transparent"
  ) +
  geom_sf(
    data = bowen_ocean_sf,
    linewidth = bowen_ocean_linewidth,
    fill = bowen_ocean_colour
  ) +
  ggplot2::theme(
    legend.margin = margin(-26, 6, 6, 6),
    legend.key.width = ggplot2::unit(0.5, "cm"),
    legend.key.height = ggplot2::unit(0.5, "cm"),
    legend.key.spacing.y = ggplot2::unit(0, "lines"),
    legend.key.spacing.x = ggplot2::unit(0, "cm"),
    legend.direction = "vertical",
    legend.box = "vertical",
    legend.box.background = element_rect(fill = "white", colour = "black"),
    legend.box.margin = margin(20, 5, 5, 5),
    legend.position = c(.05, .95),
    legend.justification = c("left", "top"),
    legend.box.just = "left"
  ) +
  ggspatial::annotation_scale(
    location = "br",
    bar_cols = c("grey60", "white")
  ) +
  ggspatial::annotation_north_arrow(
    location = "br",
    which_north = "true",
    pad_x = unit(0.2, "in"),
    pad_y = unit(0.4, "in"),
    style = ggspatial::north_arrow_nautical(
      fill = c("grey40", "white"),
      line_col = "grey20"
    )
  )

# Save plots
ggplot2::ggsave(
  here(
    output_dir,
    "/",
    paste0(Sys.Date(), "_", "3_2_bowen_forest_map", ".png")
  ),
  bowen_plot,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
```

## 3.3 Other Terrestrial Habitats: Terrestrial Ecosystem Mapping

```{r other_veg, eval=F}
# Plots
subtitle <- "Habitat features on Bowen Island, derived from Terrestrial Ecosystem Mapping (2019). "

# Subset
tem_df <- layers_df[layers_df$source == "TEM", ]
tem_df$colour <- distinctColorPalette(nrow(tem_df))

for (i in 1:nrow(tem_df)) {
  title <- paste0("Other Terrestrial Habitats: ", unlist(tem_df[i, "name"]))

  tem_ind_plot <- bowen_map(
    raster_layer = empty_rast,
    title = title,
    subtitle = subtitle,
    caption = caption,
    legend_label = "Presence"
  ) +
    ggplot2::theme(
      legend.margin = margin(-26, 6, 6, 6),
      legend.key.width = ggplot2::unit(0.5, "cm"),
      legend.key.height = ggplot2::unit(0.5, "cm"),
      legend.key.spacing.y = ggplot2::unit(0, "lines"),
      legend.key.spacing.x = ggplot2::unit(0, "cm"),
      legend.direction = "vertical",
      legend.box = "vertical",
      legend.box.background = element_rect(fill = "white", colour = "black"),
      legend.box.margin = margin(20, 5, 5, 5),
      legend.position = c(.05, .95),
      legend.justification = c("left", "top"),
      legend.box.just = "left"
    ) +
    tidyterra::geom_spatraster(
      data = rast(unlist(tem_df[i, "path"])),
      aes(fill = layer)
    ) +
    scale_fill_gradientn(
      name = "",
      labels = unlist(tem_df[i, "name"]),
      colours = unlist(tem_df[i, "colour"]),
      guide = "legend",
      na.value = "transparent"
    ) +
    geom_sf(
      data = bowen_ocean_sf,
      linewidth = bowen_ocean_linewidth,
      fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      pad_x = unit(0.2, "in"),
      pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )
  # Save plots
  ggplot2::ggsave(
    here(
      output_dir,
      "/",
      paste0(
        Sys.Date(),
        "_",
        "3_3_bowen_",
        tools::file_path_sans_ext(unlist(tem_df[i, "filename"])),
        "_map",
        ".png"
      )
    ),
    tem_ind_plot,
    device = ragg::agg_png,
    width = 9,
    height = 12,
    units = "in",
    res = 300
  )
}
```

## 3.4 Intertidal Habitats: Sensitive Ecosystem Inventory

```{r intertidal, eval=F}
# Subset
intertidal_df <- layers_df[layers_df$category == "Intertidal", ]
intertidal_df$colour <- distinctColorPalette(nrow(intertidal_df))

for (i in 1:nrow(intertidal_df)) {
  layer_desc <- unlist(intertidal_df[i, "notes"]) %>%
    strsplit(":")
  title <- paste0("Intertidal Habitats: ", layer_desc$notes[1])
  subtitle <- paste0(
    stringr::str_to_sentence(unlist(intertidal_df[i, "notes"])),
    " Habitats on Bowen Island derived from Metro Vancouver Sensitive Ecosystem Inventory (2021)."
  )

  tem_ind_plot <- bowen_map(
    raster_layer = empty_rast,
    title = title,
    subtitle = subtitle,
    caption = caption,
    legend_label = "Presence"
  ) +
    ggplot2::theme(
      legend.margin = margin(-26, 6, 6, 6),
      legend.key.width = ggplot2::unit(0.5, "cm"),
      legend.key.height = ggplot2::unit(0.5, "cm"),
      legend.key.spacing.y = ggplot2::unit(0, "lines"),
      legend.key.spacing.x = ggplot2::unit(0, "cm"),
      legend.direction = "vertical",
      legend.box = "vertical",
      legend.box.background = element_rect(fill = "white", colour = "black"),
      legend.box.margin = margin(20, 5, 5, 5),
      legend.position = c(.05, .95),
      legend.justification = c("left", "top"),
      legend.box.just = "left"
    ) +
    tidyterra::geom_spatraster(
      data = rast(unlist(intertidal_df[i, "path"])),
      aes(fill = layer)
    ) +
    scale_fill_gradientn(
      name = "",
      labels = unlist(intertidal_df[i, "name"]),
      colours = unlist(intertidal_df[i, "colour"]),
      guide = "legend",
      na.value = "transparent"
    ) +
    geom_sf(
      data = bowen_ocean_sf,
      linewidth = bowen_ocean_linewidth,
      fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      pad_x = unit(0.2, "in"),
      pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )

  # Save plots
  ggplot2::ggsave(
    here(
      output_dir,
      "/",
      paste0(
        Sys.Date(),
        "_",
        "3_4_bowen_",
        tools::file_path_sans_ext(unlist(intertidal_df[i, "filename"])),
        "_map",
        ".png"
      )
    ),
    tem_ind_plot,
    device = ragg::agg_png,
    width = 9,
    height = 12,
    units = "in",
    res = 300
  )
}
```

## 4.3 Human Disturbance (Categorical)

```{r, eval=F}
# Human Footprint
disturbed_classified <- here::here(
  "inst/extdata/habitats/bowen_human_footprint_recl.tif"
) %>%
  terra::rast() %>%
  as.factor()

# Plot
bowen_map_2 <- function(raster_layer, title, subtitle, caption, legend_label) {
  bowen_mask_ext <- raster_layer %>%
    project("EPSG: 3857") %>%
    ext()
  basemap_for_plot <- basemaps::basemap_terra(
    ext = raster_layer,
    map_service = "maptiler",
    map_type = "backdrop",
    map_token = "baL4WLstSFqSHP2fnYrE"
  )

  output_plot <- ggplot2::ggplot() +
    ggplot2::theme_bw() +
    tidyterra::geom_spatraster_rgb(data = basemap_for_plot) +
    tidyterra::geom_spatraster(data = raster_layer) +
    scale_fill_manual(
      name = "Level of Disturbance",
      na.translate = F,
      na.value = NA,
      values = c("1" = "#ffeda0", "2" = "#feb24c", "3" = "#f03b20"),
      labels = c("Low", "Medium", "High"),
    ) +
    ggplot2::scale_x_continuous(
      expand = c(0, 0),
      limits = c(bowen_mask_ext[1], bowen_mask_ext[2])
    ) +
    ggplot2::scale_y_continuous(
      expand = c(0, 0),
      limits = c(bowen_mask_ext[3], bowen_mask_ext[4])
    ) +
    ggplot2::labs(
      title = title,
      subtitle = subtitle,
      caption = caption
    ) +
    ggplot2::theme(
      plot.title = ggtext::element_textbox_simple(
        size = 20,
        margin = ggplot2::margin(0, 0, 20, 0)
      ),
      plot.subtitle = ggtext::element_textbox_simple(
        lineheight = 1.5,
        margin = ggplot2::margin(0, 0, 10, 0)
      ),
      axis.text.y = ggplot2::element_text(
        angle = 90,
        vjust = 1,
        hjust = 0.5
      ),
      legend.position = "bottom",
      legend.title = ggplot2::element_text(size = 10),
      legend.key.height = ggplot2::unit(0.5, "cm"),
      legend.key.width = ggplot2::unit(1.5, "cm"),
      legend.direction = "horizontal",
      legend.box = "horizontal",
      legend.box.margin = margin(1, 1, 1, 1),
      plot.margin = unit(c(1.3, 0.3, 0.8, 0), "cm")
    ) +
    geom_sf(
      data = bowen_ocean_sf,
      linewidth = bowen_ocean_linewidth,
      fill = bowen_ocean_colour
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      pad_x = unit(0.2, "in"),
      pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )
}

zonation_plot <- bowen_map_2(
  disturbed_classified,
  title = "Current Human Disturbance",
  subtitle = "Categorical map of human disturbance on Bowen Island. Categorization of levels of human disturbance based on values from:   Kristen Hirsh-Pearson, Chris J. Johnson, Richard Schuster, Roger D. Wheate, and Oscar Venter. 2022. Canadaâ€™s human footprint reveals large intact areas juxtaposed against areas under immense anthropogenic pressure. FACETS. 7: 398-419.",
  caption = caption,
  legend_label = "Disturbance"
)

ggplot2::ggsave(
  paste0(
    output_dir,
    "/",
    Sys.Date(),
    "_",
    "4_3_humandisturbance_categorical",
    ".png"
  ),
  zonation_plot,
  device = ragg::agg_png,
  width = 9,
  height = 12,
  units = "in",
  res = 300
)
```

## 5 Overlap Statistics

Here we calculate the overlap of the top % of conservation values with these other layers:
-   Protected areas
-   Private land
-   Human Footprint (HFP)
-   Freshwater habitats
    -   Lakes
    -   Ponds
    -   Streams
    -   Wetlands
    -   Riparian

```{r, warning=F, eval=F}
# Function for converting Zonation output to boolean based on percentage (in top XX%)
rankmap <- here(paste0(
  "inst/extdata/output_zonation/",
  sheet_date,
  "/rankmap.tif"
)) %>%
  rast() %>%
  project(project_crs)

# Bowen entire area
bowen_island <- st_read(
  here("data-raw/bowen_island_shoreline_w_hutt.gpkg"),
  layer = "bowen_island_shoreline_w_hutt__bowen_islands"
)


# Other Land
bowen_mask <- rast(here("inst/extdata/bowen_mask.tif"))
bowen_parcelmap_other_rast <- bowen.biodiversity.webapp::bowen_parcelmap %>%
  st_cast("MULTIPOLYGON") %>% # Need this due to MULTISURFACE - see: https://gis.stackexchange.com/questions/389814/r-st-centroid-geos-error-unknown-wkb-type-12
  filter(OwnerType != "Private") %>%
  bowen_rasterize_cover()

# Freshwater Habitats
fw_rast_paths <- c(
  here("inst/extdata/habitats/lakes.tif"),
  here("inst/extdata/habitats/ponds.tif"),
  here("inst/extdata/habitats/riparian.tif"),
  here("inst/extdata/habitats/wetlands.tif"),
  here("inst/extdata/habitats/streams.tif")
)
fw_rast_stack <- lapply(fw_rast_paths, rast) %>%
  rast()
fw_rast_dissolve <- fw_rast_stack %>%
  sum(na.rm = T) %>%
  not.na() %>%
  classify(cbind(FALSE, NA))



sf_use_s2(FALSE)

conservation_val_pal <- "ag_GrnYl"
quants <- seq(from = 0.5, to = 0.9, by = 0.1)
# Top XX%
foreach(quant = quants) %do%
  {
    rankmap_bt_rm <- rankmap %>%
      remove_by_quantile(quant)
    rankmap_mask <- rankmap_bt_rm %>%
      not.na() %>%
      classify(cbind(FALSE, NA))

    top_pct <- (1 - quant) * 100

    
    
    

    # 5.6 Biodiversity Values overlap with Freshwater
    fw_mask <- fw_rast_dissolve %>%
      not.na() %>%
      classify(cbind(FALSE, NA))
    fw_top <- fw_richness * rankmap_mask

    freshwater_overlap = raster_overlap_ratio(
      rankmap_bt_rm,
      fw_rast_dissolve
    ) %>%
      round(2)

    fw_plot <- bowen_map_toppct(
      empty_rast,
      title = paste0(
        "Top ",
        top_pct,
        "% Biodiversity Value with Freshwater Habitats"
      ),
      subtitle = paste0(
        "Top ",
        top_pct,
        "% of biodiversity locations on Bowen Island, overlapping with Freshwater Ecosystems. There is a ",
        freshwater_overlap * 100,
        "% overlap between top biodiversity locations and freshwater ecosystems."
      ),
      caption = caption,
      legend_label = "Freshwater Habitat Richness"
    ) +
      ggnewscale::new_scale_fill() +
      tidyterra::geom_spatraster(data = rankmap_mask, aes(fill = rankmap)) +
      scale_fill_gradientn(
        name = "",
        labels = paste0("Top ", top_pct, "% Only"),
        colours = "wheat3",
        guide = "legend",
        na.value = "transparent"
      ) +
      ggnewscale::new_scale_fill() +
      tidyterra::geom_spatraster(data = fw_top) +
      colorspace::scale_fill_continuous_sequential(
        na.value = NA,
        palette = "Mako",
        guide = ggplot2::guide_colourbar(
          nbin = 100,
          draw.ulim = FALSE,
          draw.llim = FALSE,
          title.position = "top"
          # title.hjust = 0.5
        ),
        name = "Freshwater Habitat Richness"
      ) +
      ggplot2::geom_sf(
        data = bowen_trails,
        linewidth = 0.3,
        aes(color = trails_colour)
      ) +
      ggplot2::geom_sf(
        data = bowen_roads,
        linewidth = 0.5,
        aes(color = roads_colour)
      ) +
      scale_colour_identity(
        name = "",
        breaks = c(trails_colour, roads_colour),
        labels = c("Trails", "Roads"),
        guide = "legend"
      ) +
      geom_sf(
        data = bowen_ocean_sf,
        linewidth = bowen_ocean_linewidth,
        fill = bowen_ocean_colour
      ) +
      ggspatial::annotation_scale(
        location = "br",
        bar_cols = c("grey60", "white")
      ) +
      ggspatial::annotation_north_arrow(
        location = "br",
        which_north = "true",
        pad_x = unit(0.2, "in"),
        pad_y = unit(0.4, "in"),
        style = ggspatial::north_arrow_nautical(
          fill = c("grey40", "white"),
          line_col = "grey20"
        )
      )
    ggplot2::ggsave(
      paste0(
        output_dir,
        "/",
        Sys.Date(),
        "_",
        "5_6_top_",
        top_pct,
        "_fw",
        ".png"
      ),
      fw_plot,
      device = ragg::agg_png,
      width = 9,
      height = 12,
      units = "in",
      res = 300
    )
  }
```

```{r, eval=F}
# Bottom XX%
quants <- seq(from = 0.1, to = 0.5, by = 0.1)
foreach(quant = quants) %do%
  {
    rankmap_bt_rm <- rankmap %>%
      remove_by_quantile(quant, direction = "bottom")
    rankmap_mask <- rankmap_bt_rm %>%
      not.na() %>%
      classify(cbind(FALSE, NA))

    bottom_pct <- quant * 100

    # 5.1 bottom XX% Biodiversity Values (0-1)
    bottom_plot <- bowen_map_toppct(
      rankmap_bt_rm,
      title = paste0("Bottom ", bottom_pct, "% Biodiversity Values"),
      subtitle = paste0(
        "Bottom ",
        bottom_pct,
        "% of biodiversity locations on Bowen Island. Zonation5 Prioritization Algorithm of Locations on Bowen Island. Environmental layers (n = 33)  with species layers (n = 195)."
      ),
      caption = caption,
      legend_label = "Relative Biodiversity",
      pal = conservation_val_pal
    ) +
      ggplot2::geom_sf(
        data = bowen_trails,
        linewidth = 0.3,
        aes(color = trails_colour)
      ) +
      ggplot2::geom_sf(
        data = bowen_roads,
        linewidth = 0.5,
        aes(color = roads_colour)
      ) +
      scale_colour_identity(
        name = "",
        breaks = c(trails_colour, roads_colour),
        labels = c("Trails", "Roads"),
        guide = "legend"
      ) +
      geom_sf(
        data = bowen_ocean_sf,
        linewidth = bowen_ocean_linewidth,
        fill = bowen_ocean_colour
      ) +
      ggspatial::annotation_scale(
        location = "br",
        bar_cols = c("grey60", "white")
      ) +
      ggspatial::annotation_north_arrow(
        location = "br",
        which_north = "true",
        pad_x = unit(0.2, "in"),
        pad_y = unit(0.4, "in"),
        style = ggspatial::north_arrow_nautical(
          fill = c("grey40", "white"),
          line_col = "grey20"
        )
      )

    ggplot2::ggsave(
      paste0(
        output_dir,
        "/",
        Sys.Date(),
        "_",
        "5_1_bottom_",
        bottom_pct,
        "_biodiversity_values",
        ".png"
      ),
      bottom_plot,
      device = ragg::agg_png,
      width = 9,
      height = 12,
      units = "in",
      res = 300
    )

    # 5.2 Biodiversity Values (0-1) overlap with Protected Areas
    protectedareas_colour <- "purple"
    protectedareas_overlap <- raster_overlap_ratio(
      rankmap_bt_rm,
      bowen_protectedareas_rast
    ) %>%
      round(2)
    protectedareas_plot <- bowen_map_toppct(
      rankmap_bt_rm,
      title = paste0(
        "Bottom ",
        bottom_pct,
        "% Biodiversity Values with Protected Areas"
      ),
      subtitle = paste0(
        "Bottom ",
        bottom_pct,
        "% of biodiversity locations on Bowen Island, with gradient scale corresponding to relative priority for conservation. Higher values, towards 1.0, indicate higher priority. Lower values, towards 0.0, show lower priority. Protected Areas are visualized as an overlay on the Zonation priotization output. The percentage of these biodiversity locations covered by Protected Areas is ",
        protectedareas_overlap * 100,
        "%."
      ),
      caption = caption,
      legend_label = "Priority",
      pal = conservation_val_pal
    ) +
      geom_sf(
        data = union_protectedareas,
        aes(fill = protectedareas_colour, color = protectedareas_colour),
        alpha = 0.1,
        linewidth = 0.5
      ) +
      scale_fill_identity(
        name = "",
        breaks = c(protectedareas_colour),
        labels = c("Protected Areas"),
        guide = "legend"
      ) +
      scale_colour_identity(
        name = "",
        breaks = c(protectedareas_colour),
        labels = c("Protected Areas"),
        guide = "legend"
      ) +
      geom_sf(
        data = bowen_ocean_sf,
        linewidth = bowen_ocean_linewidth,
        fill = bowen_ocean_colour
      ) +
      ggspatial::annotation_scale(
        location = "br",
        bar_cols = c("grey60", "white")
      ) +
      ggspatial::annotation_north_arrow(
        location = "br",
        which_north = "true",
        pad_x = unit(0.2, "in"),
        pad_y = unit(0.4, "in"),
        style = ggspatial::north_arrow_nautical(
          fill = c("grey40", "white"),
          line_col = "grey20"
        )
      )
    ggplot2::ggsave(
      paste0(
        output_dir,
        "/",
        Sys.Date(),
        "_",
        "5_2_bottom_",
        bottom_pct,
        "_protectedareas",
        ".png"
      ),
      protectedareas_plot,
      device = ragg::agg_png,
      width = 9,
      height = 12,
      units = "in",
      res = 300
    )

    # 5.3 Biodiversity Values (0-1) overlap with Private Land
    properties_colour <- "brown"
    privatelands_overlap <- raster_overlap_ratio(
      rankmap_bt_rm,
      bowen_parcelmap_rast
    ) %>%
      round(2)
    privateland_plot <- bowen_map_toppct(
      rankmap_bt_rm,
      title = paste0(
        "Bottom ",
        bottom_pct,
        "% Biodiversity Value with Private Land"
      ),
      subtitle = paste0(
        "Bottom ",
        bottom_pct,
        "% of biodiversity locations on Bowen Island, with gradient scale corresponding to relative priority for conservation. Higher values, towards 1.0, indicate higher priority. Lower values, towards 0.0, show lower priority. Private Lands are visualized as an overlay on the Zonation priotization output. The percentage of these biodiversity locations covered by Private Lands is ",
        privatelands_overlap * 100,
        "%."
      ),
      caption = caption,
      legend_label = "Priority",
      pal = conservation_val_pal
    ) +
      geom_sf(
        data = bowen_parcelmap_union,
        aes(fill = properties_colour, color = properties_colour),
        alpha = 0.2,
        linewidth = 0.5
      ) +
      scale_fill_identity(
        name = "",
        breaks = c(properties_colour),
        labels = c("Private Land"),
        guide = "legend"
      ) +
      scale_colour_identity(
        name = "",
        breaks = c(properties_colour),
        labels = c("Private Land"),
        guide = "legend"
      ) +
      geom_sf(
        data = bowen_ocean_sf,
        linewidth = bowen_ocean_linewidth,
        fill = bowen_ocean_colour
      ) +
      ggspatial::annotation_scale(
        location = "br",
        bar_cols = c("grey60", "white")
      ) +
      ggspatial::annotation_north_arrow(
        location = "br",
        which_north = "true",
        pad_x = unit(0.2, "in"),
        pad_y = unit(0.4, "in"),
        style = ggspatial::north_arrow_nautical(
          fill = c("grey40", "white"),
          line_col = "grey20"
        )
      )

    ggplot2::ggsave(
      paste0(
        output_dir,
        "/",
        Sys.Date(),
        "_",
        "5_3_bottom_",
        bottom_pct,
        "_privateland",
        ".png"
      ),
      privateland_plot,
      device = ragg::agg_png,
      width = 9,
      height = 12,
      units = "in",
      res = 300
    )

    # 5.4 Biodiversity Values overlap with Human Disturbance (categorical)
    bowen_hfp_bottom <- max(c(bowen_hfp, rankmap_mask)) %>%
      as.factor()
    # overlap with each category (low, medium, high)
    hfp_low_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_low) %>%
      round(2)
    hfp_med_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_med) %>%
      round(2)
    hfp_high_overlap = raster_overlap_ratio(rankmap_mask, bowen_hfp_high) %>%
      round(2)

    bowen_hfp_plot <- bowen_map_2(
      bowen_hfp_bottom,
      title = paste0(
        "Bottom ",
        bottom_pct,
        "% Biodiversity Value with Human Footprint (Categorical)"
      ),
      subtitle = paste0(
        "Bottom ",
        bottom_pct,
        "% of biodiversity locations on Bowen Island, with scale corresponding to relative human disturbance. 0% of bottom biodiversity locations are considered intact. ",
        hfp_low_overlap * 100,
        "% of bottom biodiversity locations considered to be less disturbed. ",
        hfp_med_overlap * 100,
        "% of bottom biodiversity cells are considered moderately disturbed. ",
        hfp_high_overlap * 100,
        "% of bottom biodiversity locations are highly disturbed. Citation: Kristen Hirsh-Pearson, Chris J. Johnson, Richard Schuster, Roger D. Wheate, and Oscar Venter. 2022. Canadaâ€™s human footprint reveals large intact areas juxtaposed against areas under immense anthropogenic pressure. FACETS. 7: 398-419."
      ),
      caption = caption,
      legend_label = "Disturbance"
    ) +
      ggplot2::geom_sf(
        data = bowen_trails,
        linewidth = 0.3,
        aes(color = trails_colour)
      ) +
      ggplot2::geom_sf(
        data = bowen_roads,
        linewidth = 0.5,
        aes(color = roads_colour)
      ) +
      scale_colour_identity(
        name = "",
        breaks = c(trails_colour, roads_colour),
        labels = c("Trails", "Roads"),
        guide = "legend"
      ) +
      geom_sf(
        data = bowen_ocean_sf,
        linewidth = bowen_ocean_linewidth,
        fill = bowen_ocean_colour
      ) +
      ggspatial::annotation_scale(
        location = "br",
        bar_cols = c("grey60", "white")
      ) +
      ggspatial::annotation_north_arrow(
        location = "br",
        which_north = "true",
        pad_x = unit(0.2, "in"),
        pad_y = unit(0.4, "in"),
        style = ggspatial::north_arrow_nautical(
          fill = c("grey40", "white"),
          line_col = "grey20"
        )
      )

    ggplot2::ggsave(
      paste0(
        output_dir,
        "/",
        Sys.Date(),
        "_",
        "5_4_bottom_",
        bottom_pct,
        "_hfp_categorical",
        ".png"
      ),
      bowen_hfp_plot,
      device = ragg::agg_png,
      width = 9,
      height = 12,
      units = "in",
      res = 300
    )

    # 5.5 Biodiversity Values overlap with Human Disturbance (continuous)
    bowen_hfp_continuous_bottom <- rankmap_mask *
      rast(here("inst/extdata/habitats/bowen_human_footprint.tif"))

    bowen_hfp_continuous_plot <- bowen_map(
      bowen_hfp_continuous_bottom,
      title = paste0(
        "Bottom ",
        bottom_pct,
        "% Biodiversity Value with Human Footprint (Continuous)"
      ),
      subtitle = paste0(
        "Bottom ",
        bottom_pct,
        "% of biodiversity locations on Bowen Island, with scale corresponding to relative human disturbance. 0% of bottom biodiversity locations are considered intact. ",
        hfp_low_overlap * 100,
        "% of bottom biodiversity locations considered to be less disturbed. ",
        hfp_med_overlap * 100,
        "% of bottom biodiversity cells are considered moderately disturbed. ",
        hfp_high_overlap * 100,
        "% of bottom biodiversity locations are highly disturbed. Citation: Kristen Hirsh-Pearson, Chris J. Johnson, Richard Schuster, Roger D. Wheate, and Oscar Venter. 2022. Canadaâ€™s human footprint reveals large intact areas juxtaposed against areas under immense anthropogenic pressure. FACETS. 7: 398-419."
      ),
      caption = caption,
      legend_label = "Disturbance",
      pal = "Inferno"
    ) +
      ggplot2::geom_sf(
        data = bowen_trails,
        linewidth = 0.3,
        aes(color = trails_colour)
      ) +
      ggplot2::geom_sf(
        data = bowen_roads,
        linewidth = 0.5,
        aes(color = roads_colour)
      ) +
      scale_colour_identity(
        name = "",
        breaks = c(trails_colour, roads_colour),
        labels = c("Trails", "Roads"),
        guide = "legend"
      ) +
      geom_sf(
        data = bowen_ocean_sf,
        linewidth = bowen_ocean_linewidth,
        fill = bowen_ocean_colour
      ) +
      ggspatial::annotation_scale(
        location = "br",
        bar_cols = c("grey60", "white")
      ) +
      ggspatial::annotation_north_arrow(
        location = "br",
        which_north = "true",
        pad_x = unit(0.2, "in"),
        pad_y = unit(0.4, "in"),
        style = ggspatial::north_arrow_nautical(
          fill = c("grey40", "white"),
          line_col = "grey20"
        )
      )

    ggplot2::ggsave(
      paste0(
        output_dir,
        "/",
        Sys.Date(),
        "_",
        "5_5_bottom_",
        bottom_pct,
        "_hfp_continuous",
        ".png"
      ),
      bowen_hfp_continuous_plot,
      device = ragg::agg_png,
      width = 9,
      height = 12,
      units = "in",
      res = 300
    )

    # 5.6 Biodiversity Values overlap with Freshwater
    fw_mask <- fw_rast_dissolve %>%
      not.na() %>%
      classify(cbind(FALSE, NA))
    fw_bottom <- fw_richness * rankmap_mask

    freshwater_overlap = raster_overlap_ratio(
      rankmap_bt_rm,
      fw_rast_dissolve
    ) %>%
      round(2)

    fw_plot <- bowen_map_toppct(
      empty_rast,
      title = paste0(
        "Bottom ",
        bottom_pct,
        "% Biodiversity Value with Freshwater Habitats"
      ),
      subtitle = paste0(
        "Bottom ",
        bottom_pct,
        "% of biodiversity locations on Bowen Island, overlapping with Freshwater Ecosystems. There is a ",
        freshwater_overlap * 100,
        "% overlap between bottom biodiversity locations and freshwater ecosystems."
      ),
      caption = caption,
      legend_label = "Freshwater Habitat Richness"
    ) +
      ggnewscale::new_scale_fill() +
      tidyterra::geom_spatraster(data = rankmap_mask, aes(fill = rankmap)) +
      scale_fill_gradientn(
        name = "",
        labels = paste0("bottom ", bottom_pct, "% Only"),
        colours = "wheat3",
        guide = "legend",
        na.value = "transparent"
      ) +
      ggnewscale::new_scale_fill() +
      tidyterra::geom_spatraster(data = fw_bottom) +
      colorspace::scale_fill_continuous_sequential(
        na.value = NA,
        palette = "Mako",
        guide = ggplot2::guide_colourbar(
          nbin = 100,
          draw.ulim = FALSE,
          draw.llim = FALSE,
          title.position = "bottom"
          # title.hjust = 0.5
        ),
        name = "Freshwater Habitat Richness"
      ) +
      ggplot2::geom_sf(
        data = bowen_trails,
        linewidth = 0.3,
        aes(color = trails_colour)
      ) +
      ggplot2::geom_sf(
        data = bowen_roads,
        linewidth = 0.5,
        aes(color = roads_colour)
      ) +
      scale_colour_identity(
        name = "",
        breaks = c(trails_colour, roads_colour),
        labels = c("Trails", "Roads"),
        guide = "legend"
      ) +
      geom_sf(
        data = bowen_ocean_sf,
        linewidth = bowen_ocean_linewidth,
        fill = bowen_ocean_colour
      ) +
      ggspatial::annotation_scale(
        location = "br",
        bar_cols = c("grey60", "white")
      ) +
      ggspatial::annotation_north_arrow(
        location = "br",
        which_north = "true",
        pad_x = unit(0.2, "in"),
        pad_y = unit(0.4, "in"),
        style = ggspatial::north_arrow_nautical(
          fill = c("grey40", "white"),
          line_col = "grey20"
        )
      )
    ggplot2::ggsave(
      paste0(
        output_dir,
        "/",
        Sys.Date(),
        "_",
        "5_6_bottom_",
        bottom_pct,
        "_fw",
        ".png"
      ),
      fw_plot,
      device = ragg::agg_png,
      width = 9,
      height = 12,
      units = "in",
      res = 300
    )
  }
```


