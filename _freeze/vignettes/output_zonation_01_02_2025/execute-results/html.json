{
  "hash": "f49c4b110fe2e3443a9fa4697b5d8266",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Conservation Prioritization for February 1st Bowen Island Workshop\"\nauthor: \"Jay Matsushiba\"\ndate: \"2025/02/01\"\nformat:\n  html:\n    code-fold: true\n---\n\n\n\n\n# Bowen Island Biodiversity Prioritization - Zonation5\nThis Rmarkdown documents the Zonation run used for the initial February 1st, 2025 Bowen Island Workshop on Biodiversity Planning. \n\n<https://github.com/zonationteam/Zonation5>\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### Palen Lab Packages ####\nlibrary(bowen.biodiversity.webapp)\n#remotes::install_github(\"Palen-Lab/sdmcsr\")\nlibrary(sdmcsr) # SDM congruence functions with iNaturalist observations\n#remotes::install_github(\"Palen-Lab/rinat\") # Fork by Jay Matsushiba\nlibrary(rinat) \n\n#### Other Packages ####\nlibrary(here)\n#> here() starts at /home/jay/Programming_Projects/bowen.biodiversity.webapp\nlibrary(dplyr)\n#> \n#> Attaching package: 'dplyr'\n#> The following objects are masked from 'package:stats':\n#> \n#>     filter, lag\n#> The following objects are masked from 'package:base':\n#> \n#>     intersect, setdiff, setequal, union\nlibrary(stringr)\nlibrary(foreach)\nlibrary(sf)\n#> Linking to GEOS 3.11.1, GDAL 3.6.4, PROJ 9.1.1; sf_use_s2() is TRUE\nlibrary(terra)\n#> terra 1.8.5\nlibrary(tidyterra)\n#> \n#> Attaching package: 'tidyterra'\n#> The following object is masked from 'package:stats':\n#> \n#>     filter\nlibrary(readxl)\nlibrary(googlesheets4)\n\n#### Common Objects Across Analyses ####\n# Defining CRS to make sure all SDMs have the same\nsdm_crs <- \"+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs\"\n# Bowen Island Administrative Boundary (from Metro Vancouver)\nbowen_island_admin <- vect(bowen.biodiversity.webapp::bowen_boundary) %>%\n  project(sdm_crs)\n```\n:::\n\n\n\n\n## Loading Datasets\n\n### Notes on Data Management\n\nRaw data (temp files) into `data-raw` and added to `data-raw/.gitignore` Save finished outputs (as used by the application) into `inst/extdata` - Convention is to save files that are not `.rda` into this folder (<https://rstudio.github.io/r-manuals/r-exts/Creating-R-packages.html#data-in-packages>)\n\n### Species Distribution Models\n\nThe species distribution models (SDMs) included in the Bowen Island Conservation Plan analyses were originally produced by Viorel Popescu (Popescu et al., 2020). Out of the 341 SDMs available, we included 193 of the SDMs. Occurrence locations of small vertebrate species were gathered from Global Biodiversity Information Facility (data.gbif.org) and Nature Counts (birdscanada.org/birdmon) open-access databases. Inclusion of small mammal species was based on Appendix 2 & 3 from the 2005 Environmental Inventory report, which states species presence on Bowen Island. We used the iNaturalist and eBird databases of observations for the inclusion criteria for reptiles, amphibians, and birds (described in further detail in Methods).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### SPECIES DISTRIBUTION MODELS ####\n# Contents of \"data-raw/species_distribution_models/\" downloaded from Cumulative effects - SFU Teams Sharepoint \n# https://1sfu.sharepoint.com/:f:/r/teams/Cumulativeeffects-SFUTeams9/Shared%20Documents/BCH_project_backup/SPECIES?csf=1&web=1&e=FpNkgc \n# Directory Path: BCH_project_backup/SPECIES/\n# Paper: https://www.nature.com/articles/s41598-020-64501-7#MOESM1\n# See Wendy Palen (SFU) for access \n#### PROCESSING SDM ####\n# Get list of available SDMs\nsdm_folder <- here(\"data-raw/species_distribution_models\")\nsdm_folder_tif <- list.files(sdm_folder, recursive = T, pattern = \"*.tif$\") # Get only .tif files\n# Correspondence with Viorel Popescu confirms that _NAs_ should be SDMs with rock, ice, large lakes layers masked\nsdm_folder_tif_NAs <- sdm_folder_tif[grepl(\"_NAs_\", sdm_folder_tif)] # Get only .tif with \"_NAs_\" in filename\n# Directory to save SDMs\nsdm_output_dir <- here(\"inst/extdata/species_distribution_models_bowen\")\nif(!dir.exists(sdm_output_dir)) {\n  dir.create(sdm_output_dir)\n}\n# Create Bowen Island mask using DSM\nsample_sdm <- rast(here(sdm_folder, sdm_folder_tif_NAs[1])) %>%\n  terra::project(y = sdm_crs) %>%\n  terra::crop(bowen_island_admin, snap = \"out\") %>%\n  terra::disagg(fact = 4)\ndsm <- rast(here(\"data-raw/bowen_dsm/chm.tif\"))\ndsm_smooth <- dsm %>% \n  focal(w=9, fun=mean, na.policy=\"only\", na.rm=T) %>% \n  terra::project(y = sdm_crs) %>%\n  terra::resample(sample_sdm, method = \"average\")\nm <- c(-1, 35, 1) %>% matrix(ncol = 3, byrow=T)\nbowen_island_mask <- dsm_smooth %>% \n  classify(m) %>%\n  as.int()\nwriteRaster(bowen_island_mask, here(\"inst/extdata/bowen_mask.tif\"), overwrite = T)\n# Weights for terra::focal() function that provides moving window average\n# - Smoothing algorithm \n# - Use this to fill some empty cells on Bowen Island with weighted mean of the neighbouring cells.\nweights <- matrix(c(0, 0, 1, 1, 1, 0, 0,\n                    0, 1, 1, 2, 1, 1, 0,\n                    1, 1, 3, 3, 3, 1, 1,\n                    1, 2, 3, 5, 3, 2, 1,\n                    1, 1, 3, 3, 3, 1, 1,\n                    0, 1, 1, 2, 1, 1, 0,\n                    0, 0, 1, 1, 1, 0, 0\n), nrow=7)\n#### PREPARE SDMs TO BOWEN ISLAND ####\n# Loop through SDMs\nforeach(sdm_tif = sdm_folder_tif_NAs) %do% {\n  sdm_path <- here(sdm_folder, sdm_tif) \n  sdm_output_path <- here(sdm_output_dir, basename(sdm_tif))\n  sdm <- rast(sdm_path)\n  # Normalize SDMs that range from 0 to 1000\n  sdm_minmax <- terra::minmax(sdm)\n  if(sdm_minmax[2] > 1) {\n    sdm <- sdm / 1000\n  }\n  sdm_output <- sdm %>%\n    #### Reproject SDM ####\n    terra::project(y = sdm_crs) %>%\n    #### Crop SDM ####\n    # Figured out why the SDMs were cropped incorrectly\n    # The default for cropping a raster by a polygon is to snap = \"near\"\n    # This means that the polygon extent is snapped to the closest raster\n    # We need snap = \"out\" to make sure the full extent of the polygon is covered by the output raster\n    terra::crop(bowen_island_admin, snap = \"out\") %>%\n    #### Extrapolate for Southern Parts of Bowen Island\n    # - fills the NA values missing in south part of Bowen Island\n    terra::focal(w = weights,\n                 fun = \"mean\",\n                 na.policy = \"only\") %>%\n    #### Downsamples ####\n    # - from 400 m to 100 m resolution\n    terra::disagg(fact = 4) %>%\n    #### Smooths the raster ####\n    terra::focal(w = weights,\n                 fun = \"mean\",\n                 na.rm = T,\n                 na.policy = \"omit\") %>%\n    terra::mask(bowen_island_mask)\n  \n  writeRaster(sdm_output, sdm_output_path, overwrite = T)\n}\n# Create species list from available SDMs\nspecies_list <- sdm_folder_tif_NAs %>%\n  basename() %>%\n  stringr::str_extract(\"^\\\\S+\\\\.[a-zA-Z]+_\") %>%\n  stringr::str_remove(\"_\") %>%\n  stringr::str_replace(\"\\\\.\", \" \")\n# Create taxon list \ntaxon_list <- sdm_folder_tif_NAs %>%\n  dirname() %>%\n  str_remove(\"_mask\")\n# Get iNaturalist and SDM congruence\nsdm_inat <- foreach(i = 1:length(species_list), .combine = \"rbind\") %do% {\n  # Progress Message \n  print(paste0(\"Currently working on species \", i, \" out of \", length(species_list),\". This is \", species_list[i], \".\"))\n  # Query iNaturalist by species name and Bowen Island Administrative Boundaries\n  rinat_results_sf <- tryCatch({\n    Sys.sleep(3) # Need to slow down queries to prevent requests being blocked\n    rinat::get_inat_obs_sf(taxon_name = species_list[i],\n                           area = st_as_sf(bowen_island_admin),\n                           maxresults = 10000)\n  }, error = function(cond) {\n    NA\n  })\n  # Get number of iNaturalist observations\n  if(!is.data.frame(rinat_results_sf)) {\n    inat_n_obs <- 0\n  } else {\n    inat_n_obs <- nrow(rinat_results_sf)\n  }\n  # Get Bowen Island SDM\n  sdm <- paste0(str_replace(species_list[i], \" \", \".\"), \"_NAs_pu_mask.tif\") %>%\n    here(sdm_output_dir, .) %>%\n    rast()\n  # Get highest value in SDM\n  sdm_max <- sdm %>% \n    minmax() %>% \n    max()\n  # PREPARE OUTPUT ROW\n  # 1. scientific species name\n  # 2. highest SDM cell value within area \n  # 3. observation count from iNaturalist\n  result <- data.frame(species = species_list[i],\n                       sdm_max_value = sdm_max,\n                       inat_n_obs = inat_n_obs)\n}\nsdm_inat$taxon_group <- taxon_list\n#### Query eBird for birds ####\n# Number of eBird observations by bird species on Bowen Island\n# - Results from Natasha Beauregard (Summer 2024 USRA)\nbowen_ebird <- read.csv(here(\"data-raw/bowen_ebird/final_bird.csv\")) %>%\n  select(c(\"scientific_name\", \"n_ebird\"))\n# Combine eBird and iNaturalist counts\nbowen_SDM_iNat_ebird <- merge(sdm_inat, \n                              bowen_ebird, \n                              by.x = \"species\", \n                              by.y = \"scientific_name\",\n                              all.x = TRUE) %>%\n  rename(n_obs_inat = inat_n_obs,\n         n_obs_ebird = n_ebird) %>%\n  select(\n    species,\n    sdm_max_value,\n    taxon_group,\n    n_obs_inat,\n    n_obs_ebird\n  )\n# Query Pottinger Report (2005) for small mammals\nbowen_mammals <- read_xlsx(here(\"data-raw/pottinger_report/Appendix 2 - Expected Occurrence of Wildlife Species In The Cape Roger Curtis Area.xlsx\")) %>%\n  filter(`Documented on Bowen` == \"y\" | `Documented on Bowen` == \"?\" | `Documented on Bowen` == \"One or more spp\" )\n# Include Species if they meet any of the following criteria:\n# - eBird observations > 0\n# - iNaturalist observations > 0\n# - included in Pottinger Report \ninclude_threshold <- 0.5 # Min SDM cell value somewhere on Bowen Island for including species into focal list\nbowen_SDM_obs_focal_df <- bowen_SDM_iNat_ebird %>%\n  mutate(include = case_when(\n    (n_obs_inat > 0 | n_obs_ebird > 0 ) & sdm_max_value > include_threshold ~ \"y\",\n    species %in% bowen_mammals$`Scientific name` ~ \"y\")\n  )\n# Create list of species names to include\nbowen_focal_list <- bowen_SDM_obs_focal_df %>%\n  filter(include == \"y\") %>%\n  select(species) %>%\n  unlist() %>%\n  unname() \n# Get filepath for each SDM\nbowen_SDM_iNat_ebird$filepath <- lapply(bowen_SDM_iNat_ebird$species, function(x) {paste0(str_replace(x, \" \", \".\"), \"_NAs_pu_mask.tif\")})\n# Add columns that can be adjusted manually\nbowen_SDM_iNat_ebird$prov_status <- \"\"\nbowen_SDM_iNat_ebird$fed_status <- \"\"\nbowen_SDM_iNat_ebird$IUCN_status <- \"\"\nbowen_SDM_iNat_ebird$weights <- 1.0\n# Dataframe for focal species on Bowen Island\nbowen_sdm_focal <- bowen_SDM_iNat_ebird %>%\n  filter(species %in% bowen_focal_list)\n#### UPLOAD ####\n# This sheet was uploaded to Google Sheets\n# WARNING: DO NOT RUN OR WILL OVERWRITE MANUAL INPUT TO GOOGLE SHEETS\n# write_sheet(bowen_sdm_focal,\n#             \"https://docs.google.com/spreadsheets/d/1ehO30w4i7EDafilNyRpq3sgc86fm8g_TmYMI4ql3qms/edit?usp=sharing\",\n#             \"species\")\nspecies_distribution_models_focal_bowen_info <- bowen_sdm_focal\nsave(species_distribution_models_focal_bowen_info, file = here(\"inst/extdata/species_distribution_models_focal_bowen_info.rda\"))\n```\n:::\n\n\n\n\n#### Creating Species Information Spreadsheet\n\nConservation statuses for species at the provincial, federal, and global levels were obtained from the BC Species & Ecosystems Explorer and the IUCN Red List. Provincial statuses followed the Red, Blue, and Yellow List classifications, while federal statuses were based on COSEWIC assessments where applicable. In cases of taxonomic discrepancies, species names were updated to reflect current classifications and documented accordingly.\n\nBC Species and Ecosystems Explorer: <https://a100.gov.bc.ca/pub/eswp/> IUCN Red List: <https://www.iucnredlist.org/>\n\nThe spreadsheet below contains all of the information on species name, taxon group, threatened status, weights to use for Zonation.\n\nVisit this link to view the spreadsheet, hosted on Google Drive. <https://docs.google.com/spreadsheets/d/1ehO30w4i7EDafilNyRpq3sgc86fm8g_TmYMI4ql3qms/edit?usp=sharing>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(here(\"inst/extdata/species_distribution_models_focal_bowen_info.rda\"))\n#### REVISION ####\n# - This section necessary, since Google Sheet was uploaded at earlier time\n# - Changes since made to the creation of Bowen SDM Focal\n# - Michael Tylo (USRA Spring 2025) did the work in the Google Sheet\n# Manually look up species and correct taxonomy, add conservation status\nsdm_googlesheet <- read_sheet(\"https://docs.google.com/spreadsheets/d/1ehO30w4i7EDafilNyRpq3sgc86fm8g_TmYMI4ql3qms/edit?usp=sharing\") %>%\n  select(!c(\"full_path\", \"filename\"))\n# Drop duplicate columns, keep columns for n eBird and iNaturalist observations, max SDM values\nbowen_sdm_focal_sel <- species_distribution_models_focal_bowen_info %>%\n  select(!c(\"taxon_group\", \"prov_status\", \"fed_status\", \"IUCN_status\", \"weights\"))\n# Merge\nbowen_sdm_status <- merge(bowen_sdm_focal_sel, sdm_googlesheet, by.x = \"species\", by.y = \"sci_name\", all.x = T) \nsave(bowen_sdm_status, file = here(\"inst/extdata/bowen_sdm_status.rda\"))\n```\n:::\n\n\n\n\n### Metro Vancouver Sensitive Ecosystems Inventory\n\nWe derived Habitat Type layers from the Metro Vancouver Sensitive Ecosystem Inventory (MVSEI) mapping app. Data was downloaded from the Open Data Catalogue as a GeoPackage. Habitats were grouped into three main categories: water, vegetation, and intertidal.\n\nWater subcategories included riparian fringe, riparian gully, wetland shallow water, freshwater lake, freshwater pond, and wetland, with bog, fen, and swamp habitats grouped under wetland.\n\nFor vegetation, we generated habitat layers for herbaceous coastal, herbaceous vegetated shoreline, sparse vegetation rocky outcrop, woodland conifer, woodland mixed, young forest conifer, young forest mixed, as well as broader categories of mature forest and old forest.\n\nIntertidal habitat layers included mudflats, eelgrass beds, and beaches.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### Metro Vancouver Sensitive Ecosystems Inventory ####\n# Contents of \"data-raw/metrovancouver_sensitive_ecosystem_inventory/\" downloaded from MetroVancouver Open Data Catalogue\n# GeoPackage download: https://arcg.is/TnfXL \n# Reports download: https://metrovancouver.org/services/regional-planning/sensitive-ecosystem-inventory-mapping-app\nmvsei <- st_read(here(\"data-raw/metrovancouver_sensitive_ecosystem_inventory/Sensitive_Ecosystem_Inventory_for_Metro_Vancouver__2020__-5580727563910851507.gpkg\")) %>%\n  st_transform(crs = sdm_crs)\n#> Reading layer `Sensitive_Ecosystem_Inventory_for_Metro_Vancouver__2020_' from data source `/home/jay/Programming_Projects/bowen.biodiversity.webapp/data-raw/metrovancouver_sensitive_ecosystem_inventory/Sensitive_Ecosystem_Inventory_for_Metro_Vancouver__2020__-5580727563910851507.gpkg' \n#>   using driver `GPKG'\n#> Simple feature collection with 25637 features and 99 fields\n#> Geometry type: MULTIPOLYGON\n#> Dimension:     XYZ\n#> Bounding box:  xmin: 468516.6 ymin: 5427679 xmax: 547072.5 ymax: 5495732\n#> z_range:       zmin: 0 zmax: 0\n#> Projected CRS: NAD83 / UTM zone 10N\n# Create directory to save SEI rasters \nsei_dir <- here(\"inst/extdata/bowen_sei_rasters\")\nif(!dir.exists(sei_dir)) {\n  dir.create(sei_dir)\n}\n# Load Bowen Island Mask Created Previously\nbowen_island_mask <- here(\"inst/extdata/bowen_mask.tif\") %>%\n  rast()\n# Bowen Island SEI \nbowen_sei <- mvsei %>% \n  st_intersection(st_as_sf(bowen_island_admin))\n#> Warning: attribute variables are assumed to be spatially constant throughout\n#> all geometries\n#### SEI sf Into spatRaster Function ####\nsei_raster_by_class <- function(sei, SECl, SEsubcl = NA, mask) {\n  # Filter by SEI classes\n  if(!is.na(SEsubcl)) {\n    selected_sei <- sei %>%\n      filter(SECl_1 == SECl | SECl_2 == SECl) %>%\n      filter(SEsubcl_1 == SEsubcl | SEsubcl_2 == SEsubcl)\n    sei_name <- paste0(SECl, \"_\", SEsubcl)\n  } else {\n    selected_sei <- sei %>%\n      filter(SECl_1 == SECl | SECl_2 == SECl) \n    sei_name <- SECl\n  }\n  output_rast <- selected_sei %>%\n    terra::vect() %>% # Change to SpatVector for rasterization\n    terra::project(mask) %>% # Reproject to the mask CRS\n    terra::rasterize(mask,\n                     touches = T,\n                     background = NA) # Rasterize to match mask, set background values to NA\n  names(output_rast) <- sei_name\n  return(output_rast)\n}\n#### Running SEI Function to Create Habitat Layers ####\n#### WATER\n# RI ff (riparian fringe)\nRI_ff <- sei_raster_by_class(sei = bowen_sei, SECl = \"RI\", SEsubcl = \"ff\", mask = bowen_island_mask)\n# RI gu (riparian gully)\nRI_gu <- sei_raster_by_class(sei = bowen_sei, SECl = \"RI\", SEsubcl = \"gu\", mask = bowen_island_mask)\n# WN sw (wetland shallow water)\nWN_sw <- sei_raster_by_class(sei = bowen_sei, SECl = \"WN\", SEsubcl = \"sw\", mask = bowen_island_mask)\n# FW la (freshwater lake)\nFW_la <- sei_raster_by_class(sei = bowen_sei, SECl = \"FW\", SEsubcl = \"la\", mask = bowen_island_mask)\n# FW pd (freshwater pond)\nFW_pd <- sei_raster_by_class(sei = bowen_sei, SECl = \"FW\", SEsubcl = \"pd\", mask = bowen_island_mask)\n# WN bo (bog)\nWN_bo <- sei_raster_by_class(sei = bowen_sei, SECl = \"WN\", SEsubcl = \"bo\", mask = bowen_island_mask)\n#> Warning: [SpatVector from sf] empty SpatVector\n# WN fn (fen)\nWN_fn <- sei_raster_by_class(sei = bowen_sei, SECl = \"WN\", SEsubcl = \"fn\", mask = bowen_island_mask)\n# WN sp (swamp)\nWN_sp <- sei_raster_by_class(sei = bowen_sei, SECl = \"WN\", SEsubcl = \"sp\", mask = bowen_island_mask)\n# WN (wetland) for bo, fn, sp\nWN_bo_fn_sp <- terra::allNA(c(WN_bo, WN_fn, WN_sp)) %>%\n  terra::as.int() %>% # TRUE FALSE to 1 0\n  classify(rbind(c(1, NA), c(0, 1))) # Change 1 to NA, 0 to 1 \nnames(WN_bo_fn_sp) <- \"WN_bo_fn_sp\"\n#### VEGETATION\n# HB cs (herbaceous coastal)\nHB_cs <- sei_raster_by_class(sei = bowen_sei, SECl = \"HB\", SEsubcl = \"cs\", mask = bowen_island_mask)\n# HB vs (herbaceous vegetated shoreline)\nHB_vs <- sei_raster_by_class(sei = bowen_sei, SECl = \"HB\", SEsubcl = \"vs\", mask = bowen_island_mask)\n# SV ro (sparse vegetation rocky outcrop)\nSV_ro <- sei_raster_by_class(sei = bowen_sei, SECl = \"SV\", SEsubcl = \"ro\", mask = bowen_island_mask)\n# WD co (woodland conifers)\nWD_co <- sei_raster_by_class(sei = bowen_sei, SECl = \"WD\", SEsubcl = \"co\", mask = bowen_island_mask)\n# WD mx (woodland mix)\nWD_mx <- sei_raster_by_class(sei = bowen_sei, SECl = \"WD\", SEsubcl = \"mx\", mask = bowen_island_mask)\n# YF co (young forest conifer)\nYF_co <- sei_raster_by_class(sei = bowen_sei, SECl = \"YF\", SEsubcl = \"co\", mask = bowen_island_mask)\n# YF mx (young forest mix)\nYF_mx <- sei_raster_by_class(sei = bowen_sei, SECl = \"YF\", SEsubcl = \"mx\", mask = bowen_island_mask)\n# MF (Mature Forest)\nMF <- sei_raster_by_class(sei = bowen_sei, SECl = \"MF\", mask = bowen_island_mask)\n# OF (Old Forest)\nOF <- sei_raster_by_class(sei = bowen_sei, SECl = \"OF\", mask = bowen_island_mask)\n#### INTERTIDAL\n## IT mf (Mudflats)\nIT_mf <- sei_raster_by_class(sei = bowen_sei, SECl = \"IT\", SEsubcl = \"mf\", mask = bowen_island_mask)\n## IT el (Eelgrass)\nIT_el <- sei_raster_by_class(sei = bowen_sei, SECl = \"IT\", SEsubcl = \"el\", mask = bowen_island_mask)\n## IT bs (Beaches)\nIT_bs <- sei_raster_by_class(sei = bowen_sei, SECl = \"IT\", SEsubcl = \"bs\", mask = bowen_island_mask)\n#### EXPORT AS RASTER AND DOCUMENT LAYERS IN CSV ####\nsei_rasters <- c(RI_ff, RI_gu, FW_la, FW_pd, WN_sw, WN_bo_fn_sp, HB_cs, HB_vs, SV_ro, WD_co, WD_mx, YF_co, YF_mx, MF, OF, IT_mf, IT_el, IT_bs)\nsei_rasters %>%\n  lapply(function(x) {\n    sei_name <- names(x)\n    writeRaster(x, here(sei_dir, paste0(sei_name, \".tif\")), overwrite=TRUE)\n  })\n#> [[1]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : RI_ff.tif \n#> name        : RI_ff \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[2]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : RI_gu.tif \n#> name        : RI_gu \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[3]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : FW_la.tif \n#> name        : FW_la \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[4]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : FW_pd.tif \n#> name        : FW_pd \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[5]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : WN_sw.tif \n#> name        : WN_sw \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[6]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : WN_bo_fn_sp.tif \n#> name        : WN_bo_fn_sp \n#> min value   :           1 \n#> max value   :           1 \n#> \n#> [[7]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : HB_cs.tif \n#> name        : HB_cs \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[8]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : HB_vs.tif \n#> name        : HB_vs \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[9]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : SV_ro.tif \n#> name        : SV_ro \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[10]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : WD_co.tif \n#> name        : WD_co \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[11]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : WD_mx.tif \n#> name        : WD_mx \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[12]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : YF_co.tif \n#> name        : YF_co \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[13]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : YF_mx.tif \n#> name        : YF_mx \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[14]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : MF.tif \n#> name        : MF \n#> min value   :  1 \n#> max value   :  1 \n#> \n#> [[15]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : OF.tif \n#> name        : OF \n#> min value   :  1 \n#> max value   :  1 \n#> \n#> [[16]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : IT_mf.tif \n#> name        : IT_mf \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[17]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : IT_el.tif \n#> name        : IT_el \n#> min value   :     1 \n#> max value   :     1 \n#> \n#> [[18]]\n#> class       : SpatRaster \n#> dimensions  : 108, 96, 1  (nrow, ncol, nlyr)\n#> resolution  : 100, 100  (x, y)\n#> extent      : 1186388, 1195988, 482587.5, 493387.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. : +proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \n#> source      : IT_bs.tif \n#> name        : IT_bs \n#> min value   :     1 \n#> max value   :     1\nsei_rasters_df <- data.frame(sei_habitat = names(sei_rasters))\nsei_rasters_df$filepath <- paste0(sei_rasters_df$sei_habitat, \".tif\")\nsei_rasters_df$weights <- 1.0\nsave(sei_rasters_df, file = here(\"inst/extdata/\", \"bowen_sei_rasters_info.rda\"))\nwrite.csv(sei_rasters_df, here(\"inst/extdata/\", \"bowen_sei_rasters_info.csv\"))\n```\n:::\n\n\n\n\n### Human Disturbance\n\nWe followed the methods from Arias-Patino et al. (2024) for the human disturbance layers included in the analyses. Pressures included urban areas, buildings, population density, roads, railways, navigable waterways, transmission lines, seismic lines, pipelines, mining, dams and reservoirs, oil and gas infrastructure, agriculture, pastures, forest harvesting, and recreation features. We reclassified the human disturbance raster into four levels based on intensity of disturbance: intact, low disturbance, medium disturbance, and high disturbance. We then normalized and inverted the values to prepare the disturbance data for input into Zonation, ensuring that areas with less disturbance correspond to higher values on a 0-1 scale.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### Human Disturbance #### \n# Contents of \"data-raw/human_disturbance/\" received from Miguel Arias Patino (marias@unbc.ca)\n# https://1sfu.sharepoint.com/:f:/r/teams/Cumulativeeffects-SFUTeams9/Shared%20Documents/General/BC%20Hydro%202025%20IRP/Environmental%20Layers/Human%20Footprint?csf=1&web=1&e=hUYDs7 \n# Thesis (methods): https://unbc.arcabc.ca/islandora/object/unbc%3A59107\n# Paper (methods): https://doi.org/10.1016/j.ecolind.2024.112407 \n# Paper (methods): https://doi.org/10.1139/facets-2021-0063  \ndisturb_path <- here(\"data-raw/human_disturbance/human_footprint_30m_v2.tif\")\ndisturb <- terra::rast(disturb_path)\n# Load Bowen Island Mask Created Previously\nbowen_island_mask <- here(\"inst/extdata/bowen_mask.tif\") %>%\n  rast()\n#### Resample Raster to Bowen Island ####\ndisturb_resamp <- terra::resample(disturb, bowen_island_mask)\nwriteRaster(disturb_resamp, \n            here::here(\"inst/extdata\", \"bowen_human_footprint.tif\"), \n            overwrite=TRUE)\n#### Reclassify Raster to Intact, Low, Medium, High ####\n# https://www.facetsjournal.com/doi/10.1139/facets-2021-0063#sec-2 \n# Intact is 0 to 1 \n# Low disturbance is 1 to 4\n# Medium disturbance is 4 to 10\n# High disturbance is 10+ \n# Maximum theoretical value is 66\ndisturb_m <- c(0, 1, 0,\n       1, 4, 1,\n       4, 10, 2,\n       10, 100, 3) %>%\n  matrix(ncol = 3, byrow = T)\n# Reclassify disturbance to levels\ndisturb_recl <- disturb_resamp %>%\n  classify(disturb_m, include.lowest = T)\nwriteRaster(disturb_recl, \n            here::here(\"inst/extdata\", \"bowen_human_footprint_recl.tif\"), \n            overwrite=TRUE)\n#### Inverse Disturbance ####\n#' Normalize on 0 to 1 scale\nnormalize <- function(input_rast) {\n  mm <- minmax(input_rast)\n  min <- mm[1]\n  max <- mm[2]\n  normalized <- (input_rast - min) / (max - min)\n}\n#' Invert raster, so max values are min and vice versa. \ninvert <- function(input_rast) {\n  mm <- minmax(input_rast)\n  max <- mm[2]\n  inverted <- max - input_rast \n}\n# Normalize and invert the disturbance, so its positive as Zonation input\ndisturb_inv <- disturb_resamp %>% \n  normalize() %>%\n  invert()\nwriteRaster(disturb_inv, here(\"inst/extdata/bowen_human_footprint_inv.tif\"), overwrite=TRUE)\n\n```\n:::\n\n\n\n\n## Zonation\n\n> Zonation 5 is a spatial prioritization software that can be used to identify priority areas to support conservation planning, land use planning, ecological impact avoidance and other similar tasks. The software uses spatial raster data on the distributions of individual biodiversity features (species, habitats, ecosystem services etc.) to identify which locations in a landscape are most important for retaining biodiversity. Zonation can account for local habitat quality and ecological connectivity together with costs, threats and different land tenure, thus providing a quantitative method for spatial planning that enhances the persistence of biodiversity in the long term.\n\n<https://zonationteam.github.io/Zonation5/>\n\nWe took all of the rasters prepared earlier and fed these into the Zonation 5 software. This should provide a relative ranking for locations from highest to lowest for the purposes of biodiversity conservation.\n\n**Note:** Zonation 5 is usually a standalone application. Here, I have enabled running of \nZonation from R, using command line functions. This way we can adjust and automatically\nrun Zonation, reading from data in R. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### CREATE DATAFRAME FOR INPUT LAYERS ####\n# Bowen Island SDM Table\nload(here(\"inst/extdata/bowen_sdm_status.rda\"))\nbowen_sdm_rasters_df <- bowen_sdm_status %>% \n  select(species, filepath, weights) %>%\n  rename(group = species)\nbowen_sdm_rasters_df$filepath <- bowen_sdm_rasters_df$filepath %>% unlist()\nbowen_sdm_rasters_df$type <- \"sdm\"\n# Bowen Island SEI Table\nload(here(\"inst/extdata/bowen_sei_rasters_info.rda\")) \nsei_rasters_df <- sei_rasters_df %>% \n  select(sei_habitat, filepath, weights) %>%\n  rename(group = sei_habitat)\nsei_rasters_df$type <- \"habitat\"\n# Bowen Island Disturbance\ndisturb_rasters_df <- data.frame(filepath = \"bowen_human_footprint_inv.tif\",\n                                 weights = 1.0)\ndisturb_rasters_df$type <- \"habitat\"\n# Bind all input layers together\nlayers_df <- bind_rows(bowen_sdm_rasters_df, sei_rasters_df, disturb_rasters_df)\n#### Set weights based on \"species\" and \"habitat\" type so 50/50 weight\n# Get SDM weight\nn_sdm <- layers_df %>%\n  filter(type == \"sdm\") %>%\n  nrow()\nweight_sdm <- 1/n_sdm\n# Get habitat weight\nn_habitat <- layers_df %>%\n  filter(type == \"habitat\") %>%\n  nrow()\nweight_habitat <- 1/n_habitat\n# Set weights\nlayers_df <- layers_df %>%\n  mutate(\n    weights = case_when(\n      type == \"sdm\" ~ weight_sdm,\n      type == \"habitat\" ~ weight_habitat\n    )\n  )\n#### Get fullpaths for filenames in inst/extdata\nrasters_df <- data.frame(fullpath = here(\"inst/extdata/\", list.files(path = here(\"inst/extdata\"), recursive = T, pattern = \"*.tif$\")))\nrasters_df$filepath <- basename(rasters_df$fullpath)\n# Merge with weights\nweights_df <- merge(layers_df, rasters_df, by = \"filepath\")\nweights_df$relpath <- weights_df$fullpath %>%\n  gsub(paste0(here(),\"/\"), \"\", .) # Prepare paths for Shiny app \nsave(weights_df, file = here(\"inst/extdata/weights_df.rda\"))\n#### CREATE features.txt FOR ZONATION RUN ####\n# Create features.txt from files available in data\nfeatures_path <- here(\"vignettes/zonation/features.txt\")\ncat('\"weight\" \"filename\"', \n    file = features_path,\n    sep = \"\\n\")\nfor(i in 1:nrow(weights_df)) {\n  next_row <- paste0(weights_df[i, \"weights\"], \" \", weights_df[i, \"fullpath\"])\n  cat(next_row,\n      file = features_path,\n      append = TRUE,\n      sep = \"\\n\")\n}\n#### SET PARAMS FOR ZONATION RUN ####\nzonation5_location <- here(\"vignettes/zonation/zonation5\") \nzonation5_mode <- \"CAZ2\"\n# Zonation5 Setting Text File\nzonation5_settings <-  here(\"vignettes/zonation/settings.z5\")\nzonation5_settings_txt <- c(\"feature list file = features.txt\", \n                            paste0(\"analysis area mask layer = \", here(\"inst/extdata/bowen_mask.tif\"))) # Add Bowen Island Mask\nwriteLines(zonation5_settings_txt, zonation5_settings)\nzonation5_output <- here(\"vignettes/zonation/output\") \nzonation5_command <- str_glue(\n  '{zonation5_location} -a --mode={zonation5_mode} {zonation5_settings} {zonation5_output}',\n  zonation5_location = zonation5_location,\n  zonation5_mode = zonation5_mode,\n  zonation5_settings = zonation5_settings,\n  zonation5_output = zonation5_output\n) %>%\n  str_c()\n#### ZONATION RUN ####\nsystem(command = zonation5_command)\n```\n:::\n\n\n\n\n## Output\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### VISUALIZE OUTPUT ####\nrankmap <- here(\"vignettes/zonation/output/rankmap.tif\") %>% rast()\nplot(rankmap)\n```\n\n::: {.cell-output-display}\n![](output_zonation_01_02_2025_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "output_zonation_01_02_2025_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}