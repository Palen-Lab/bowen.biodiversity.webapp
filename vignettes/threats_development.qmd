---
title: "Threats: Development"
author: "Jay Matsushiba"
date: "2025/04/25"
format:
  html:
    code-fold: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 7
)
```

This vignette describes the first-look exploration and analysis with the BC Assessment data, providing sales history and values of real estate properties throughout British Columbia. The purpose for utilizing this data is to create some spatial layer for modelling development pressures on Bowen Island.

Data citation: BC Assessment, 2020, "BC Assessment Data Advice and Inventory Extracts, 2016-2022", <https://hdl.handle.net/11272.1/AB2/LAPUAB>, Abacus Data Network, V6

```{r setup}
library(bowen.biodiversity.webapp)
library(sf)
library(terra)
library(here)
library(tidyverse)
library(leaflet)
```

## BC Assessment Sales Data

This section deals with the data wrangling steps for the Bowen Island sales information. This data wrangling assumes that prices only increase, so lowest prices are associated with the earlier sale dates and vice versa.

```{r bca_sales}
bowen_sales_history <- here("data-raw/bc_assessment/bca_folios_spatial_file_20230103/bca_folios.gpkg.gpkg") %>%
  # Bowen Island Municipality JURISDICTION_CODE is 321
  st_read(query = 'SELECT * FROM WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_SALES_SV WHERE JURISDICTION_CODE LIKE 321') 

# Assumes that first date is lowest price, last date is highest price
bowen_sales_summary  <- bowen_sales_history %>%
  # Drop spatial geometry, join back later
  st_drop_geometry() %>%
  # Remove invalid sales 
  filter(CONVEYANCE_TYPE_DESCRIPTION != "Reject - Not Suitable for Sales Analysis") %>%
  # Group by individual properties, since each transaction separate row
  group_by(FOLIO_ID) %>%
  summarise(first_date = min(CONVEYANCE_DATE),
            last_date = max(CONVEYANCE_DATE),
            lowest_price = min(CONVEYANCE_PRICE),
            highest_price = max(CONVEYANCE_PRICE),
            n_distinct = n_distinct(CONVEYANCE_TYPE_DESCRIPTION) # Show whether land was developed or sold as empty land
            ) %>%
  mutate(change_type = case_when(n_distinct > 1 ~ "changed", .default = "unchanged")) %>% # Show whether land was developed or sold as empty land
  mutate(days_span = as.double(last_date - first_date, units = "days")) %>% # Number of days between first available and most recent sale
  mutate(price_days_slope = (highest_price - lowest_price)/days_span) %>% # Change in price divided by number of days 
  filter(!is.infinite(price_days_slope) & !is.na(price_days_slope)) # Remove invalid price changes (ex. property has no records of being sold in open market)
```

### BC Assessment Line Plot

Each property is one line segment on this plot with start and end points. The start point is the lowest price and first available sale date. The end point is the highest price and most recent sale date.

```{r line_plot}
ggplot(bowen_sales_summary) +
  geom_segment(aes(x = first_date, xend = last_date, y = lowest_price, yend = highest_price, colour = change_type), alpha = 0.2) +
  xlab("Dates") +
  ylab("Price (CAD)")
```

### BC Assessment Interactive Map

Properties that have available change in price over time are plotted on an interactive Leaflet map.

```{r spatial_leaflet}
# Join with spatial data
bowen_folio_addresses <- here("data-raw/bc_assessment/bca_folios_spatial_file_20230103/bca_folios.gpkg.gpkg") %>%
  st_read(query = 'SELECT * FROM WHSE_HUMAN_CULTURAL_ECONOMIC_BCA_FOLIO_ADDRESSES_SV WHERE JURISDICTION_CODE LIKE 321') 

bowen_sales_summary_sf <- merge(bowen_sales_summary, bowen_folio_addresses) %>%
  rename(geometry = geom) %>%
  st_as_sf() %>%
  st_transform(4326)

# LEAFLET
bins <- c(0, 10, 20, 50, 100, 200, 500, 1000, Inf)
pal <- colorBin("YlOrRd", domain = bowen_sales_summary_sf$price_days_slope, bins = bins)
leaflet(bowen_sales_summary_sf) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#444444", weight = 0.5,,
              fillColor = ~pal(price_days_slope),
              fillOpacity = 0.7
              ) %>%
  addLegend(pal = pal, values = ~price_days_slope)
```
