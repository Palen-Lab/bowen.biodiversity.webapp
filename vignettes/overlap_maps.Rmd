---
title: "overlap_maps"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{overlap_maps}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(bowen.biodiversity.webapp)
library(terra)
library(sf)
library(here)
library(tidyterra)
library(ggplot2)
library(basemaps)
```

```{r}
# Zonation5 input layers logic ----
species_df <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1ehO30w4i7EDafilNyRpq3sgc86fm8g_TmYMI4ql3qms/edit?usp=sharing") %>%
  dplyr::rename(layer_name = sci_name)
environmental_df <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1S7U53ukf74y3YaCDZUUSCh2Rv_wpbdZ4veH-BotoQKo/edit?gid=0#gid=0")
# Combine Species and Environmental df for now
layers_df <- dplyr::bind_rows(species_df, environmental_df)
```

# Creating Raster Layers for Overlap Maps

```{r}
zonation5(layers_df)
filepath <- here("inst", "app", "zonation", "zonation_output", "rankmap.tif")
zonation_rast <- terra::rast(filepath)

top_20_value <- zonation_rast %>%
  values() %>%
  quantile(probs = .8, na.rm = T)

m <- matrix(c(
  0, top_20_value, NA,
  top_20_value, 1, 1
), ncol = 3, byrow = T)
zonation_rast_0.2 <- zonation_rast %>%
  classify(m) 

human_footprint_filepath <- environmental_df[environmental_df$layer_name == "Human Footprint", "full_path"] %>% unlist()
human_footprint <- terra::rast(here(human_footprint_filepath)) %>%
  terra::project(zonation_rast_0.2) 
# Reverse so that high value (closer to 1) of human footprint means higher disturbance
human_footprint <- (1 - human_footprint)

human_footprint_zonation_0.2 <- zonation_rast_0.2 * human_footprint
```

# Plotting Human Footprint
```{r}
bowen_map_2 <- function(raster_layer,
                      title,
                      subtitle,
                      caption,
                      legend_label) {
  bowen_trails <- here::here("data-raw/Trails/Trails.shp") %>% sf::st_read()
  bowen_roads <- here::here("data-raw/Roads/Bowen_Road_Inventory.shp") %>% sf::st_read()
  bowen_shoreline <- here::here("data-raw/shoreline_dem_smoothed2/shoreline_dem_smoothed2.shp") %>% sf::st_read()

  # basemap_for_plot <- basemaps::basemap_terra(ext = raster_layer, map_service = "carto", map_type = "voyager")
  basemap_for_plot <- basemap_terra(ext = raster_layer,
                      map_service = "maptiler",
                      map_type = "backdrop",
                      map_token = "baL4WLstSFqSHP2fnYrE")


  output_plot <- ggplot2::ggplot() +
    ggplot2::theme_bw() +
    tidyterra::geom_spatraster_rgb(data = basemap_for_plot) +
    tidyterra::geom_spatraster(data = raster_layer) +
    geom_sf(data = bowen_shoreline, fill = NA) +
    ggplot2::scale_fill_continuous(
      na.value = NA,
      type = "viridis",
      # limits = c(0,1),
      # breaks = c(0, 0.5, 1),
      guide = ggplot2::guide_colourbar(nbin = 100,
                                       draw.ulim = FALSE,
                                       draw.llim = FALSE,
                                       title.position = "top"
                                       # title.hjust = 0.5
      ),
      name = legend_label
    ) +
    ggplot2::geom_sf(data = bowen_trails,
                     aes(color = "Trails")
    ) +
    ggplot2::geom_sf(data = bowen_roads,
                     aes(color = "Roads")
    ) +
    scale_color_manual(
      values = c("#5c5c5c", "darkgrey", "lightgrey"),
      guide = ggplot2::guide_legend(title = NULL,
                                    theme = ggplot2::theme(
                                      legend.text = element_text(size = 10, margin = margin(r = 5, l = 5, b = 5)),
                                      legend.text.position = "top"
                                    ))
    ) +
    ggplot2::scale_x_continuous(expand = c(0,0)) +
    ggplot2::scale_y_continuous(expand = c(0,0)) +
    ggplot2::labs(
      title = title,
      subtitle = subtitle,
      caption = caption
    ) +
    ggplot2::theme(
      plot.title = ggplot2::element_text(
        size = 18,
        margin = ggplot2::margin(0, 0, 10, 0)
      ),
      plot.subtitle = ggtext::element_textbox_simple(
        lineheight = 1.5,
        margin= ggplot2::margin(0, 0, 10, 0)
      ),
      axis.text.y = ggplot2::element_text(
        angle = 90, vjust = 1, hjust = 0.5
      ),
      legend.position = "bottom",
      legend.title = ggplot2::element_text(size = 10),
      legend.key.height = ggplot2::unit(0.5, "cm"),
      legend.key.width = ggplot2::unit(1.5, "cm"),
      legend.direction = "horizontal",
      legend.box = "horizontal",
      plot.margin = unit(c(1.3,0.3,0.8,0), "cm")
    ) +
    ggspatial::annotation_scale(
      location = "br",
      bar_cols = c("grey60", "white")
    ) +
    ggspatial::annotation_north_arrow(
      location = "br", which_north = "true",
      pad_x = unit(0.2, "in"), pad_y = unit(0.4, "in"),
      style = ggspatial::north_arrow_nautical(
        fill = c("grey40", "white"),
        line_col = "grey20"
      )
    )

}

human_footprint_plot <- bowen_map_2(human_footprint_zonation_0.2,
                                    title = "Biodiversity Hotspots and Human Footprint",
                                    subtitle = "Top 20% of biodiversity locations on Bowen Island, with scale corresponding to relative human disturbance. Higher values, towards 1.0, indicate higher levels of disturbance from human activity. Lower values, towards 0.0, show lower levels of disturbance.",
                                    caption = "Jay Matsushiba January 13 2025",
                                    legend_label = "Human Disturbance")

ggplot2::ggsave(
  paste0("figures/", Sys.Date(), "_human_footprint_plot.png"),
  human_footprint_plot,
  device = ragg::agg_png,
  width = 9, height = 12, units = "in", res = 300
)
```
# Private Land / Municipal / Crown 
```{r}
crown <- st_read("/media/jay/2TB_Drive/2024_Bowen_Biodiversity_Project/BOWEN GIS LAYERS BY JOHN /Crown-Land-JD.gpkg")
# this layer has a bunch of other stuff outside of crown land, such as parks / protections
```


# Existing Protections
Includes covenants layer
```{r}
covenants <- st_read("/media/jay/2TB_Drive/2024_Bowen_Biodiversity_Project/BOWEN GIS LAYERS BY JOHN /BI-Covenant-Catalogue-Layer 1.3.2.gpkg")
alr <- st_read("/media/jay/2TB_Drive/2024_Bowen_Biodiversity_Project/BOWEN GIS LAYERS BY JOHN /Bowen-ALR-Lands-JD.gpkg")
ogma <- st_read("/media/jay/2TB_Drive/2024_Bowen_Biodiversity_Project/BOWEN GIS LAYERS BY JOHN /Bowen-OGMAs-JD.gpkg")
```


# Wetlands / Freshwater Lakes 
```{r}

```

