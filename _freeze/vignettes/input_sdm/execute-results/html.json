{
  "hash": "d5174a7f47b079b958df28dc6cdb500e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Conservation Layer: Species\"\nauthor: \"Jay Matsushiba\"\ndate: \"2025/04/25\"\nformat:\n  html:\n    code-fold: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\n#### Palen Lab Packages ####\nlibrary(bowen.biodiversity.webapp)\n\n#### Other Packages ####\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nhere() starts at /home/jay/Programming_Projects/bowen.biodiversity.webapp\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(stringr)\nlibrary(foreach)\nlibrary(sf)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLinking to GEOS 3.11.1, GDAL 3.6.4, PROJ 9.1.1; sf_use_s2() is TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(terra)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nterra 1.8.5\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(tidyterra)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'tidyterra'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:stats':\n\n    filter\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(readxl)\nlibrary(googlesheets4)\n```\n:::\n\n\n\n\n## Species Distribution Models\n\nThe species distribution models (SDMs) included in the Bowen Island Conservation Plan analyses were originally produced by Viorel Popescu (Popescu et al., 2020). Out of the 341 SDMs available, we included 193 of the SDMs. Occurrence locations of small vertebrate species were gathered from Global Biodiversity Information Facility (data.gbif.org) and Nature Counts (birdscanada.org/birdmon) open-access databases. Inclusion of small mammal species was based on Appendix 2 & 3 from the 2005 Environmental Inventory report, which states species presence on Bowen Island. We used the iNaturalist and eBird databases of observations for the inclusion criteria for reptiles, amphibians, and birds (described in further detail in Methods).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### SPECIES DISTRIBUTION MODELS ####\n# Contents of \"data-raw/species_distribution_models/\" downloaded from Cumulative effects - SFU Teams Sharepoint \n# https://1sfu.sharepoint.com/:f:/r/teams/Cumulativeeffects-SFUTeams9/Shared%20Documents/BCH_project_backup/SPECIES?csf=1&web=1&e=FpNkgc \n# Directory Path: BCH_project_backup/SPECIES/\n# Paper: https://www.nature.com/articles/s41598-020-64501-7#MOESM1\n# See Wendy Palen (SFU) for access \n#### PROCESSING SDM ####\n# Get list of available SDMs\nsdm_folder <- here(\"data-raw/species_distribution_models\")\nsdm_folder_tif <- list.files(sdm_folder, recursive = T, pattern = \"*.tif$\") # Get only .tif files\n# Correspondence with Viorel Popescu confirms that _NAs_ should be SDMs with rock, ice, large lakes layers masked\nsdm_folder_tif_NAs <- sdm_folder_tif[grepl(\"_NAs_\", sdm_folder_tif)] # Get only .tif with \"_NAs_\" in filename\n# Directory to save SDMs\nsdm_output_dir <- here(\"inst/extdata/sdm\")\nif(!dir.exists(sdm_output_dir)) {\n  dir.create(sdm_output_dir)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create Bowen Island mask using DSM\nsample_sdm <- rast(here(sdm_folder, sdm_folder_tif_NAs[1])) %>%\n  terra::project(y = sdm_crs) %>%\n  terra::crop(bowen_island_admin, snap = \"out\") %>%\n  terra::disagg(fact = 4)\ndsm <- rast(here(\"data-raw/bowen_dsm/chm.tif\"))\ndsm_smooth <- dsm %>% \n  focal(w=9, fun=mean, na.policy=\"only\", na.rm=T) %>% \n  terra::project(y = sdm_crs) %>%\n  terra::resample(sample_sdm, method = \"average\")\nm <- c(-1, 35, 1) %>% matrix(ncol = 3, byrow=T)\nbowen_island_mask <- dsm_smooth %>% \n  classify(m) %>%\n  as.int()\nwriteRaster(bowen_island_mask, here(\"inst/extdata/bowen_mask.tif\"), overwrite = T)\n# Weights for terra::focal() function that provides moving window average\n# - Smoothing algorithm \n# - Use this to fill some empty cells on Bowen Island with weighted mean of the neighbouring cells.\nweights <- matrix(c(0, 0, 1, 1, 1, 0, 0,\n                    0, 1, 1, 2, 1, 1, 0,\n                    1, 1, 3, 3, 3, 1, 1,\n                    1, 2, 3, 5, 3, 2, 1,\n                    1, 1, 3, 3, 3, 1, 1,\n                    0, 1, 1, 2, 1, 1, 0,\n                    0, 0, 1, 1, 1, 0, 0\n), nrow=7)\n#### PREPARE SDMs TO BOWEN ISLAND ####\n# Loop through SDMs\nforeach(sdm_tif = sdm_folder_tif_NAs) %do% {\n  sdm_path <- here(sdm_folder, sdm_tif) \n  sdm_output_path <- here(sdm_output_dir, basename(sdm_tif))\n  sdm <- rast(sdm_path)\n  # Normalize SDMs that range from 0 to 1000\n  sdm_minmax <- terra::minmax(sdm)\n  if(sdm_minmax[2] > 1) {\n    sdm <- sdm / 1000\n  }\n  sdm_output <- sdm %>%\n    #### Reproject SDM ####\n    terra::project(y = sdm_crs) %>%\n    #### Crop SDM ####\n    # Figured out why the SDMs were cropped incorrectly\n    # The default for cropping a raster by a polygon is to snap = \"near\"\n    # This means that the polygon extent is snapped to the closest raster\n    # We need snap = \"out\" to make sure the full extent of the polygon is covered by the output raster\n    terra::crop(bowen_island_admin, snap = \"out\") %>%\n    #### Extrapolate for Southern Parts of Bowen Island\n    # - fills the NA values missing in south part of Bowen Island\n    terra::focal(w = weights,\n                 fun = \"mean\",\n                 na.policy = \"only\") %>%\n    #### Downsamples ####\n    # - from 400 m to 100 m resolution\n    terra::disagg(fact = 4) %>%\n    #### Smooths the raster ####\n    terra::focal(w = weights,\n                 fun = \"mean\",\n                 na.rm = T,\n                 na.policy = \"omit\") %>%\n    terra::mask(bowen_island_mask)\n  \n  writeRaster(sdm_output, sdm_output_path, overwrite = T)\n}\n# Create species list from available SDMs\nspecies_list <- sdm_folder_tif_NAs %>%\n  basename() %>%\n  stringr::str_extract(\"^\\\\S+\\\\.[a-zA-Z]+_\") %>%\n  stringr::str_remove(\"_\") %>%\n  stringr::str_replace(\"\\\\.\", \" \")\n# Create taxon list \ntaxon_list <- sdm_folder_tif_NAs %>%\n  dirname() %>%\n  str_remove(\"_mask\")\n# Get iNaturalist and SDM congruence\nsdm_inat <- foreach(i = 1:length(species_list), .combine = \"rbind\") %do% {\n  # Progress Message \n  print(paste0(\"Currently working on species \", i, \" out of \", length(species_list),\". This is \", species_list[i], \".\"))\n  # Query iNaturalist by species name and Bowen Island Administrative Boundaries\n  rinat_results_sf <- tryCatch({\n    Sys.sleep(3) # Need to slow down queries to prevent requests being blocked\n    rinat::get_inat_obs_sf(taxon_name = species_list[i],\n                           area = st_as_sf(bowen_island_admin),\n                           maxresults = 10000)\n  }, error = function(cond) {\n    NA\n  })\n  # Get number of iNaturalist observations\n  if(!is.data.frame(rinat_results_sf)) {\n    inat_n_obs <- 0\n  } else {\n    inat_n_obs <- nrow(rinat_results_sf)\n  }\n  # Get Bowen Island SDM\n  sdm <- paste0(str_replace(species_list[i], \" \", \".\"), \"_NAs_pu_mask.tif\") %>%\n    here(sdm_output_dir, .) %>%\n    rast()\n  # Get highest value in SDM\n  sdm_max <- sdm %>% \n    minmax() %>% \n    max()\n  # PREPARE OUTPUT ROW\n  # 1. scientific species name\n  # 2. highest SDM cell value within area \n  # 3. observation count from iNaturalist\n  result <- data.frame(species = species_list[i],\n                       sdm_max_value = sdm_max,\n                       inat_n_obs = inat_n_obs)\n}\nsdm_inat$taxon_group <- taxon_list\n#### Query eBird for birds ####\n# Number of eBird observations by bird species on Bowen Island\n# - Results from Natasha Beauregard (Summer 2024 USRA)\nbowen_ebird <- read.csv(here(\"data-raw/bowen_ebird/final_bird.csv\")) %>%\n  select(c(\"scientific_name\", \"n_ebird\"))\n# Combine eBird and iNaturalist counts\nbowen_SDM_iNat_ebird <- merge(sdm_inat, \n                              bowen_ebird, \n                              by.x = \"species\", \n                              by.y = \"scientific_name\",\n                              all.x = TRUE) %>%\n  rename(n_obs_inat = inat_n_obs,\n         n_obs_ebird = n_ebird) %>%\n  select(\n    species,\n    sdm_max_value,\n    taxon_group,\n    n_obs_inat,\n    n_obs_ebird\n  )\n# Query Pottinger Report (2005) for small mammals\nbowen_mammals <- read_xlsx(here(\"data-raw/pottinger_report/Appendix 2 - Expected Occurrence of Wildlife Species In The Cape Roger Curtis Area.xlsx\")) %>%\n  filter(`Documented on Bowen` == \"y\" | `Documented on Bowen` == \"?\" | `Documented on Bowen` == \"One or more spp\" )\n# Include Species if they meet any of the following criteria:\n# - eBird observations > 0\n# - iNaturalist observations > 0\n# - included in Pottinger Report \ninclude_threshold <- 0.5 # Min SDM cell value somewhere on Bowen Island for including species into focal list\nbowen_SDM_obs_focal_df <- bowen_SDM_iNat_ebird %>%\n  mutate(include = case_when(\n    (n_obs_inat > 0 | n_obs_ebird > 0 ) & sdm_max_value > include_threshold ~ \"y\",\n    species %in% bowen_mammals$`Scientific name` ~ \"y\")\n  )\n# Create list of species names to include\nbowen_focal_list <- bowen_SDM_obs_focal_df %>%\n  filter(include == \"y\") %>%\n  select(species) %>%\n  unlist() %>%\n  unname() \n# Get filepath for each SDM\nbowen_SDM_iNat_ebird$filepath <- lapply(bowen_SDM_iNat_ebird$species, function(x) {paste0(str_replace(x, \" \", \".\"), \"_NAs_pu_mask.tif\")})\n# Add columns that can be adjusted manually\nbowen_SDM_iNat_ebird$prov_status <- \"\"\nbowen_SDM_iNat_ebird$fed_status <- \"\"\nbowen_SDM_iNat_ebird$IUCN_status <- \"\"\nbowen_SDM_iNat_ebird$weights <- 1.0\n# Dataframe for focal species on Bowen Island\nbowen_sdm_focal <- bowen_SDM_iNat_ebird %>%\n  filter(species %in% bowen_focal_list)\n#### UPLOAD ####\n# This sheet was uploaded to Google Sheets\n# WARNING: DO NOT RUN OR WILL OVERWRITE MANUAL INPUT TO GOOGLE SHEETS\n# write_sheet(bowen_sdm_focal,\n#             \"https://docs.google.com/spreadsheets/d/1ehO30w4i7EDafilNyRpq3sgc86fm8g_TmYMI4ql3qms/edit?usp=sharing\",\n#             \"species\")\nspecies_distribution_models_focal_bowen_info <- bowen_sdm_focal\nsaveRDS(species_distribution_models_focal_bowen_info, file = here(\"inst/extdata/sdm/sdm_focal.rds\"))\n```\n:::\n\n\n\n\n### Creating Species Information Spreadsheet\n\nConservation statuses for species at the provincial, federal, and global levels were obtained from the BC Species & Ecosystems Explorer and the IUCN Red List. Provincial statuses followed the Red, Blue, and Yellow List classifications, while federal statuses were based on COSEWIC assessments where applicable. In cases of taxonomic discrepancies, species names were updated to reflect current classifications and documented accordingly.\n\nBC Species and Ecosystems Explorer: <https://a100.gov.bc.ca/pub/eswp/> IUCN Red List: <https://www.iucnredlist.org/>\n\nThe spreadsheet below contains all of the information on species name, taxon group, threatened status, weights to use for Zonation.\n\nVisit this link to view the spreadsheet, hosted on Google Drive. <https://docs.google.com/spreadsheets/d/1ehO30w4i7EDafilNyRpq3sgc86fm8g_TmYMI4ql3qms/edit?usp=sharing>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsdm_focal <- readRDS(here(\"inst/extdata/sdm/sdm_focal.rds\"))\n#### REVISION ####\n# - This section necessary, since Google Sheet was uploaded at earlier time\n# - Changes since made to the creation of Bowen SDM Focal\n# - Michael Tylo (USRA Spring 2025) did the work in the Google Sheet\n# Manually look up species and correct taxonomy, add conservation status\nsdm_googlesheet <- read_sheet(\"https://docs.google.com/spreadsheets/d/1ehO30w4i7EDafilNyRpq3sgc86fm8g_TmYMI4ql3qms/edit?usp=sharing\") %>%\n  select(!c(\"full_path\", \"filename\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nℹ Suitable tokens found in the cache, associated with these emails:\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n• 'hello@jmatsushiba.com'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n• 'palenlab@gmail.com'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n  Defaulting to the first email.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n! Using an auto-discovered, cached token.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n  To suppress this message, modify your code or options to clearly consent to\n  the use of a cached token.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n  See gargle's \"Non-interactive auth\" vignette for more details:\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n  <https://gargle.r-lib.org/articles/non-interactive-auth.html>\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nℹ The googlesheets4 package is using a cached token for\n  'hello@jmatsushiba.com'.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n✔ Reading from \"species_layers\".\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n✔ Range 'species'.\n```\n\n\n:::\n\n```{.r .cell-code}\n# Drop duplicate columns, keep columns for n eBird and iNaturalist observations, max SDM values\nbowen_sdm_focal_sel <- sdm_focal %>%\n  select(!c(\"taxon_group\", \"prov_status\", \"fed_status\", \"IUCN_status\", \"weights\"))\n# Merge\nbowen_sdm_status <- merge(bowen_sdm_focal_sel, sdm_googlesheet, by.x = \"species\", by.y = \"sci_name\", all.x = T) %>%\n  rename(weight = weights,\n         name = species) %>%\n  mutate(filename = as.character(filepath),\n         path = here(sdm_output_dir, filename),\n         category = taxon_group,\n         source = \"Viorel Popescu (2020), modified by Jay Matsushiba (2025)\") %>%\n  select(!filepath) %>%\n  relocate(path, filename, name, weight, category, source, notes)\n\n# Save to CSV\nwrite.csv(bowen_sdm_status, here(sdm_output_dir, paste0(Sys.Date(),\"_sdm.csv\")))\n# Save to Google Sheets, will be read in for Zonation\nsdm_url <- \"https://docs.google.com/spreadsheets/d/1IGFwkr9LidcZwbzOJJGSEXLsmpKp0a9gBs65EY-H1xw/edit?usp=sharing\"\nwrite_sheet(\n  bowen_sdm_status,\n  sdm_url,\n  sheet = as.character(Sys.Date())\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n✔ Writing to \"sdm\".\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n✔ Writing to sheet '2025-05-05'.\n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}