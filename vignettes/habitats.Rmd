---
title: "habitats"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{habitats}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(bowen.biodiversity.webapp)
library(here)
library(sf)
library(tidyverse)
library(terra)
library(leaflet)

# Load Bowen Island Mask Created Previously
bowen_island_mask <- here("inst/extdata/bowen_mask.tif") %>%
  rast() %>%
  project(project_crs)

# Rasterize to Bowen Island Mask 
bowen_rasterize <- function(sf) {
  output <- sf %>% 
    terra::vect() %>% # Change to SpatVector for rasterization
    terra::project(project_crs) %>% # Reproject to the mask CRS
    terra::rasterize(bowen_island_mask,
                     touches = T,
                     background = NA) # Rasterize to match mask, set background values to NA
}
```

# Introduction

Prepare habitat layers for input into Zonation. Previously, for the Feb 1 2025 workshop, we used the Sensitive Ecosystem Inventory from Metro Vancouver. These habitat types were originally represented as polygon areas, which was converted to raster.

```{r}
#### Metro Vancouver Sensitive Ecosystems Inventory ####
# Contents of "data-raw/metrovancouver_sensitive_ecosystem_inventory/" downloaded from MetroVancouver Open Data Catalogue
# GeoPackage download: https://arcg.is/TnfXL 
# Reports download: https://metrovancouver.org/services/regional-planning/sensitive-ecosystem-inventory-mapping-app
mvsei <- st_read(here("data-raw/metrovancouver_sensitive_ecosystem_inventory/Sensitive_Ecosystem_Inventory_for_Metro_Vancouver__2020__-5580727563910851507.gpkg")) %>%
  st_transform(crs = bowen.biodiversity.webapp::project_crs)
# Bowen Island SEI 
bowen_sei <- mvsei %>% 
  st_intersection(st_as_sf(bowen.biodiversity.webapp::bowen_boundary)) 
```

## Wetlands

There were some areas identified as potentially incorrect during the Feb 1 2025 workshop. We followed up with Alan Whitehead and John Dowler via email for additional details. See issue here: <https://github.com/Palen-Lab/bowen.biodiversity.webapp/issues/23>

Alan Whitehead provided ponds and wetlands shapefiles, that he had created over the years as an environmental consultant on Bowen Island. 

In the first Zonation run, we combined WN for both SECl_1 and SECl_2. This overestimated wetland extent, since this included areas that were more likely to have another habitat quality based off of MV methodology (which was mostly based on aerial surveys). We also pulled out the "Shallow Water" subcategory into its seperate layer. 

For this next Zonation run, we will use the wetlands layer provided by Alan Whitehead. This layer seemed to be more complete with ground-truthing of the location of these wetlands, in comparison to the SEI layers from MetroVancouver that were verified using aerial imagery. "Shallow Water" is no longer a separate habitat type, since Alan Whitehead's layers do not provide this classification. 
```{r}
# Alan Whitehead's Wetland Layer
wetlands_aw <- bowen.biodiversity.webapp::bowen_wetlands_whitehead_consultants
# Bowen SEI SECl_1 
bowen_sei_wn_1 <- bowen_sei %>%
  filter(SECl_1 == "WN")
# Bowen SEI SECl_2
bowen_sei_wn_2 <- bowen_sei %>%
  filter(SECl_2 == "WN")

wetlands_aw_rast <- bowen_rasterize(wetlands_aw)
bowen_sei_wn_1_rast <- bowen_rasterize(bowen_sei_wn_1)
bowen_sei_wn_2_rast <- bowen_rasterize(bowen_sei_wn_2)

# Compare wetlands 
leaflet(width = "100%", height = "800px") %>%
  addProviderTiles(provider = providers$Stadia.AlidadeSmooth) %>%
  addRasterImage(x = wetlands_aw_rast, group = "A. Whitehead Wetlands", colors = "green") %>%
  addPolygons(data = st_transform(wetlands_aw, 4326), group = "A. Whitehead Wetlands", color = "darkgreen") %>%
  addRasterImage(x = bowen_sei_wn_1_rast, group = "Bowen SEI SECl_1 Wetlands", colors = "blue") %>%
  addPolygons(data = st_transform(bowen_sei_wn_1, 4326), group = "Bowen SEI SECl_1 Wetlands", color = "darkblue") %>%
  addRasterImage(x = bowen_sei_wn_2_rast, group = "Bowen SEI SECl_2 Wetlands", colors = "orange") %>%
  addPolygons(data = st_transform(bowen_sei_wn_2, 4326), group = "Bowen SEI SECl_2 Wetlands", color = "darkorange") %>%
  addLayersControl(overlayGroups = c("A. Whitehead Wetlands", 
                                     "Bowen SEI SECl_1 Wetlands", 
                                     "Bowen SEI SECl_2 Wetlands"
  ),
  options = layersControlOptions(collapsed = F)) 
```

## Freshwater
The initial Feb1 Zonation run used the SEI categories to represent freshwater ecosystems. Each subcategory of freshwater was used as a distinct layer in the Zonation run. We have since acquired some new layers, which we can simply convert to raster and include as a conservation value input to start. 
```{r}
#### Ponds ####
# Create Ponds Layer from Alan Whitehead's Map and SEI Freshwaster Ponds
ponds_aw <- bowen.biodiversity.webapp::bowen_ponds_whitehead_consultants
ponds_aw
# Source for ponds is Islands Trust TEM
bowen_sei_fw_pd <- bowen_sei %>%
  filter(SEsubcl_1 == "pd" | SEsubcl_2 == "pd") %>%
  st_transform(st_crs(ponds_aw))
# Merge ponds 
ponds_aw_rast <- bowen_rasterize(ponds_aw)
bowen_sei_fw_pd_rast <- bowen_rasterize(bowen_sei_fw_pd)
ponds_rast <- allNA(c(ponds_aw_rast, bowen_sei_fw_pd_rast)) %>%
  classify(matrix(c(F, 1, T, NA), ncol = 2, byrow = T))

# TODO: Only use AW ponds

#### Lakes ####
bowen_sei_fw_la_rast <- bowen_sei %>%
  filter(SEsubcl_1 == "la" | SEsubcl_2 == "la") %>%
  bowen_rasterize()

#### Fish Bearing Streams ####
# Create separate raster for each OCP class
streams_fishbearing_rast <- bowen.biodiversity.webapp::bowen_fish_whitehead_consultants %>%
  filter(OCP_CLASS == "fish-bearing") %>%
  bowen_rasterize() %>%
  classify(matrix(c(1, 3), ncol = 2, byrow = T)) # Assign value 3 
streams_tributary_rast <- bowen.biodiversity.webapp::bowen_fish_whitehead_consultants %>%
  filter(OCP_CLASS == "tributary to fish-bearing") %>%
  bowen_rasterize() %>%
  classify(matrix(c(1, 2), ncol = 2, byrow = T)) # Assign value 2
streams_nonfishbearing_rast <- bowen.biodiversity.webapp::bowen_fish_whitehead_consultants %>%
  filter(OCP_CLASS == "non-fish bearing") %>%
  bowen_rasterize() %>%
  classify(matrix(c(1, 1), ncol = 2, byrow = T)) # Assign value 1
streams_drainage_rast <- bowen.biodiversity.webapp::bowen_fish_whitehead_consultants %>%
  filter(OCP_CLASS == "drainage channel") %>% 
  bowen_rasterize() %>% 
  classify(matrix(c(1, 1), ncol = 2, byrow = T)) # Assign value 1
streams_NA_rast <- bowen.biodiversity.webapp::bowen_fish_whitehead_consultants %>%
  filter(is.na(OCP_CLASS)) %>%
  bowen_rasterize() %>%
  classify(matrix(c(1, 1), ncol = 2, byrow = T)) # Assign value 1

# Combine stream rasters together, cover in order of importance
streams_rast <- streams_NA_rast %>%
  cover(streams_drainage_rast) %>%
  cover(streams_nonfishbearing_rast) %>%
  cover(streams_tributary_rast) %>%
  cover(streams_fishbearing_rast)

#### Riparian #### 
# Combine ff (fringe) and gu (gully) riparian classes into one habitat layer
bowen_sei_ri_rast <- bowen_sei %>%
  filter(SECl_1 == "RI" | SECl_2 == "RI") %>%
  bowen_rasterize()
```
## Terrestrial Ecosystem Mapping

We originally used the Metro Vancouver SEI for the Feb 1 Zonation run, but many of the habitat types are not very specific. Ex. "Mature Forest" is a habitat category that covers much of Bowen Island, but does not provide detail of what species exist there.

We got the TEM (Terrestrial Ecosystem Mapping) layers from Jeff Matheson via email on April 6 2025. 

From my own digging through the MVSEI layers and comparing to the TEM, I think that the original 2009 version of the TEMs are included in the current MVSEI. Since then TEM has been updated (2011 and 2017), mostly with larger polygons being split into smaller and more specific areas, but these have not been incorporated into MVSEI. The most recent additions to MVSEI from the TEM are in 2016, before the most recent updates. 

```{r}
# TODO: TEM layers in forest, nonforest
# TODO: SEI layers coastal, riparian 
# TODO: AW freshwater layers 

# Bowen TEM for detailed species identity 
bowen_TEM <- st_read(here("data-raw/bowen_TEM/BM_TEM.shp")) %>%
  # Remove habitat types that are already represented or not important ecosystems
  filter(!SITE_S1_LA %in% c(
    # Freshwater  
    "Reservoir",
    "Shallow Open Water",
    "Lake",
    # Developed 
    "Gravel Pit",
    "Cultivated Field",
    "Golf Course",
    "Rural",
    "Industrial",
    "Urban/Suburban",
    # Wetlands - already represented in A.Whitehead's layers
    "Wetland swamp",
    "Wetland fenn"
    )
  )
#### Metro Vancouver SEI for Young Forest, Mature Forest, Old Forest designation ####
# OF - Old Forest
# MF - Mature Forest
# YF - Young Forest
# YS - Young Forest (Small)

bowen_SEI_forests <- bowen_sei %>%
  select(SECl_1) %>%
  filter(SECl_1 %in% c("OF", "MF", "YF", "YS")) %>%
  st_transform(st_crs(bowen_TEM))

bowen_TEM_forests <- bowen_sei %>%
  select(SECl_1) %>%
  filter(SECl_1 %in% c("OF", "MF", "YF", "YS")) %>%
  st_transform(st_crs(bowen_TEM)) %>%
  st_join(bowen_TEM, ., largest = T) # Spatial join by largest, so each TEM polygon has forest category

# Compare forest maps to check
ggplot(bowen_TEM_forests) + geom_sf(aes(fill = SECl_1))
ggplot(bowen_SEI_forests) + geom_sf(aes(fill = SECl_1))


# Metro Vancouver SEI for coastal areas - intertidal (IT), herbaceous (HB)
bowen_sei_no_tem <- bowen_sei %>%
  filter(!ProjType == "TEM" & !ProjType == "NEM") %>%
  # Remove polygons with SECl x__, because these are lost ecosystem areas 
  filter(!SECl_1 %in% c("xRI", "xWD", "xMF")) %>%
  # Remove polygons with these SEsubcl, since represented elsewhere
  # co conifer dominated
  # ff riparian fringe
  # sp swamp
  # sw shallow water
  # mx mixed confider broadleaf
  filter(!SEsubcl_1 %in% c("co", "ff", "sp", "sw", "mx")) 
```


## Exploring Habitat Rasters

```{r}
leaflet(width = "100%", height = "800px") %>%
  addProviderTiles(provider = providers$Stadia.AlidadeSmooth) %>%
  addRasterImage(x = wetlands_aw_rast, group = "A. Whitehead Wetlands", colors = "lightgreen") %>%
  addRasterImage(x = bowen_sei_wn_1_rast, group = "Bowen SEI SECl_1 Wetlands", colors = "green") %>%
  addRasterImage(x = bowen_sei_wn_2_rast, group = "Bowen SEI SECl_2 Wetlands", colors = "darkgreen") %>%
  addRasterImage(x = bowen_sei_ri_rast, group = "Bowen SEI Riparian", colors = "lightblue") %>%
  addRasterImage(x = bowen_sei_fw_la_rast, group = "Bowen SEI Freshwater Lakes", colors = "darkblue") %>%
  addRasterImage(x = ponds_rast, group = "Bowen SEI + A. Whitehead Freshwater Ponds", colors = "blue") %>%
  # addPolygons(data = bowen_sei_fw_pd, label = "Bowen SEI ponds") %>%
  # addPolygons(data = ponds_aw, label = "A. Whitehead ponds") %>%
  addRasterImage(x = streams_rast, group = "A. Whitehead Streams") %>%
  addLayersControl(overlayGroups = c("A. Whitehead Wetlands", 
                                     "Bowen SEI SECl_1 Wetlands", 
                                     "Bowen SEI SECl_2 Wetlands", 
                                     "Bowen SEI Riparian", 
                                     "Bowen SEI Freshwater Lakes", 
                                     "Bowen SEI + A. Whitehead Freshwater Ponds", 
                                     "A. Whitehead Streams"
                                     ),
                   options = layersControlOptions(collapsed = F)) 
```

