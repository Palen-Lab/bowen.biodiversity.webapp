{
  "hash": "24ea5f130c1050c53a69afbd4a78e3e6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Conservation Prioritization May 5 2025 Update\"\nauthor: \"Jay Matsushiba\"\ndate: \"2025/05/02\"\nformat:\n  html:\n    code-fold: true\n---\n\n\n\n\n\n# Bowen Island Biodiversity Prioritization - Zonation5\n\nThis Rmarkdown documents the Zonation run used for the May 5 2025 iteration for Bowen Island Biodiversity Planning.\n\n<https://github.com/zonationteam/Zonation5>\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### Palen Lab Packages ####\nlibrary(bowen.biodiversity.webapp)\n\n#### Other Packages ####\nlibrary(here)\n#> here() starts at /home/jay/Programming_Projects/bowen.biodiversity.webapp\nlibrary(dplyr)\n#> \n#> Attaching package: 'dplyr'\n#> The following objects are masked from 'package:stats':\n#> \n#>     filter, lag\n#> The following objects are masked from 'package:base':\n#> \n#>     intersect, setdiff, setequal, union\nlibrary(stringr)\nlibrary(foreach)\nlibrary(sf)\n#> Linking to GEOS 3.11.1, GDAL 3.6.4, PROJ 9.1.1; sf_use_s2() is TRUE\nlibrary(terra)\n#> terra 1.8.5\nlibrary(tidyterra)\n#> \n#> Attaching package: 'tidyterra'\n#> The following object is masked from 'package:stats':\n#> \n#>     filter\nlibrary(readxl)\nlibrary(googlesheets4)\n\nsdm_url <- \"https://docs.google.com/spreadsheets/d/1IGFwkr9LidcZwbzOJJGSEXLsmpKp0a9gBs65EY-H1xw/edit?usp=sharing\"\nhabitats_url <- \"https://docs.google.com/spreadsheets/d/1yDKw4r3tbXYivwtxbbfxc-pYSbtbj_o2ee1pwlNCOO4/edit?usp=drive_link\"\noutput_date <- \"2025-05-02\"\noutput_dir <- here(\"inst/extdata/output_zonation\", output_date)\n```\n:::\n\n\n\n\n\n## Zonation\n\n> Zonation 5 is a spatial prioritization software that can be used to identify priority areas to support conservation planning, land use planning, ecological impact avoidance and other similar tasks. The software uses spatial raster data on the distributions of individual biodiversity features (species, habitats, ecosystem services etc.) to identify which locations in a landscape are most important for retaining biodiversity. Zonation can account for local habitat quality and ecological connectivity together with costs, threats and different land tenure, thus providing a quantitative method for spatial planning that enhances the persistence of biodiversity in the long term.\n\n<https://zonationteam.github.io/Zonation5/>\n\nWe took all of the rasters prepared earlier and fed these into the Zonation 5 software. This should provide a relative ranking for locations from highest to lowest for the purposes of biodiversity conservation.\n\n**Note:** Zonation 5 is usually a standalone application. Here, I have enabled running of Zonation from R, using command line functions. This way we can adjust and automatically run Zonation, reading from data in R.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### CREATE DATAFRAME FOR INPUT LAYERS ####\n# Read from Google Sheets\nhabitats_df <- read_sheet(habitats_url, sheet = output_date)\n#> ℹ Suitable tokens found in the cache, associated with these emails:\n#> • 'hello@jmatsushiba.com'\n#> • 'palenlab@gmail.com'\n#>   Defaulting to the first email.\n#> ! Using an auto-discovered, cached token.\n#>   To suppress this message, modify your code or options to clearly consent to\n#>   the use of a cached token.\n#>   See gargle's \"Non-interactive auth\" vignette for more details:\n#>   <https://gargle.r-lib.org/articles/non-interactive-auth.html>\n#> ℹ The googlesheets4 package is using a cached token for\n#>   'hello@jmatsushiba.com'.\n#> ✔ Reading from \"habitats\".\n#> ✔ Range ''2025-05-02''.\nhabitats_df$weight <- habitats_df$weight / nrow(habitats_df)\nsdm_df <- read_sheet(sdm_url, sheet = output_date) %>%\n  select(colnames(habitats_df)) # Select common columns\n#> ✔ Reading from \"sdm\".\n#> ✔ Range ''2025-05-02''.\nsdm_df$weight <- sdm_df$weight / nrow(sdm_df)\n# Bind all input layers together\nlayers_df <- bind_rows(habitats_df, sdm_df) %>%\n  filter(weight > 0)\n\n#### UPDATE features.txt FOR ZONATION RUN ####\n# UPDATE features.txt from files available in data\nfeatures_path <- here(\"vignettes/zonation/features.txt\")\ncat('\"weight\" \"filename\"', \n    file = features_path,\n    sep = \"\\n\")\nfor(i in 1:nrow(layers_df)) {\n  next_row <- paste0(layers_df[i, \"weight\"], \" \", layers_df[i, \"path\"])\n  cat(next_row,\n      file = features_path,\n      append = TRUE,\n      sep = \"\\n\")\n}\n#### SET PARAMS FOR ZONATION RUN ####\nzonation5_location <- here(\"vignettes/zonation/zonation5\") \nzonation5_mode <- \"CAZ2\"\n# Zonation5 Setting Text File\nzonation5_settings <-  here(\"vignettes/zonation/settings.z5\")\nzonation5_settings_txt <- c(\"feature list file = features.txt\", \n                            paste0(\"analysis area mask layer = \", here(\"inst/extdata/bowen_mask.tif\"))) # Add Bowen Island Mask\nwriteLines(zonation5_settings_txt, zonation5_settings)\nzonation5_output <- here(\"vignettes/zonation/output\") \nzonation5_command <- str_glue(\n  '{zonation5_location} -a -w --mode={zonation5_mode} {zonation5_settings} {zonation5_output}',\n  zonation5_location = zonation5_location,\n  zonation5_mode = zonation5_mode,\n  zonation5_settings = zonation5_settings,\n  zonation5_output = zonation5_output\n) %>%\n  str_c()\n#### ZONATION RUN ####\nsystem(command = zonation5_command)\n\n#### Save Zonation Run #### \ndir.create(output_dir)\n#> Warning in dir.create(output_dir):\n#> '/home/jay/Programming_Projects/bowen.biodiversity.webapp/inst/extdata/output_zonation/2025-05-02'\n#> already exists\nfile.copy(list.files(here(\"vignettes/zonation/output\"), full.names = T, recursive = T),\n          output_dir,\n          recursive = T)\n#>  [1] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE\n```\n:::\n\n\n\n\n\n## Output\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### VISUALIZE OUTPUT ####\nrankmap <- here(output_dir , \"rankmap.tif\") %>% rast()\nplot(rankmap)\n```\n\n::: {.cell-output-display}\n![](output_zonation_02_05_2025_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Overlap Statistics\n\nHere we calculate the overlap of the top XX% of conservation values with these other layers:\n\n-   Protected areas\n-   Private land\n-   Human Footprint (HFP)\n-   Freshwater habitats\n    -   Lakes\n    -   Ponds\n    -   Streams\n    -   Wetlands\n    -   Riparian\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Function for converting Zonation output to boolean based on percentage (in top XX%)\nrankmap <- here(output_dir , \"rankmap.tif\") %>% rast() %>% project(project_crs)\n\n#' Only keep top or bottom cell values by quantile \n#'\n#' @param x SpatRaster \n#' @param prob Quantile between 0 and 1\n#' @param direction \"top\" or \"bottom\", for direction of keep / discard cell values\n#'\n#' @returns SpatRaster\n#' @export\nremove_by_quantile <- function(x, prob, direction = \"top\") {\n  val <- x %>%\n    values() %>%\n    quantile(probs = prob, na.rm = T)\n  min_val <- x %>%\n    values() %>%\n    min(na.rm = T)\n  max_val <- x %>%\n    values() %>%\n    max(na.rm = T)\n  if(direction == \"top\") {\n    m <- matrix(c(\n      min_val, val, NA,\n      val, max_val, 1\n    ), ncol = 3, byrow = T)\n  } else if (direction == \"bottom\") {\n    m <- matrix(c(\n      min_val, val, 1,\n      val, max_val, NA\n    ), ncol = 3, byrow = T)\n  }\n  mask_quantile <- x %>%\n    classify(m,, include.lowest = T) \n  mask_quantile * x\n}\n\n#' Provide ratio of overlap between two rasters (in terms of NA vs nonNA)\n#'  \nraster_overlap_ratio <- function(top_rast, area_rast) {\n  overlap_res <- (top_rast * area_rast)\n  top_cell_count <- top_rast %>% terra::global(fun=\"notNA\")\n  overlap_cell_count <- overlap_res %>% terra::global(fun=\"notNA\")\n  overlap_ratio <- (overlap_cell_count / top_cell_count) %>% as.numeric()\n  return(overlap_ratio)\n}\n\n# Protected Areas from JD\nbowen_protectedareas_rast <- bowen.biodiversity.webapp::bowen_protectedareas %>%\n  bowen.biodiversity.webapp::bowen_rasterize()\n\n# Private Land\nbowen_mask <- rast(here(\"inst/extdata/bowen_mask.tif\"))\nbowen_parcelmap_rast <- bowen.biodiversity.webapp::bowen_parcelmap %>%\n  st_cast(\"MULTIPOLYGON\") %>% # Need this due to MULTISURFACE - see: https://gis.stackexchange.com/questions/389814/r-st-centroid-geos-error-unknown-wkb-type-12 \n  filter(OwnerType == \"Private\") %>%\n  bowen.biodiversity.webapp::bowen_rasterize()\n\n# Freshwater Habitats \nfw_rast_paths <- c(\n  here(\"inst/extdata/habitats/lakes.tif\"),\n  here(\"inst/extdata/habitats/ponds.tif\"),\n  here(\"inst/extdata/habitats/riparian.tif\"),\n  here(\"inst/extdata/habitats/wetlands.tif\"),\n  here(\"inst/extdata/habitats/streams.tif\")\n)\nfw_rast_stack <- lapply(fw_rast_paths, rast) %>%\n  rast()\nfw_rast_dissolve <- fw_rast_stack %>% \n  sum(na.rm = T) \n\n# Human Footprint (classified)\nbowen_hfp <- here(\"inst/extdata/habitats/bowen_human_footprint_recl.tif\") %>%\n  rast()\nbowen_hfp_low <- bowen_hfp %>%\n  classify(cbind(3, NA)) %>%\n  classify(cbind(2, NA))\nbowen_hfp_med <- bowen_hfp %>%\n  classify(cbind(3, NA)) %>%\n  classify(cbind(1, NA))\nbowen_hfp_high <- bowen_hfp %>%\n  classify(cbind(2, NA)) %>%\n  classify(cbind(1, NA))\n\n# Overlap calculation \noverlap_stats <- function(top_rast) {\n  data.frame(\n    protectedareas_overlap = raster_overlap_ratio(top_rast, bowen_protectedareas_rast),\n    privatelands_overlap = raster_overlap_ratio(top_rast, bowen_parcelmap_rast),\n    freshwater_overlap = raster_overlap_ratio(top_rast, fw_rast_dissolve),\n    hfp_low_overlap = raster_overlap_ratio(top_rast, bowen_hfp_low),\n    hfp_med_overlap = raster_overlap_ratio(top_rast, bowen_hfp_med),\n    hfp_high_overlap = raster_overlap_ratio(top_rast, bowen_hfp_high)\n  )\n}\nquants <- seq(from = 0, to = 1, by = 0.1)\noverlap_results <- foreach(quant = quants, .combine = \"rbind\") %do% {\n  rankmap %>%\n    remove_by_quantile(quant) %>%\n    overlap_stats() %>%\n    mutate(\"removed_bottom_quantile\" = quant) %>%\n    relocate(\"removed_bottom_quantile\")\n}\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\n#> Warning: [*] CRS do not match\nknitr::kable(overlap_results)\n```\n\n::: {.cell-output-display}\n\n\n| removed_bottom_quantile| protectedareas_overlap| privatelands_overlap| freshwater_overlap| hfp_low_overlap| hfp_med_overlap| hfp_high_overlap|\n|-----------------------:|----------------------:|--------------------:|------------------:|---------------:|---------------:|----------------:|\n|                     0.0|              0.3388200|            0.5714814|          0.4675421|       0.0303311|       0.6191973|        0.2851859|\n|                     0.1|              0.3739470|            0.5905075|          0.4877748|       0.0289706|       0.6085885|        0.2977193|\n|                     0.2|              0.3728618|            0.6054092|          0.5020804|       0.0161812|       0.6035599|        0.3120666|\n|                     0.3|              0.3645971|            0.6203435|          0.5122853|       0.0158520|       0.5926024|        0.3180978|\n|                     0.4|              0.3879815|            0.6298921|          0.5229584|       0.0144838|       0.6024653|        0.3075501|\n|                     0.5|              0.4031065|            0.6427515|          0.5325444|       0.0096154|       0.6135355|        0.2984467|\n|                     0.6|              0.4207120|            0.6564956|          0.5496995|       0.0064725|       0.6074896|        0.2907998|\n|                     0.7|              0.4288355|            0.6598891|          0.5711645|       0.0036969|       0.5939618|        0.2865065|\n|                     0.8|              0.4362292|            0.6534196|          0.6146026|       0.0018484|       0.5517560|        0.3049908|\n|                     0.9|              0.5175601|            0.6192237|          0.6524954|       0.0018484|       0.5323475|        0.3604436|\n|                     1.0|                    NaN|                  NaN|                NaN|             NaN|             NaN|              NaN|\n\n\n:::\n\n```{.r .cell-code}\n# write.csv(overlap_results, here(\"vignettes/outputs/overlap_results.csv\"))\n\n# Visualize output as maps and as table for overlap % \n```\n:::\n",
    "supporting": [
      "output_zonation_02_05_2025_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}