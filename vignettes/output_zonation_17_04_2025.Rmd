---
title: "zonation_17_04_2025"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{zonation_apr17}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Bowen Island Biodiversity Prioritization - Zonation5
This Rmarkdown documents the Zonation run used for the April 17 2025 iteration for Bowen Island Biodiversity Planning. 

<https://github.com/zonationteam/Zonation5>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(bowen.biodiversity.webapp)
sdm_url <- "https://docs.google.com/spreadsheets/d/1IGFwkr9LidcZwbzOJJGSEXLsmpKp0a9gBs65EY-H1xw/edit?usp=sharing"
habitats_url <- "https://docs.google.com/spreadsheets/d/1yDKw4r3tbXYivwtxbbfxc-pYSbtbj_o2ee1pwlNCOO4/edit?usp=drive_link"
```

## Zonation

> Zonation 5 is a spatial prioritization software that can be used to identify priority areas to support conservation planning, land use planning, ecological impact avoidance and other similar tasks. The software uses spatial raster data on the distributions of individual biodiversity features (species, habitats, ecosystem services etc.) to identify which locations in a landscape are most important for retaining biodiversity. Zonation can account for local habitat quality and ecological connectivity together with costs, threats and different land tenure, thus providing a quantitative method for spatial planning that enhances the persistence of biodiversity in the long term.

<https://zonationteam.github.io/Zonation5/>

We took all of the rasters prepared earlier and fed these into the Zonation 5 software. This should provide a relative ranking for locations from highest to lowest for the purposes of biodiversity conservation.

**Note:** Zonation 5 is usually a standalone application. Here, I have enabled running of 
Zonation from R, using command line functions. This way we can adjust and automatically
run Zonation, reading from data in R. 

```{r}
#### CREATE DATAFRAME FOR INPUT LAYERS ####
# Read from Google Sheets
habitats_df <- read_sheet(habitats_url, sheet = "2025-04-17") 
sdm_df <- read_sheet(sdm_url, sheet = "2025-04-17") %>%
  select(colnames(habitats_df)) # Select common columns
# Bind all input layers together
layers_df <- bind_rows(habitats_df, sdm_df) %>%
  filter(weight > 0)

#### UPDATE features.txt FOR ZONATION RUN ####
# UPDATE features.txt from files available in data
features_path <- here("vignettes/zonation/features.txt")
cat('"weight" "filename"', 
    file = features_path,
    sep = "\n")
for(i in 1:nrow(layers_df)) {
  next_row <- paste0(layers_df[i, "weight"], " ", layers_df[i, "path"])
  cat(next_row,
      file = features_path,
      append = TRUE,
      sep = "\n")
}
#### SET PARAMS FOR ZONATION RUN ####
zonation5_location <- here("vignettes/zonation/zonation5") 
zonation5_mode <- "CAZ2"
# Zonation5 Setting Text File
zonation5_settings <-  here("vignettes/zonation/settings.z5")
zonation5_settings_txt <- c("feature list file = features.txt", 
                            paste0("analysis area mask layer = ", here("inst/extdata/bowen_mask.tif"))) # Add Bowen Island Mask
writeLines(zonation5_settings_txt, zonation5_settings)
zonation5_output <- here("vignettes/zonation/output") 
zonation5_command <- str_glue(
  '{zonation5_location} -a -w --mode={zonation5_mode} {zonation5_settings} {zonation5_output}',
  zonation5_location = zonation5_location,
  zonation5_mode = zonation5_mode,
  zonation5_settings = zonation5_settings,
  zonation5_output = zonation5_output
) %>%
  str_c()
#### ZONATION RUN ####
system(command = zonation5_command)

#### Save Zonation Run #### 
output_dir <- here("inst/extdata/output_zonation", Sys.Date())
dir.create(output_dir)
file.copy(list.files(here("vignettes/zonation/output"), full.names = T, recursive = T),
          output_dir,
          recursive = T)
```

## Output

```{r}
#### VISUALIZE OUTPUT ####
rankmap <- here(output_dir , "rankmap.tif") %>% rast()
plot(rankmap)
```
