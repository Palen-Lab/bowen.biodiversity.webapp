---
title: "input_mask"
format: html
---

```{r}
library(terra)
library(magrittr)
library(here)

#### SPECIES DISTRIBUTION MODELS ####
# Contents of "data-raw/species_distribution_models/" downloaded from Cumulative effects - SFU Teams Sharepoint 
# https://1sfu.sharepoint.com/:f:/r/teams/Cumulativeeffects-SFUTeams9/Shared%20Documents/BCH_project_backup/SPECIES?csf=1&web=1&e=FpNkgc 
# Directory Path: BCH_project_backup/SPECIES/
# Paper: https://www.nature.com/articles/s41598-020-64501-7#MOESM1
# See Wendy Palen (SFU) for access 
#### PROCESSING SDM ####
# Get list of available SDMs
sdm_folder <- here("data-raw/species_distribution_models")
sdm_folder_tif <- list.files(sdm_folder, recursive = T, pattern = "*.tif$") # Get only .tif files
# Correspondence with Viorel Popescu confirms that _NAs_ should be SDMs with rock, ice, large lakes layers masked
sdm_folder_tif_NAs <- sdm_folder_tif[grepl("_NAs_", sdm_folder_tif)] # Get only .tif with "_NAs_" in filename

# Create Bowen Island mask using DSM
sample_sdm <- rast(here(sdm_folder, sdm_folder_tif_NAs[1])) %>%
  terra::project(y = project_crs) %>%
  terra::crop(bowen_zoning, snap = "out") %>%
  terra::disagg(fact = 4)

bowen_land <- bowen_zoning[!bowen_zoning$ZONE_CODE %in% c("WG1", "WG1(a)"),] %>% 
  vect()

dsm <- rast(here("data-raw/bowen_dsm/chm.tif"))
dsm_smooth <- dsm %>% 
  focal(w=9, fun=mean, na.policy="only", na.rm=T) %>% 
  terra::project(y = project_crs) %>%
  terra::resample(sample_sdm, method = "average") %>%
  terra::crop(bowen_land, mask = T)
m <- c(-1, 35, 1) %>% matrix(ncol = 3, byrow=T)
bowen_island_mask <- dsm_smooth %>% 
  classify(m) %>%
  as.int()
writeRaster(bowen_island_mask, here("inst/extdata/bowen_mask.tif"), overwrite = T)
```

